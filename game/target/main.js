define(["gameinit","v3d"],function(t,e){"use strict";return function(){var n,o,i,a,r=new t,c=document.getElementById("container"),d=1/60;return{init:function(){window.oncontextmenu=function(){return!1},window.addEventListener("resize",this.onWindowResize,!1),n=document.getElementById("accel");document.getElementById("accelCont"),document.getElementById("tapaccel"),document.getElementById("mobcon");o=r.getObj("v3d"),r.createWorld(d),r.populate(600),i=!1;var t=navigator.userAgent;this.isMobile=!1,t.match(/Android/i)||t.match(/webOS/i)||t.match(/iPhone/i)||t.match(/iPad/i)||t.match(/iPod/i)||t.match(/BlackBerry/i)||t.match(/Windows Phone/i)?this.loadMobileEvents(t):this.loadEvents(),o.initLight(),o.initPoints(),r.oimoLoop()},handleKeyDown:function(t){if(27===t.keyCode){var e=r.gspause()?0:1;r.gspause(e)}if(83==t.keyCode){var n=r.getObj("bodys");n[0].body.linearVelocity.init()}if(70==t.keyCode)document.body.webkitRequestFullScreen();else{var o=r.getObj("keys");o[t.which]=!0}},handleKeyUp:function(t){var e=r.getObj("keys");delete e[t.which]},handleMouseMove:function(t){if("mobcon"==t.target.id)var n=(t.pageX-mobcon.offsetLeft)/13*100,i=(t.pageY-mobcon.offsetTop)/13*100,a=n,r=i;else var c=document.getElementById("gamecanvas"),d=c.getBoundingClientRect(),n=t.clientX-d.left,i=t.clientY-d.top,a=t.clientX,r=t.clientY;e.msePos.set(n/o.w*2-1,2*-(i/o.h)+1,.5);var s=o.w/100*5,u=o.h/100*5,l=o.w-s,h=s,m=o.h-u,g=u;a>l?r>o.h/2?o.startRot={rot:"dr"}:o.startRot={rot:"ur"}:a<h?r>o.h/2?o.startRot={rot:"dl"}:o.startRot={rot:"ul"}:r>m?a>o.w/2?o.startRot={rot:"dr"}:o.startRot={rot:"dl"}:r<g?a>o.w/2?o.startRot={rot:"ur"}:o.startRot={rot:"ul"}:o.startRot={rot:0}},loadEvents:function(){window.addEventListener("keydown",this.handleKeyDown,!1),window.addEventListener("keyup",this.handleKeyUp,!1),window.scrollTo(0,document.body.clientHeight),c.addEventListener("mousemove",this.handleMouseMove,!1)},loadMobileEvents:function(t){function n(){event.preventDefault();for(var t=0;t<event.changedTouches.length;t++)"addforce"!=event.changedTouches[t].target.id&&"addforcebut"!=event.changedTouches[t].target.id||(u[38]=1),"minusforce"!=event.changedTouches[t].target.id&&"minusforcebut"!=event.changedTouches[t].target.id||(u[40]=1)}function d(){event.preventDefault();for(var t=0;t<event.changedTouches.length;t++)"addforce"!=event.changedTouches[t].target.id&&"addforcebut"!=event.changedTouches[t].target.id||(u[38]=0),"minusforce"!=event.changedTouches[t].target.id&&"minusforcebut"!=event.changedTouches[t].target.id||(u[40]=0),"mobcon"==event.changedTouches[t].target.id&&(mobcon.style.opacity="1")}function s(){event.preventDefault();for(var t=0;t<event.changedTouches.length;t++)"mobcon"==event.changedTouches[t].target.id&&(a.handleMouseMove(event.changedTouches[t]),mobcon.style.opacity="0.1")}a=this,mobcon.style.display="block";var u=r.getObj("keys");if(t.match(/iPhone/))if(e.bincam){var l=5;o.camdist=4.9}else{var l=.1;o.camdist=.09}if(t.match(/iPad/))if(e.bincam){var l=7;o.camdist=6.9}else{var l=.1;o.camdist=.09}o.camera.position.z=l,o.sight.position.z=l*-1,o.tmpVCPprev=new o.tvec(0,0,l);var h=document.getElementById("addforce"),m=document.getElementById("minusforce");h.style.display="block",m.style.display="block",c.addEventListener("touchstart",n,!1),c.addEventListener("touchend",d,!1),c.addEventListener("touchmove",s,!1);var g=new Hammer(c);g.add(new Hammer.Tap({event:"doubleletap",taps:2})),g.get("doubleletap").recognizeWith("tap"),g.add(new Hammer.Tap({event:"tripletap",taps:3})),g.get("tripletap").recognizeWith("tap"),g.on("tap doubleletap",function(t){if("doubleletap"==t.type&&(i?(delete u[32],i=!1):(u[32]=!0,i=!0)),"tap"==t.type&&"accelCont"==t.target.id){var e=document.body,n=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen;n.call(e)}}),g.on("tap tripletap",function(t){"tripletap"==t.type&&(i?(delete u[32],i=!1):(u[32]=!0,i=!0))}),this.loadHammerTime()},loadHammerTime:function(){var t=window.MutationObserver||window.WebKitMutationObserver,e="ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,n=void 0!==document.documentElement.style["touch-action"]||document.documentElement.style["-ms-touch-action"];if(!n&&e&&t){window.Hammer=window.Hammer||{};var o=/touch-action[:][\s]*(none)[^;'"]*/,i=/touch-action[:][\s]*(manipulation)[^;'"]*/,a=/touch-action/,r=!!navigator.userAgent.match(/(iPad|iPhone|iPod)/g),c=function(){try{var t=document.createElement("canvas");return!(!window.WebGLRenderingContext||!t.getContext("webgl")&&!t.getContext("experimental-webgl"))}catch(t){return!1}}(),d=c&&r;window.Hammer.time={getTouchAction:function(t){return this.checkStyleString(t.getAttribute("style"))},checkStyleString:function(t){return a.test(t)?o.test(t)?"none":!i.test(t)||"manipulation":void 0},shouldHammer:function(t){var e=this.hasParent(t.target);return!(!e||d&&!(Date.now()-t.target.lastStart<125))&&e},touchHandler:function(t){var e=t.target.getBoundingClientRect(),n=e.top!==this.pos.top||e.left!==this.pos.left,o=this.shouldHammer(t);("none"===o||n===!1&&"manipulation"===o)&&("touchend"===t.type&&(t.target.focus(),setTimeout(function(){t.target.click()},0)),t.preventDefault()),this.scrolled=!1,delete t.target.lastStart},touchStart:function(t){this.pos=t.target.getBoundingClientRect(),d&&this.hasParent(t.target)&&(t.target.lastStart=Date.now())},styleWatcher:function(t){t.forEach(this.styleUpdater,this)},styleUpdater:function(t){if(t.target.updateNext)return void(t.target.updateNext=!1);var e=this.getTouchAction(t.target);return e?void("none"!==e&&(t.target.hadTouchNone=!1)):void(!e&&(t.oldValue&&this.checkStyleString(t.oldValue)||t.target.hadTouchNone)&&(t.target.hadTouchNone=!0,t.target.updateNext=!1,t.target.setAttribute("style",t.target.getAttribute("style")+" touch-action: none;")))},hasParent:function(t){for(var e,n=t;n&&n.parentNode;n=n.parentNode)if(e=this.getTouchAction(n))return e;return!1},installStartEvents:function(){document.addEventListener("touchstart",this.touchStart.bind(this)),document.addEventListener("mousedown",this.touchStart.bind(this))},installEndEvents:function(){document.addEventListener("touchend",this.touchHandler.bind(this),!0),document.addEventListener("mouseup",this.touchHandler.bind(this),!0)},installObserver:function(){this.observer=new t(this.styleWatcher.bind(this)).observe(document,{subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["style"]})},install:function(){this.installEndEvents(),this.installStartEvents(),this.installObserver()}},window.Hammer.time.install()}},onWindowResize:function(){o.camera.aspect=window.innerWidth/window.innerHeight,o.camera.updateProjectionMatrix(),o.renderer.setSize(window.innerWidth,window.innerHeight)}}}});