define(["game/oimo","game/v3d"],function(e,o){function i(){if(!l){g.step();for(var e,o,i=P.length;i--;)if(o=P[i],e=p[i],!o.getSleep()){if(e.position.copy(o.getPosition()),e.quaternion.copy(o.getQuaternion()),"sph1"==o.name){b.copy(x.position),x.position.copy(o.getPosition());var n=x.position.x-b.x,t=x.position.y-b.y;w.position.x+=n,w.position.y+=t,w.position.z=x.position.z-500,h.camera.position.x=x.position.x,h.camera.position.y=x.position.y,h.camera.position.z=x.position.z+100}"sbox"===e.material.name&&(e.material=h.mats.box),"ssph"===e.material.name&&(e.material=h.mats.sph)}}}function n(o){var i;u=new e.Performance(g);var n,r,s,l,m,y,d;n=500,s=-1500,r=100,l=60,m=60,y=60;var v=[{size:[7.5,7.5,7.5],pos:[0,1,0],move:"true",name:"sph1",color:"#66ff33",image:"shp1.jpg"},{size:[12,12,12],pos:[0,0,-500],move:"true",name:"sight",color:"#ff00ff"},{size:[.1,.1,.1],pos:[0,1,0],move:"true",name:"containerSphere",color:""},{size:[500,500,500],pos:[500,10,-5e3],move:"true",name:"planet",color:"#0000ff",image:"planet_1.png"}];t(v);for(var f=0;f<1;f++){var d=2;2===d&&(i={type:"box",size:[l,m,y],pos:[n,r,s],move:!0,world:g,name:"box1"}),3===d&&(i={type:"cylinder",size:[l,m,l,l,m,l,l,m,l,l,m,l],pos:[n,r,s],rot:[0,0,0,0,45,0,0,22.5,0,0,-22.5,0],move:!0,world:g}),P[S]=new e.Body(i),p[c]=h.add(i),S+=1,c+=1,n=a(-1e3,1e3),r=a(-1e3,1e3),s=a(200,-500)}}function t(o){var i;for(var n in o){var t={type:"sphere",size:o[n].size,pos:o[n].pos,move:o[n].move,world:g,name:o[n].name,color:o[n].color,image:o[n].image};if("containerSphere"!=t.name&&"sight"!=t.name&&(P[S]=new e.Body(t),p[c]=h.add(t,i,t.color,t.image),"planet"==t.name&&(z=p[c]),S+=1,c+=1,"shoot"==t.name))return P[S-1];"containerSphere"==t.name&&(x=h.add(t,i,t.color)),"sight"==t.name&&(w=h.add(t,i,t.color))}}function a(e,o){return Math.floor(Math.random()*(o-e+1))+e}function r(e){switch(e.preventDefault(),e.stopPropagation(),e.keyCode){case f.UP:console.log("up key pressed");var o=h.getPlayerDir("forward",x,w);o.x*=50,o.y*=50,o.z*=50;var i=P[0].body;i.linearVelocity.addTime(o,g.timeStep),console.log("heading x: "+i.linearVelocity.x+" heading y: "+i.linearVelocity.y+"heading z: "+i.linearVelocity.z);break;case f.BOTTOM:var o=h.getPlayerDir("reverse",x,w);o.x*=50,o.y*=50,o.z*=50;var i=P[0].body;i.linearVelocity.addTime(o,g.timeStep),console.log("heading x: "+i.linearVelocity.x+" heading y: "+i.linearVelocity.y+"heading z: "+i.linearVelocity.z);break;case f.RIGHT:break;case f.SPC:var o=h.getPlayerDir("forward",x,w);o.x*=500,o.y*=500,o.z*=500;var n=x.position,a=[{size:[1.5,1.5,1.5],pos:[n.x,n.y,n.z-1],move:"true",name:"shoot",color:"#66ff33"}],r=t(a);r.body.linearVelocity.addTime(o,g.timeStep);break;case f.ECS:l=1===l?0:1}}function s(e,o){var i=e.getBoundingClientRect();return{x:o.clientX-i.left,y:o.clientY-i.top}}var p=[],c=0,l=0,m=1/60,y=2,d=8,v=!1,g=new e.World(m,y,d,v);g.gravity=new e.Vec3(0,0,0);var f=(new e.Vec3(0,0,0),{LEFT:37,UP:38,RIGHT:39,BOTTOM:40,ECS:27,SPC:32});g.worldscale(100);var h=new o.View;h.initLight();var u,x,w,z,V,b,P=[],S=0,T=(new h.getVec3(0,0,100),new h.getVec3(0,0,-500),new h.getVec3(0,1,0),h.w/2),k=h.h/2,B=.73;b=new e.Vec3(0,0,0),n(1);var C=function(){requestAnimationFrame(C),l||h.render()};setInterval(i,1e3*m),C(),window.addEventListener("keydown",r,!1),window.scrollTo(0,document.body.clientHeight);var E=document.getElementById("container");E.addEventListener("mousemove",function(e){V=s(E,e),V.x>T&&(w.position.x=(V.x-T)/B+x.position.x),V.x<T&&(w.position.x=(T-V.x)/-B+x.position.x),V.y<k&&(w.position.y=(V.y-k)/-B+x.position.y),V.y>k&&(w.position.y=(k-V.y)/B+x.position.y),w.position.z=x.position.z-500},!1)});