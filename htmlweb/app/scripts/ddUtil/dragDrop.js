define(["ddUtil/createDragDropElement"],function(e){function t(t){var r=document.getElementById(t).value;r=JSON.parse(r);for(var d,i=0;i<r.length;i++){d=r[i].mapID;var o="e_"+d,n="container_"+d,p="label_"+d,s=r[i].isNew,c=r[i].labelReplacedBy;if(r[i].x!==-1&&r[i].y!==-1&&r[i].e_x!==-1&&r[i].e_y!==-1){var v=r[i].x,f=r[i].y;$("#dragDropList").append('<div id="'+n+'" class="e_container"></div>'),s?($("#dragDropList").append('<div id="'+n+'" class="e_container"></div>'),$("#dropWrapper").append('<div id="'+o+'" class="dragDropLabelRed">'+r[i].labelName+"</div>")):($("#dragDropList").append('<div id="'+n+'" class="e_container"></div>'),$("#dropWrapper").append('<div id="'+o+'" class="dragDropLabelBlack">'+r[i].labelName+"</div>")),$("#"+o).css({left:v,top:f,position:"absolute"})}else s?$("#dragDropList").append('<div id="'+n+'" class="e_container"><div id="'+o+'" class="dragDropLabelRed">'+r[i].labelName+"</div></div>"):$("#dragDropList").append('<div id="'+n+'" class="e_container"><div id="'+o+'" class="dragDropLabelBlack"><div>'+r[i].labelName+'</div><div class="labelReplacedBy">'+c+"</div></div>");l[i]=new e,l[i].init(o,r[i],p,n,s,c,l);var g=$(".dragDropLabel").width(),m=$(".dragDropLabel").height();if(r[i].x!==-1&&r[i].y!==-1&&r[i].e_x!==-1&&r[i].e_y!==-1){var b="<div>"+r[i].labelName+'</div><div class="labelReplacedBy">'+c+"</div>";a(l[i],d,b,r[i].x,r[i].y,r[i].e_x,r[i].e_y,g,m)}l[i].setDragEl=l}var D=(document.getElementById("dropWrapper"),document.getElementsByClassName("dragDropLabel"),document.getElementById("resetItem"));document.addEventListener("click",function(e){$(".rightClickMenu").css("display","none");for(var t=0;t<l.length;t++)l[t].setReset&&(l[t].setReset=!1)},!1),D.addEventListener("click",function(e){for(var t=0;t<l.length;t++)l[t].setReset&&l[t].resetLabel()},!1)}function a(t,a,d,i,o,n,p,s,c){t.setDroppedBool(!0);var v=($("#dropWrapper").offset(),"label_"+a);t.isNew?($("#e_"+a).removeClass("dragDropLabelRed").addClass("dragDropDotRed").text(""),$("#dropWrapper").append('<div id="'+v+'" class="dragDropLabelRed">'+d+"</div>")):($("#e_"+a).removeClass("dragDropLabelBlack").addClass("dragDropDotBlack").text(""),$("#dropWrapper").append('<div id="'+v+'" class="dragDropLabelBlack">'+d+"</div>"));var f=new e;f.init("","",v,""),$("#"+v).css({left:n,top:p,position:"absolute"}),document.getElementById(v).addEventListener("contextmenu",function(e){e.preventDefault(),$(".rightClickMenu").css({display:"block",left:e.clientX,top:e.clientY});var t=this.id.split("_");t=t[1],t="e_"+t;for(var a=0;a<l.length;a++)l[a].e_id==t?l[a].setReset=!0:l[a].setReset=!1},!1),r(a,t.isNew,!1),$("#label_"+a).draggable("option","containment","#dropWrapper"),$("#e_"+a).draggable("option","containment","#dropWrapper"),f.setDragEl(l)}function r(e,t,a){if(!a)if(t)var r="lineStyleRed";else var r="lineStyleBlack";var l=1,d=$("#e_"+e).position(),i=$("#label_"+e).position(),o=d.left,n=d.top,p=i.left,s=i.top,c=Math.sqrt((p-o)*(p-o)+(s-n)*(s-n)),v=(o+p)/2-c/2,f=(n+s)/2-l/2,g=Math.atan2(n-s,o-p)*(180/Math.PI);if(a)$("#lineDiv"+e).css({left:v+"px",top:f+"px",width:c+"px",transform:"rotate("+g+"deg)"});else{var m='<div id="lineDiv'+e+'" class="'+r+'" style="left:'+v+"px; top:"+f+"px; width:"+c+"px; -moz-transform:rotate("+g+"deg); -webkit-transform:rotate("+g+"deg); -o-transform:rotate("+g+"deg); -ms-transform:rotate("+g+"deg); transform:rotate("+g+'deg);" />';$("#dropWrapper").append(m)}}var l=[];t("jsonInput"),$("#dropWrapper").droppable({tolerance:"fit",drop:function(e,t){var r=$("#dropWrapper"),d=$(t.draggable).width(),i=$(t.draggable).height(),o=r.offset(),n=$(t.draggable).html(),p=$(t.draggable).attr("id"),s=p.split("_");s=s[1];for(var c="e_"+s,v=document.getElementById("label_"+s),f=0;f<l.length;f++)if(l[f].e_id==c)var g=l[f];if("dropWrapper"!=$("#"+c).parent().attr("id")&&($("#"+c).remove(),$("#dropWrapper").append('<div id="'+c+'"></div>'),$("#"+c).css({left:e.clientX-o.left,top:e.clientY-o.top}),g.makeDraggable(l)),e.clientX>r.width()+o.left-d)var m=!0;if(e.clientY<o.top+i)var b=!0;if(e.clientY>r.height()+o.top-80)var D=!0;if(m&&b)var u=e.clientX-o.left-45,_=e.clientY-o.top+40;else if(m&&!b)var u=e.clientX-o.left-45,_=e.clientY-o.top+40;else if(!m&&b)var u=e.clientX-o.left+20,_=e.clientY-o.top+40;else var u=e.clientX-o.left+20,_=e.clientY-o.top+40;if(D)var _=e.clientY-o.top-80;v||a(g,s,n,"","",u,_,d,i);var y=$("#"+c).offset(),h=$("#label_"+s).offset(),L=$("#dropWrapper").offset(),x={x:y.left-L.left,y:y.top-L.top},B={x:h.left-L.left,y:h.top-L.top};g.setPositions(x,B);for(var f=0;f<l.length;f++)(l[f].elXYpos.x>-1||l[f].elXYpos.y>-1)&&(document.getElementById("el"+f).innerHTML=Math.round(l[f].elXYpos.x)+"x , "+Math.round(l[f].elXYpos.y)+"y")}}),document.getElementById("submitJson").addEventListener("click",function(){console.log("json sent")})});