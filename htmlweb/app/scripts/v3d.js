define(["three"],function(a){"use strict";var a,b={};return b.ToRad=Math.PI/180,b.ToDeg=180/Math.PI,b.View=function(a,b,c){var d=navigator.userAgent;this.isMobile=!1,(d.match(/Android/i)||d.match(/webOS/i)||d.match(/iPhone/i)||d.match(/iPad/i)||d.match(/iPod/i)||d.match(/BlackBerry/i)||d.match(/Windows Phone/i))&&(this.isMobile=!0);var e=document.getElementById("container");e.style.width="100%",e.style.height="500px",this.w=e.clientWidth,this.h=e.clientHeight,this.id="container",this.init(a,b,c),this.initBasic()},b.View.prototype={constructor:b.View,init:function(b,c,d){this.clock=new a.Clock,this.renderer=new a.WebGLRenderer({precision:"mediump",antialias:!1}),this.renderer.setSize(this.w,this.h),this.renderer.setClearColor(1908512,1),this.camera=new a.PerspectiveCamera(60,this.w/this.h,.1,1e4),this.camera.useQuarternion=!0,this.camera.position.z=100,this.camera.position.y=1,this.scene=new a.Scene,this.scene.background=new a.Color(0),this.container=document.getElementById(this.id),this.container.appendChild(this.renderer.domElement),this.miniMap=null,this.player=null,this.raycaster=new a.Raycaster(this.camera.position,[0,1,0],1,100)},initBackground:function(){var c=new a.BufferGeometry;c.fromGeometry(new a.IcosahedronGeometry(1e3,1));var d=new a.Mesh(c,new a.MeshBasicMaterial({map:this.gradTexture([[.75,.6,.4,.25],["#1B1D1E","#3D4143","#72797D","#b0babf"]]),side:a.BackSide,depthWrite:!1,fog:!1}));d.geometry.applyMatrix((new a.Matrix4).makeRotationZ(15*b.ToRad)),this.scene.add(d),this.renderer.autoClear=!1},initLight:function(){if(!this.isMobile){var b=new a.HemisphereLight(16777215,3158064,.3);this.scene.add(b);var c=new a.DirectionalLight(16777215,1.2);c.position.set(.5,1,.5).normalize(),this.scene.add(c)}},initLightShadow:function(){if(!this.isMobile){this.scene.add(new a.AmbientLight(6316128));var b=new a.DirectionalLight(16777215,1);b.position.set(300,1e3,500),b.target.position.set(0,0,0),b.castShadow=!0,b.shadowCameraNear=500,b.shadowCameraFar=1600,b.shadowCameraFov=70,b.shadowBias=1e-4,b.shadowDarkness=.7,b.shadowMapWidth=b.shadowMapHeight=1024,this.scene.add(b)}},initBasic:function(){var c={};c.sph=new a.BufferGeometry,c.box=new a.BufferGeometry,c.cyl=new a.BufferGeometry,c.sph.fromGeometry(new a.SphereGeometry(1,12,10)),c.cyl.fromGeometry(new a.CylinderGeometry(.5,.5,1,12,1)),c.box.fromGeometry(new a.BoxGeometry(1,1,1)),c.plane=new a.PlaneBufferGeometry(1,1,100,100),c.plane.applyMatrix((new a.Matrix4).makeRotationX(-90*b.ToRad));var d={};d.ssph=new a.MeshLambertMaterial({map:this.basicTexture(1),name:"ssph"}),d.box=new a.MeshLambertMaterial({color:6750003,wireframe:!0,name:"box"}),d.sbox=new a.MeshLambertMaterial({map:this.basicTexture(3),name:"sbox"}),d.cyl=new a.MeshLambertMaterial({map:this.basicTexture(5),name:"cyl"}),d.scyl=new a.MeshLambertMaterial({map:this.basicTexture(6),name:"scyl"}),d.static=new a.MeshLambertMaterial({map:this.basicTexture(4),name:"static"}),d.static2=new a.MeshLambertMaterial({color:16711680,wireframe:!0,name:"static2"}),d.joint=new a.LineBasicMaterial({color:65280}),this.mats=d,this.geos=c},render:function(){this.renderer.render(this.scene,this.camera)},setMesh:function(b){var c={};return c.sph=new a.MeshLambertMaterial({color:b,wireframe:!0,name:"sph"})},add:function(c,d,e,f){var g=c.type||"box",h=c.size||[10,10,10],i=c.pos||[0,0,0],j=c.rot||[0,0,0],k=c.move||!1,l=c.name||"";if(c.flat&&(g="plane",i[1]+=.5*h[1]),"joint"===g.substring(0,5)){var m,n=c.pos1||[0,0,0],o=c.pos2||[0,0,0],p=new a.Geometry;return p.vertices.push(new a.Vector3(n[0],n[1],n[2])),p.vertices.push(new a.Vector3(o[0],o[1],o[2])),m=new a.Line(p,this.mats.joint,a.LinePieces),d?d.add(q):this.scene.add(m),m}var q;if(e&&(this.mats.sph=this.setMesh(e)),"sph1.jpg"==f){var r=(new a.TextureLoader).load("images/shp1.jpg");this.mats.sph=new a.MeshBasicMaterial({map:r})}if("planet_1.png"==f){var r=(new a.TextureLoader).load("images/planet_1.png");this.mats.sph=new a.MeshBasicMaterial({map:r})}return"box"==g&&k&&(q=new a.Mesh(this.geos.box,this.mats.box,l)),"box"!=g||k||(q=new a.Mesh(this.geos.box,this.mats.static,l)),"plane"!=g||k||(q=new a.Mesh(this.geos.plane,this.mats.static2,l)),"sphere"==g&&k&&(q=new a.Mesh(this.geos.sph,this.mats.sph,l)),"sphere"!=g||k||(q=new a.Mesh(this.geos.sph,this.mats.static,l)),"cylinder"==g&&k&&(q=new a.Mesh(this.geos.cyl,this.mats.cyl,l)),"cylinder"!=g||k||(q=new a.Mesh(this.geos.cyl,this.mats.static,l)),q.scale.set(h[0],h[1],h[2]),q.position.set(i[0],i[1],i[2]),q.rotation.set(j[0]*b.ToRad,j[1]*b.ToRad,j[2]*b.ToRad),d?d.add(q):this.scene.add(q),q},moveLink:function(a,b,c){a.geometry.vertices[0].copy(b),a.geometry.vertices[1].copy(c),a.geometry.verticesNeedUpdate=!0},initKeyboard:function(){this.nav.bindKeys()},customShader:function(b){var c=new a.ShaderMaterial({uniforms:b.uniforms,attributes:b.attributes,vertexShader:b.vs,fragmentShader:b.fs});return c},gradTexture:function(b){var c=document.createElement("canvas"),d=c.getContext("2d");c.width=16,c.height=128;for(var e=d.createLinearGradient(0,0,0,128),f=b[0].length;f--;)e.addColorStop(b[0][f],b[1][f]);d.fillStyle=e,d.fillRect(0,0,16,128);var g=new a.Texture(c);return g.needsUpdate=!0,g},basicTexture:function(b,c){var d=document.createElement("canvas");d.width=d.height=64;var f,e=d.getContext("2d");0===b&&(f="#58C3FF"),1===b&&(f="#3580AA"),2===b&&(f="#FFAA58"),3===b&&(f="#AA8038"),4===b&&(f="#1d1f20"),5===b&&(f="#58FFAA"),6===b&&(f="#38AA80"),e.fillStyle=f,e.fillRect(0,0,64,64),e.fillStyle="rgba(0,0,0,0.1);",e.fillRect(0,0,32,32),e.fillRect(32,32,32,32);var g=new a.Texture(d);return g.wrapS=g.wrapT=a.RepeatWrapping,g.repeat=new a.Vector2(c||1,c||1),g.needsUpdate=!0,g},getPlayerDir:function(b,c,d){var e=c.position,f=d.position,g=new a.Vector3;return g="forward"==b?g.subVectors(f,e):g.subVectors(e,f),g.normalize()},getVec3:function(b,c,d){var e=new a.Vector3(b,c,d);return e}},b});