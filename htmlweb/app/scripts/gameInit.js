"use strict";define(["oimo","v3d"],function(a,b){function F(){if(!e){j.step();for(var f,g,h=n.length;h--;)if(g=n[h],f=c[h],!g.getSleep()){if(f.position.copy(g.getPosition()),f.quaternion.copy(g.getQuaternion()),"sph1"==g.name){D.copy(q.position),q.position.copy(g.getPosition());var i=q.position.x-D.x,k=q.position.y-D.y;r.position.x+=i,r.position.y+=k,r.position.z=q.position.z-500,m.camera.position.x=q.position.x,m.camera.position.y=q.position.y,m.camera.position.z=q.position.z+100}"sbox"===f.material.name&&(f.material=m.mats.box),"ssph"===f.material.name&&(f.material=m.mats.sph)}G()}}function G(){s.rotation.y+=.01;var a=(r.position.x-q.position.x)*C,c=((r.position.x-q.position.x)*C+m.w/2,m.w-m.w/100*3);m.w/100*3;if(a>c/2&&m.camera.rotation.y<=1.5708){var e=new m.getVec3;e.copy(w);var f=e.length();e.normalize(),e.applyAxisAngle(y,v),e.multiplyScalar(f),e.x-=w.x,e.z-=w.z,w.x+=e.x,w.z+=e.z,m.camera.position.x+=e.x,m.camera.position.z+=e.z,m.camera.lookAt(q.position);var g=m.getVec3();g.copy(q.position),g.x+=e.x,g.z+=e.z,m.camera.position.x+=g.x,m.camera.position.z+=g.z,console.log("camera "+m.camera.position.x+", "+m.camera.position.z)}}function H(b){var e;p=new a.Performance(j);var f,g,h,i,k,l,q;f=500,h=-1500,g=100,i=.5,k=.5,l=.5;var r=[{size:[7.5,7.5,7.5],pos:[0,1,0],move:"true",name:"sph1",color:"#66ff33",image:"sph1.jpg"},{size:[2,2,2],pos:[0,0,-500],move:"true",name:"sight",color:"#ff00ff"},{size:[.1,.1,.1],pos:[0,1,0],move:"true",name:"containerSphere",color:""},{size:[500,500,500],pos:[500,10,-5e3],move:"true",name:"planet",color:"#0000ff",image:"planet_1.png"}];I(r);for(var s=0;s<1e4;s++){var q=2;2===q&&(e={type:"box",size:[i,k,l],pos:[f,g,h],move:!0,world:j,name:"box1"}),3===q&&(e={type:"cylinder",size:[i,k,i,i,k,i,i,k,i,i,k,i],pos:[f,g,h],rot:[0,0,0,0,45,0,0,22.5,0,0,-22.5,0],move:!0,world:j}),n[o]=new a.Body(e),c[d]=m.add(e),o+=1,d+=1,f=J(-1e3,1e3),g=J(-1e3,1e3),h=J(200,-500)}}function I(b){var e;for(var f in b){var g={type:"sphere",size:b[f].size,pos:b[f].pos,move:b[f].move,world:j,name:b[f].name,color:b[f].color,image:b[f].image};if("containerSphere"!=g.name&&"sight"!=g.name&&(n[o]=new a.Body(g),c[d]=m.add(g,e,g.color,g.image),"planet"==g.name&&(s=c[d]),o+=1,d+=1,"shoot"==g.name))return n[o-1];"containerSphere"==g.name&&(q=m.add(g,e,g.color)),"sight"==g.name&&(r=m.add(g,e,g.color))}}function J(a,b){return Math.floor(Math.random()*(b-a+1))+a}function K(a){switch(a.preventDefault(),a.stopPropagation(),a.keyCode){case l.UP:console.log("up key pressed");var b=m.getPlayerDir("forward",q,r);b.x*=50,b.y*=50,b.z*=50;var c=n[0].body;c.linearVelocity.addTime(b,j.timeStep),console.log("heading x: "+c.linearVelocity.x+" heading y: "+c.linearVelocity.y+"heading z: "+c.linearVelocity.z);break;case l.BOTTOM:var b=m.getPlayerDir("reverse",q,r);b.x*=50,b.y*=50,b.z*=50;var c=n[0].body;c.linearVelocity.addTime(b,j.timeStep),console.log("heading x: "+c.linearVelocity.x+" heading y: "+c.linearVelocity.y+"heading z: "+c.linearVelocity.z);break;case l.RIGHT:break;case l.SPC:var b=m.getPlayerDir("forward",q,r);b.x*=500,b.y*=500,b.z*=500;var d=q.position,f=[{size:[1.5,1.5,1.5],pos:[d.x,d.y,d.z-1],move:"true",name:"shoot",color:"#66ff33"}],g=I(f);g.body.linearVelocity.addTime(b,j.timeStep);break;case l.ECS:e=1===e?0:1}}function M(a,b){var c=a.getBoundingClientRect();return{x:b.clientX-c.left,y:b.clientY-c.top}}var c=[],d=0,e=0,f=1/60,g=2,h=8,i=!1,j=new a.World(f,g,h,i);j.gravity=new a.Vec3(0,0,0);var l=(new a.Vec3(0,0,0),{LEFT:37,UP:38,RIGHT:39,BOTTOM:40,ECS:27,SPC:32});j.worldscale(100);var m=new b.View;m.initLight();var p,q,r,s,z,D,n=[],o=0,v=.01,w=new m.getVec3(0,0,100),y=(new m.getVec3(0,0,-500),new m.getVec3(0,1,0)),A=m.w/2,B=m.h/2,C=.73;D=new a.Vec3(0,0,0),H(1);var E=function(){requestAnimationFrame(E),e||m.render()};setInterval(F,1e3*f),E(),window.addEventListener("keydown",K,!1),window.scrollTo(0,document.body.clientHeight);var N=document.getElementById("container");N.addEventListener("mousemove",function(a){z=M(N,a),z.x>A&&(r.position.x=(z.x-A)/C+q.position.x),z.x<A&&(r.position.x=(A-z.x)/-C+q.position.x),z.y<B&&(r.position.y=(z.y-B)/-C+q.position.y),z.y>B&&(r.position.y=(B-z.y)/C+q.position.y),r.position.z=q.position.z-500},!1)});