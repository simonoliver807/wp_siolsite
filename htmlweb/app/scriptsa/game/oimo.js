define([],function(){function t(t,i,s){return{a:t,b:i,c:s}}function i(t,i,s,h){var e=.5*(-s.y*h.x+i.y*(-s.x+h.x)+i.x*(s.y-h.y)+s.x*h.y),o=e<0?-1:1,a=(i.y*h.x-i.x*h.y+(h.y-i.y)*t.x+(i.x-h.x)*t.y)*o,n=(i.x*s.y-i.y*s.x+(i.y-s.y)*t.x+(s.x-i.x)*t.y)*o;return a>0&&n>0&&a+n<2*e*o}function s(t,i){return{x:t,y:i}}var h,e={REVISION:"1.2",nextID:0,proxyID:0,BR_NULL:0,BR_BRUTE_FORCE:1,BR_SWEEP_AND_PRUNE:2,BR_BOUNDING_VOLUME_TREE:3,BODY_NULL:0,BODY_DYNAMIC:1,BODY_STATIC:2,SHAPE_NULL:0,SHAPE_SPHERE:1,SHAPE_BOX:2,SHAPE_CYLINDER:3,SHAPE_TETRA:4,JOINT_NULL:0,JOINT_DISTANCE:1,JOINT_BALL_AND_SOCKET:2,JOINT_HINGE:3,JOINT_WHEEL:4,JOINT_SLIDER:5,JOINT_PRISMATIC:6,WORLD_SCALE:100,INV_SCALE:.01,AABB_PROX:.005,sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,lerp:function(t,i,s){return t+(i-t)*s},rand:function(t,i){return e.lerp(t,i,e.random())},randInt:function(t,i,s){return 1*e.lerp(t,i,e.random()).toFixed(s||0)},int:function(t){return~~t},fix:function(t,i){return t.toFixed(i||3,10)},clamp:function(t,i,s){return e.max(i,e.min(s,t))},degtorad:.017453292519943295,radtodeg:57.29577951308232,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,CustomError:null,Error:function(t,i){null==e.CustomError?console.error(t,i):e.CustomError.innerHTML+=t+" - "+i+"<br>"}};h||(h="undefined"!=typeof Float32Array?Float32Array:Array);try{!function(t){var i,s=["now","webkitNow","msNow","mozNow"];if(t.performance)for(var h=0;h<s.length;++h){var o=s[h];if(t.performance[o]){i=function(){return t.performance[o]()};break}}i||(i=Date.now),e.now=i}(window)}catch(t){e.now=function(){return 0}}return e.World=function(t,i,s,h){switch(this.timeStep=t||.01666,this.numIterations=s||8,i||2){case 1:this.broadPhase=new e.BruteForceBroadPhase;break;case 2:default:this.broadPhase=new e.SAPBroadPhase;break;case 3:this.broadPhase=new e.DBVTBroadPhase}this.performance=null,this.isNoStat=h||!1,this.isNoStat||(this.performance=new e.Performance(this)),this.enableRandomizer=!0,this.rigidBodies=null,this.numRigidBodies=0,this.contacts=null,this.unusedContacts=null,this.numContacts=0,this.numContactPoints=0,this.joints=null,this.numJoints=0,this.numIslands=0,this.gravity=new e.Vec3(0,-9.80665,0);var o=5;this.detectors=[],this.detectors.length=o;for(var a=o;a--;)this.detectors[a]=[],this.detectors[a].length=o;this.detectors[e.SHAPE_SPHERE][e.SHAPE_SPHERE]=new e.SphereSphereCollisionDetector,this.detectors[e.SHAPE_SPHERE][e.SHAPE_BOX]=new e.SphereBoxCollisionDetector(!1),this.detectors[e.SHAPE_BOX][e.SHAPE_SPHERE]=new e.SphereBoxCollisionDetector(!0),this.detectors[e.SHAPE_BOX][e.SHAPE_BOX]=new e.BoxBoxCollisionDetector,this.detectors[e.SHAPE_CYLINDER][e.SHAPE_CYLINDER]=new e.CylinderCylinderCollisionDetector,this.detectors[e.SHAPE_CYLINDER][e.SHAPE_BOX]=new e.BoxCylinderCollisionDetector(!0),this.detectors[e.SHAPE_BOX][e.SHAPE_CYLINDER]=new e.BoxCylinderCollisionDetector(!1),this.detectors[e.SHAPE_CYLINDER][e.SHAPE_SPHERE]=new e.SphereCylinderCollisionDetector(!0),this.detectors[e.SHAPE_SPHERE][e.SHAPE_CYLINDER]=new e.SphereCylinderCollisionDetector(!1),this.detectors[e.SHAPE_TETRA][e.SHAPE_TETRA]=new e.TetraTetraCollisionDetector,this.randX=65535,this.randA=98765,this.randB=123456789,this.islandRigidBodies=[],this.islandStack=[],this.islandConstraints=[]},e.World.prototype={constructor:e.World,clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies);e.nextID=0,e.proxyID=0},addRigidBody:function(t){t.parent&&e.Error("World","It is not possible to be added to more than one world one of the rigid body"),t.parent=this,t.awake();for(var i=t.shapes;null!==i;i=i.next)this.addShape(i);null!==this.rigidBodies&&((this.rigidBodies.prev=t).next=this.rigidBodies),this.rigidBodies=t,this.numRigidBodies++},removeRigidBody:function(t){var i=t;if(i.parent===this){i.awake();for(var s=i.jointLink;null!=s;){var h=s.joint;s=s.next,this.removeJoint(h)}for(var e=t.shapes;null!==e;e=e.next)this.removeShape(e);var o=i.prev,a=i.next;null!==o&&(o.next=a),null!==a&&(a.prev=o),this.rigidBodies==i&&(this.rigidBodies=a),i.prev=null,i.next=null,i.parent=null,this.numRigidBodies--}},getByName:function(t){for(var i=null,s=this.rigidBodies;null!==s;)" "!==s.name&&s.name===t&&(i=s),s=s.next;for(var h=this.joints;null!==h;)""!==h.name&&h.name===t&&(i=h),h=h.next;return i},addShape:function(t){t.parent&&t.parent.parent||e.Error("World","It is not possible to be added alone to shape world"),t.proxy=this.broadPhase.createProxy(t),t.updateProxy(),this.broadPhase.addProxy(t.proxy)},removeShape:function(t){this.broadPhase.removeProxy(t.proxy),t.proxy=null},addJoint:function(t){t.parent&&e.Error("World","It is not possible to be added to more than one world one of the joint"),null!=this.joints&&((this.joints.prev=t).next=this.joints),this.joints=t,t.parent=this,this.numJoints++,t.awake(),t.attach()},removeJoint:function(t){var i=t,s=i.prev,h=i.next;null!==s&&(s.next=h),null!==h&&(h.prev=s),this.joints==i&&(this.joints=h),i.prev=null,i.next=null,this.numJoints--,i.awake(),i.detach(),i.parent=null},worldscale:function(t){e.WORLD_SCALE=t||100,e.INV_SCALE=1/e.WORLD_SCALE},addContact:function(t,i){var s;null!==this.unusedContacts?(s=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):s=new e.Contact,s.attach(t,i),s.detector=this.detectors[t.type][i.type],this.contacts&&((this.contacts.prev=s).next=this.contacts),this.contacts=s,this.numContacts++},removeContact:function(t){var i=t.prev,s=t.next;s&&(s.prev=i),i&&(i.next=s),this.contacts==t&&(this.contacts=s),t.prev=null,t.next=null,t.detach(),t.next=this.unusedContacts,this.unusedContacts=t,this.numContacts--},checkContact:function(t,i){for(var s,h,e=this.contacts;null!==e;){if(s=e.body1.name||" ",h=e.body2.name||" ",s==t&&h==i||h==t&&s==i)return!!e.touching;e=e.next}return!1},callSleep:function(t){return!!t.allowSleep&&(!(t.linearVelocity.lengthSq()>.04)&&!(t.angularVelocity.lengthSq()>.25))},step:function(){var t,i,s,h,o=!this.isNoStat;o&&(t=e.now());for(var a=this.rigidBodies;null!==a;)a.addedToIsland=!1,a.sleeping&&(a.linearVelocity.testZero()||a.angularVelocity.testZero()||a.position.testDiff(a.sleepPosition)||a.orientation.testDiff(a.sleepOrientation))&&a.awake(),a=a.next;o&&(i=e.now()),this.broadPhase.detectPairs();for(var n=this.broadPhase.pairs,r=this.broadPhase.numPairs;r--;){var l,c,m=n[r];m.shape1.id<m.shape2.id?(l=m.shape1,c=m.shape2):(l=m.shape2,c=m.shape1);var p;p=l.numContacts<c.numContacts?l.contactLink:c.contactLink;for(var u=!1;p;){var x=p.contact;if(x.shape1==l&&x.shape2==c){x.persisting=!0,u=!0;break}p=p.next}u||this.addContact(l,c)}for(o&&(s=e.now(),this.performance.broadPhaseTime=s-i),this.numContactPoints=0,x=this.contacts;null!==x;)if(x.persisting||!x.shape1.aabb.intersectTest(x.shape2.aabb)){var y=x.body1,d=x.body2;(y.isDynamic&&!y.sleeping||d.isDynamic&&!d.sleeping)&&x.updateManifold(),this.numContactPoints+=x.manifold.numPoints,x.persisting=!1,x.constraint.addedToIsland=!1,x=x.next}else{var N=x.next;this.removeContact(x),x=N}o&&(h=e.now(),this.performance.narrowPhaseTime=h-s);var f,z,v=1/this.timeStep;for(f=this.joints;null!==f;f=f.next)f.addedToIsland=!1;this.islandRigidBodies=[],this.islandConstraints=[],this.islandStack=[],i=e.now(),this.numIslands=0;for(var b=this.rigidBodies;null!==b;b=b.next)if(!(b.addedToIsland||b.isStatic||b.sleeping))if(b.isLonely())b.isDynamic&&b.linearVelocity.addTime(this.gravity,this.timeStep),this.callSleep(b)?(b.sleepTime+=this.timeStep,b.sleepTime>.5?b.sleep():b.updatePosition(this.timeStep)):(b.sleepTime=0,b.updatePosition(this.timeStep)),this.numIslands++;else{var A=0,k=0,S=1;this.islandStack[0]=b,b.addedToIsland=!0;do if(a=this.islandStack[--S],this.islandStack[S]=null,a.sleeping=!1,this.islandRigidBodies[A++]=a,!a.isStatic){for(var g=a.contactLink;null!==g;g=g.next){var x=g.contact;if(z=x.constraint,!z.addedToIsland&&x.touching){this.islandConstraints[k++]=z,z.addedToIsland=!0;var N=g.body;N.addedToIsland||(this.islandStack[S++]=N,N.addedToIsland=!0)}}for(var P=a.jointLink;null!==P;P=P.next)z=P.joint,z.addedToIsland||(this.islandConstraints[k++]=z,z.addedToIsland=!0,N=P.body,!N.addedToIsland&&N.isDynamic&&(this.islandStack[S++]=N,N.addedToIsland=!0))}while(0!=S);for(var I=(new e.Vec3).addTime(this.gravity,this.timeStep),w=A;w--;)a=this.islandRigidBodies[w],a.isDynamic&&a.linearVelocity.addEqual(I);if(this.enableRandomizer)for(w=k;w--;)if(0!==w){var L=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*w|0;z=this.islandConstraints[w],this.islandConstraints[w]=this.islandConstraints[L],this.islandConstraints[L]=z}for(w=k;w--;)this.islandConstraints[w].preSolve(this.timeStep,v);for(var M=this.numIterations;M--;)for(w=k;w--;)this.islandConstraints[w].solve();for(w=k;w--;)this.islandConstraints[w].postSolve(),this.islandConstraints[w]=null;var V=10;for(w=A;w--;)a=this.islandRigidBodies[w],this.callSleep(a)?(a.sleepTime+=this.timeStep,a.sleepTime<V&&(V=a.sleepTime)):(a.sleepTime=0,V=0);if(V>.5)for(w=A;w--;)this.islandRigidBodies[w].sleep(),this.islandRigidBodies[w]=null;else for(w=A;w--;)this.islandRigidBodies[w].updatePosition(this.timeStep),this.islandRigidBodies[w]=null;this.numIslands++}o&&(s=e.now(),this.performance.solvingTime=s-i,s=e.now(),this.performance.upfps(),this.performance.totalTime=s-t)}},e.RigidBody=function(t,i,s,h,o,a,n){this.name=" ",this.MAX_SHAPES=64,this.prev=null,this.next=null,this.type=e.BODY_NULL,this.massInfo=new e.MassInfo,this.position=new e.Vec3(t,i,s),this.orientation=this.rotationAxisToQuad(h||0,o||0,a||0,n||0),this.newPosition=new e.Vec3,this.controlPos=!1,this.newOrientation=new e.Quat,this.newRotation=new e.Vec3,this.currentRotation=new e.Vec3,this.controlRot=!1,this.controlRotInTime=!1,this.linearVelocity=new e.Vec3,this.angularVelocity=new e.Vec3,this.matrix=new e.Mat44,this.parent=null,this.contactLink=null,this.numContacts=0,this.shapes=null,this.numShapes=0,this.jointLink=null,this.numJoints=0,this.sleepPosition=new e.Vec3,this.sleepOrientation=new e.Quat,this.isStatic=!1,this.isDynamic=!1,this.rotation=new e.Mat33,this.mass=NaN,this.inverseMass=NaN,this.inverseInertia=new e.Mat33,this.localInertia=new e.Mat33,this.inverseLocalInertia=new e.Mat33,this.addedToIsland=!1,this.allowSleep=!0,this.sleepTime=0,this.sleeping=!1},e.RigidBody.prototype={constructor:e.RigidBody,addShape:function(t){t.parent&&e.Error("RigidBody","It is not possible that you add to the multi-rigid body the shape of one"),null!=this.shapes&&((this.shapes.prev=t).next=this.shapes),this.shapes=t,t.parent=this,this.parent&&this.parent.addShape(t),this.numShapes++},removeShape:function(t){var i=t;if(i.parent==this){var s=i.prev,h=i.next;null!=s&&(s.next=h),null!=h&&(h.prev=s),this.shapes==i&&(this.shapes=h),i.prev=null,i.next=null,i.parent=null,this.parent&&this.parent.removeShape(i),this.numShapes--}},remove:function(){this.dispose()},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(t){this.parent.checkContact(this.name,t)},setupMass:function(t,i){var s=void 0===i||i;this.type=t||e.BODY_DYNAMIC,this.isDynamic=this.type==e.BODY_DYNAMIC,this.isStatic=this.type==e.BODY_STATIC,this.mass=0,this.localInertia.set(0,0,0,0,0,0,0,0,0);for(var h=this.localInertia.elements,o=new e.Mat33,a=new e.Vec3,n=this.shapes;null!=n;n=n.next){n.calculateMassInfo(this.massInfo);var r=this.massInfo.mass,l=n.relativePosition.x,c=n.relativePosition.y,m=n.relativePosition.z;a.addScale(n.relativePosition,r),this.mass+=r,this.rotateInertia(n.relativeRotation,this.massInfo.inertia,o),this.localInertia.addEqual(o),h[0]+=r*(c*c+m*m),h[4]+=r*(l*l+m*m),h[8]+=r*(l*l+c*c);var p=r*l*c,u=r*c*m,x=r*m*l;h[1]-=p,h[3]-=p,h[2]-=u,h[6]-=u,h[5]-=x,h[7]-=x}if(this.inverseMass=1/this.mass,a.scaleEqual(this.inverseMass),s){for(this.position.addEqual(a),n=this.shapes;null!=n;n=n.next)n.relativePosition.subEqual(a);l=a.x,c=a.y,m=a.z,h[0]-=this.mass*(c*c+m*m),h[4]-=this.mass*(l*l+m*m),h[8]-=this.mass*(l*l+c*c),p=this.mass*l*c,u=this.mass*c*m,x=this.mass*m*l,h[1]+=p,h[3]+=p,h[2]+=u,h[6]+=u,h[5]+=x,h[7]+=x}this.inverseLocalInertia.invert(this.localInertia),this.type==e.BODY_STATIC&&(this.inverseMass=0,this.inverseLocalInertia.set(0,0,0,0,0,0,0,0,0)),this.syncShapes(),this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1,this.sleepTime=0;for(var t=this.contactLink;null!=t;)t.body.sleepTime=0,t.body.sleeping=!1,t=t.next;for(var i=this.jointLink;null!=i;)i.body.sleepTime=0,i.body.sleeping=!1,i=i.next;for(var s=this.shapes;null!=s;s=s.next)s.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.sleepPosition.copy(this.position),this.sleepOrientation.copy(this.orientation),this.sleepTime=0,this.sleeping=!0;for(var t=this.shapes;null!=t;t=t.next)t.updateProxy()}},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(t){switch(this.type){case e.BODY_STATIC:this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1),this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case e.BODY_DYNAMIC:this.controlPos&&(this.angularVelocity.set(0,0,0),this.linearVelocity.set(0,0,0),this.linearVelocity.x=(this.newPosition.x-this.position.x)/t,this.linearVelocity.y=(this.newPosition.y-this.position.y)/t,this.linearVelocity.z=(this.newPosition.z-this.position.z)/t,this.controlPos=!1),this.controlRot&&(this.angularVelocity.set(0,0,0),this.orientation.copy(this.newOrientation),this.controlRot=!1),this.position.addTime(this.linearVelocity,t),this.orientation.addTime(this.angularVelocity,t);break;default:e.Error("RigidBody","Invalid type.")}this.syncShapes()},rotateInertia:function(t,i,s){var h=t.elements,e=i.elements,o=h[0],a=h[3],n=h[6],r=h[1],l=h[4],c=h[7],m=h[2],p=h[5],u=h[8],x=e[0],y=e[3],d=e[6],N=e[1],f=e[4],z=e[7],v=e[2],b=e[5],A=e[8],k=o*x+r*y+m*d,S=o*N+r*f+m*z,g=o*v+r*b+m*A,P=a*x+l*y+p*d,I=a*N+l*f+p*z,w=a*v+l*b+p*A,L=n*x+c*y+u*d,M=n*N+c*f+u*z,V=n*v+c*b+u*A,C=s.elements;C[0]=k*o+S*r+g*m,C[1]=k*a+S*l+g*p,C[2]=k*n+S*c+g*u,C[3]=P*o+I*r+w*m,C[4]=P*a+I*l+w*p,C[5]=P*n+I*c+w*u,C[6]=L*o+M*r+V*m,C[7]=L*a+M*l+V*p,C[8]=L*n+M*c+V*u},syncShapes:function(){var t=this.orientation.s,i=this.orientation.x,s=this.orientation.y,h=this.orientation.z,e=2*i,o=2*s,a=2*h,n=i*e,r=s*o,l=h*a,c=i*o,m=s*a,p=i*a,u=t*e,x=t*o,y=t*a,d=this.rotation.elements;d[0]=1-r-l,d[1]=c-y,d[2]=p+x,d[3]=c+y,d[4]=1-n-l,d[5]=m-u,d[6]=p-x,d[7]=m+u,d[8]=1-n-r,this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(var N=this.shapes;null!=N;N=N.next)N.position.mul(this.position,N.relativePosition,this.rotation),N.rotation.mul(this.rotation,N.relativeRotation),N.updateProxy()},applyImpulse:function(t,i){this.linearVelocity.addScale(i,this.inverseMass);var s=new e.Vec3;s.sub(t,this.position).cross(s,i).mulMat(this.inverseInertia,s),this.angularVelocity.addEqual(s)},rotationVectToQuad:function(t){var i=e.EulerToAxis(t.x*e.degtorad,t.y*e.degtorad,t.z*e.degtorad);return this.rotationAxisToQuad(i[0],i[1],i[2],i[3])},rotationAxisToQuad:function(t,i,s,h){var o=i*i+s*s+h*h;o>0&&(o=1/e.sqrt(o),i*=o,s*=o,h*=o);var a=e.sin(.5*t),n=e.cos(.5*t);return new e.Quat(n,a*i,a*s,a*h)},setPosition:function(t){this.newPosition.copy(t).multiplyScalar(e.INV_SCALE),this.controlPos=!0},setQuaternion:function(t){this.newOrientation.set(t.x,t.y,t.z,t.w),this.controlRot=!0},setRotation:function(t){this.newOrientation=this.rotationVectToQuad(t),this.controlRot=!0},resetPosition:function(t,i,s){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.position.set(t,i,s).multiplyScalar(e.INV_SCALE),this.awake()},resetQuaternion:function(t){this.angularVelocity.set(0,0,0),this.orientation=new e.Quat(t.w,t.x,t.y,t.z),this.awake()},resetRotation:function(t,i,s){this.angularVelocity.set(0,0,0),this.orientation=this.rotationVectToQuad(new e.Vec3(t,i,s)),this.awake()},getPosition:function(){return(new e.Vec3).scale(this.position,e.WORLD_SCALE)},getRotation:function(){return(new e.Euler).setFromRotationMatrix(this.rotation)},getQuaternion:function(){return(new e.Quaternion).setFromRotationMatrix(this.rotation)},getMatrix:function(){var t,i,s=this.matrix.elements;return this.sleeping?s[15]=1:(t=this.rotation.elements,s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=0,s[4]=t[1],s[5]=t[4],s[6]=t[7],s[7]=0,s[8]=t[2],s[9]=t[5],s[10]=t[8],s[11]=0,i=this.position,s[12]=i.x*e.WORLD_SCALE,s[13]=i.y*e.WORLD_SCALE,s[14]=i.z*e.WORLD_SCALE,s[15]=0),s}},e.Body=function(t){var i=t||{};i.world&&(void 0===i.type&&(i.type="box"),this.name=i.name||"",this.body=i.world.add(i))},e.Body.prototype={constructor:e.Body,setPosition:function(t){this.body.setPosition(t)},setQuaternion:function(t){this.body.setQuaternion(t)},setRotation:function(t){this.body.setRotation(t)},getPosition:function(){return this.body.getPosition()},getRotation:function(){return this.body.getRotation()},getQuaternion:function(){return this.body.getQuaternion()},getMatrix:function(){return this.body.getMatrix()},getSleep:function(){return this.body.sleeping},resetPosition:function(t,i,s){this.body.resetPosition(t,i,s)},resetRotation:function(t,i,s){this.body.resetRotation(t,i,s)},awake:function(){this.body.awake()},remove:function(){this.body.dispose()},checkContact:function(t){this.body.checkContact(t)}},e.Link=function(t){var i=t||{};i.world&&(void 0===i.type&&(i.type="jointHinge"),this.name=i.name||"",this.joint=i.world.add(i))},e.Link.prototype={constructor:e.Link,getPosition:function(){return this.joint.getPosition()},getMatrix:function(){return this.joint.getMatrix()},remove:function(){this.joint.dispose()},awake:function(){this.joint.awake()}},e.Dictionary=function(){this.data={},this.keys=[]},e.Dictionary.prototype={constructor:e.Dictionary,set:function(t){var i=t.id;this.get[i]||this.keys.push(i),this.data[i]=t},get:function(t){return this.data[t]},del:function(t){var i=this.keys,s=i.indexOf(t.id);s>-1&&(delete this.data[i[s]],i.splice(s,1))},reset:function(){for(var t,i=this.data,s=this.keys;s.length>0;)t=s.pop(),delete i[t]}},e.Performance=function(t){this.parent=t,this.infos=new h(13),this.f=[0,0,0],this.types=["None","BruteForce","Sweep & Prune","Bounding Volume Tree"],this.broadPhase=this.types[this.parent.broadPhase.types],this.version=e.REVISION,this.fps=0,this.broadPhaseTime=0,this.narrowPhaseTime=0,this.solvingTime=0,this.totalTime=0},e.Performance.prototype={upfps:function(){this.f[1]=Date.now(),this.f[1]-1e3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0),this.f[2]++},updatingTime:function(){return e.fix(this.totalTime-(this.broadPhaseTime+this.narrowPhaseTime+this.solvingTime))},show:function(){var t=["Oimo.js "+this.version+"<br>",this.broadPhase+"<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","ct-point &nbsp;"+this.parent.numContactPoints+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in milliseconde<br><br>","broad-phase &nbsp;"+e.fix(this.broadPhaseTime)+"<br>","narrow-phase "+e.fix(this.narrowPhaseTime)+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+e.fix(this.solvingTime)+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+e.fix(this.totalTime)+"<br>","updating &nbsp;&nbsp;&nbsp;&nbsp;"+this.updatingTime()+"<br>"].join("\n");return t},toArray:function(){return this.infos[0]=this.parent.broadPhase.types,this.infos[1]=this.parent.numRigidBodies,this.infos[2]=this.parent.numContacts,this.infos[3]=this.parent.broadPhase.numPairChecks,this.infos[4]=this.parent.numContactPoints,this.infos[5]=this.parent.numIslands,this.infos[6]=this.broadPhaseTime,this.infos[7]=this.narrowPhaseTime,this.infos[8]=this.solvingTime,this.infos[9]=this.updatingTime(),this.infos[10]=this.totalTime,this.infos[11]=this.fps,this.infos}},e.Mat44=function(t,i,s,e,o,a,n,r,l,c,m,p,u,x,y,d){this.elements=new h(16);var N=this.elements;N[0]=void 0!==t?t:1,N[4]=i||0,N[8]=s||0,N[12]=e||0,N[1]=o||0,N[5]=void 0!==a?a:1,N[9]=n||0,N[13]=r||0,N[2]=l||0,N[6]=c||0,N[10]=void 0!==m?m:1,N[14]=p||0,N[3]=u||0,N[7]=x||0,N[11]=y||0,N[15]=void 0!==d?d:1},e.Mat44.prototype={constructor:e.Mat44,set:function(t,i,s,h,e,o,a,n,r,l,c,m,p,u,x,y){var d=this.elements;return d[0]=t,d[4]=i,d[8]=s,d[12]=h,d[1]=e,d[5]=o,d[9]=a,d[13]=n,d[2]=r,d[6]=l,d[10]=c,d[14]=m,d[3]=p,d[7]=u,d[11]=x,d[15]=y,this}},e.Mat33=function(t,i,s,e,o,a,n,r,l){this.elements=new h(9);this.elements;this.init(void 0!==t?t:1,i||0,s||0,e||0,void 0!==o?o:1,a||0,n||0,r||0,void 0!==l?l:1)},e.Mat33.prototype={constructor:e.Mat33,set:function(t,i,s,h,e,o,a,n,r){var l=this.elements;return l[0]=t,l[1]=i,l[2]=s,l[3]=h,l[4]=e,l[5]=o,l[6]=a,l[7]=n,l[8]=r,this},init:function(t,i,s,h,e,o,a,n,r){var l=this.elements;return l[0]=t,l[1]=i,l[2]=s,l[3]=h,l[4]=e,l[5]=o,l[6]=a,l[7]=n,l[8]=r,this},multiply:function(t){var i=this.elements;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t,i[4]*=t,i[5]*=t,i[6]*=t,i[7]*=t,i[8]*=t,this},add:function(t,i){var s=this.elements,h=t.elements,e=i.elements;return s[0]=h[0]+e[0],s[1]=h[1]+e[1],s[2]=h[2]+e[2],s[3]=h[3]+e[3],s[4]=h[4]+e[4],s[5]=h[5]+e[5],s[6]=h[6]+e[6],s[7]=h[7]+e[7],s[8]=h[8]+e[8],this},addEqual:function(t){var i=this.elements,s=t.elements;return i[0]+=s[0],i[1]+=s[1],i[2]+=s[2],i[3]+=s[3],i[4]+=s[4],i[5]+=s[5],i[6]+=s[6],i[7]+=s[7],i[8]+=s[8],this},sub:function(t,i){var s=this.elements,h=t.elements,e=i.elements;return s[0]=h[0]-e[0],s[1]=h[1]-e[1],s[2]=h[2]-e[2],s[3]=h[3]-e[3],s[4]=h[4]-e[4],s[5]=h[5]-e[5],s[6]=h[6]-e[6],s[7]=h[7]-e[7],s[8]=h[8]-e[8],this},subEqual:function(t){var i=this.elements,s=t.elements;return i[0]-=s[0],i[1]-=s[1],i[2]-=s[2],i[3]-=s[3],i[4]-=s[4],i[5]-=s[5],i[6]-=s[6],i[7]-=s[7],i[8]-=s[8],this},scale:function(t,i){var s=this.elements,h=t.elements;return s[0]=h[0]*i,s[1]=h[1]*i,s[2]=h[2]*i,s[3]=h[3]*i,s[4]=h[4]*i,s[5]=h[5]*i,s[6]=h[6]*i,s[7]=h[7]*i,s[8]=h[8]*i,this},scaleEqual:function(t){var i=this.elements;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t,i[4]*=t,i[5]*=t,i[6]*=t,i[7]*=t,i[8]*=t,this},mul:function(t,i){var s=this.elements,h=t.elements,e=i.elements,o=h[0],a=h[3],n=h[6],r=h[1],l=h[4],c=h[7],m=h[2],p=h[5],u=h[8],x=e[0],y=e[3],d=e[6],N=e[1],f=e[4],z=e[7],v=e[2],b=e[5],A=e[8];return s[0]=o*x+r*y+m*d,s[1]=o*N+r*f+m*z,s[2]=o*v+r*b+m*A,s[3]=a*x+l*y+p*d,s[4]=a*N+l*f+p*z,s[5]=a*v+l*b+p*A,s[6]=n*x+c*y+u*d,s[7]=n*N+c*f+u*z,s[8]=n*v+c*b+u*A,this},mulScale:function(t,i,s,h,e){var o=e||!1,a=this.elements,n=t.elements;return o?(a[0]=i*n[0],a[1]=i*n[1],a[2]=i*n[2],a[3]=s*n[3],a[4]=s*n[4],a[5]=s*n[5],a[6]=h*n[6],a[7]=h*n[7],a[8]=h*n[8]):(a[0]=n[0]*i,a[1]=n[1]*s,a[2]=n[2]*h,a[3]=n[3]*i,a[4]=n[4]*s,a[5]=n[5]*h,a[6]=n[6]*i,a[7]=n[7]*s,a[8]=n[8]*h),this},mulRotate:function(t,i,s,h,o,a){var n=a||!1,r=e.sin(i),l=e.cos(i),c=1-l,m=s*s*c+l,p=s*h*c-o*r,u=s*o*c+h*r,x=h*s*c+o*r,y=h*h*c+l,d=h*o*c-s*r,N=o*s*c-h*r,f=o*h*c+s*r,z=o*o*c+l,v=t.elements,b=v[0],A=v[3],k=v[6],S=v[1],g=v[4],P=v[7],I=v[2],w=v[5],L=v[8],M=this.elements;return n?(M[0]=m*b+p*A+u*k,M[1]=m*S+p*g+u*P,M[2]=m*I+p*w+u*L,M[3]=x*b+y*A+d*k,M[4]=x*S+y*g+d*P,M[5]=x*I+y*w+d*L,M[6]=N*b+f*A+z*k,M[7]=N*S+f*g+z*P,M[8]=N*I+f*w+z*L):(M[0]=b*m+S*x+I*N,M[1]=b*p+S*y+I*f,M[2]=b*u+S*d+I*z,M[3]=A*m+g*x+w*N,M[4]=A*p+g*y+w*f,M[5]=A*u+g*d+w*z,M[6]=k*m+P*x+L*N,M[7]=k*p+P*y+L*f,M[8]=k*u+P*d+L*z),this},transpose:function(t){var i=this.elements,s=t.elements;return i[0]=s[0],i[1]=s[3],i[2]=s[6],i[3]=s[1],i[4]=s[4],i[5]=s[7],i[6]=s[2],i[7]=s[5],i[8]=s[8],this},setQuat:function(t){var i=this.elements,s=2*t.x,h=2*t.y,e=2*t.z,o=t.x*s,a=t.y*h,n=t.z*e,r=t.x*h,l=t.y*e,c=t.x*e,m=t.s*s,p=t.s*h,u=t.s*e;return i[0]=1-a-n,i[1]=r-u,i[2]=c+p,i[3]=r+u,i[4]=1-o-n,i[5]=l-m,i[6]=c-p,i[7]=l+m,i[8]=1-o-a,this},invert:function(t){var i=this.elements,s=t.elements,h=s[0],e=s[3],o=s[6],a=s[1],n=s[4],r=s[7],l=s[2],c=s[5],m=s[8],p=n*m-r*c,u=r*l-a*m,x=a*c-n*l,y=h*p+e*u+o*x;return 0!=y&&(y=1/y),i[0]=y*p,i[1]=y*u,i[2]=y*x,i[3]=y*(c*o-e*m),i[4]=y*(h*m-l*o),i[5]=y*(l*e-h*c),i[6]=y*(e*r-n*o),i[7]=y*(a*o-h*r),i[8]=y*(h*n-a*e),this},toEuler:function(){function t(t){return e.min(e.max(t,-1),1)}var i=this.elements,s=i[0],h=i[3],o=i[6],a=(i[1],i[4]),n=i[7],r=(i[2],i[5]),l=i[8],c=new e.Vec3;new e.Quat;return c.y=e.asin(t(o)),e.abs(o)<.99999?(c.x=e.atan2(-n,l),c.z=e.atan2(-h,s)):(c.x=e.atan2(r,a),c.z=0),c},toString:function(){var t=this.elements,i="Mat33|"+t[0].toFixed(4)+", "+t[1].toFixed(4)+", "+t[2].toFixed(4)+"|\n     |"+t[3].toFixed(4)+", "+t[4].toFixed(4)+", "+t[5].toFixed(4)+"|\n     |"+t[6].toFixed(4)+", "+t[7].toFixed(4)+", "+t[8].toFixed(4)+"|";return i},multiplyScalar:function(t){var i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=t,i[4]*=t,i[7]*=t,i[2]*=t,i[5]*=t,i[8]*=t,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t){var i=t.elements;return this.set(i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8]),this},fromArray:function(t){return this.elements.set(t),this},toArray:function(){var t=this.elements;return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}},e.Quat=function(t,i,s,h){this.s=void 0!==t?t:1,this.x=i||0,this.y=s||0,this.z=h||0},e.Quat.prototype={constructor:e.Quat,set:function(t,i,s,h){return this.x=t,this.y=i,this.z=s,this.s=h,this},init:function(t,i,s,h){return this.s=void 0!==t?t:1,this.x=i||0,this.y=s||0,this.z=h||0,this},add:function(t,i){return this.s=t.s+i.s,this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this},addTime:function(t,i){var s=t.x,h=t.y,o=t.z,a=this.s,n=this.x,r=this.y,l=this.z;i*=.5;var c=(-s*n-h*r-o*l)*i,m=(s*a+h*l-o*r)*i,p=(-s*l+h*a+o*n)*i,u=(s*r-h*n+o*a)*i;a+=c,n+=m,r+=p,l+=u;var x=1/e.sqrt(a*a+n*n+r*r+l*l);return this.s=a*x,this.x=n*x,this.y=r*x,this.z=l*x,this},sub:function(t,i){return this.s=t.s-i.s,this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this},scale:function(t,i){return this.s=t.s*i,this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},mul:function(t,i){var s=t.x,h=t.y,e=t.z,o=t.s,a=i.x,n=i.y,r=i.z,l=i.s;return this.x=s*l+o*a+h*r-e*n,this.y=h*l+o*n+e*a-s*r,this.z=e*l+o*r+s*n-h*a,this.s=o*l-s*a-h*n-e*r,this},arc:function(t,i){var s=t.x,h=t.y,o=t.z,a=i.x,n=i.y,r=i.z,l=s*a+h*n+o*r;if(l==-1)return a=h*s-o*o,n=-o*h-s*s,r=s*o+h*h,l=1/e.sqrt(a*a+n*n+r*r),this.s=0,this.x=a*l,this.y=n*l,this.z=r*l,this;var c=h*r-o*n,m=o*a-s*r,p=s*n-h*a;return this.s=e.sqrt(.5*(1+l)),l=.5/this.s,this.x=c*l,this.y=m*l,this.z=p*l,this},normalize:function(t){var i=e.sqrt(t.s*t.s+t.x*t.x+t.y*t.y+t.z*t.z);return i>0&&(i=1/i),this.s=t.s*i,this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},invert:function(t){return this.s=t.s,this.x=-t.x,this.y=-t.y,this.z=-t.z,this},length:function(){return e.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.s=t.s,this.x=t.x,this.y=t.y,this.z=t.z,this},testDiff:function(t){return this.s!==t.s||this.x!==t.x||this.y!==t.y||this.z!==t.z},clone:function(t){return new e.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}},e.Quaternion=function(t,i,s,h){this.x=t||0,this.y=i||0,this.z=s||0,this.w=void 0!==h?h:1},e.Quaternion.prototype={constructor:e.Quaternion,setFromRotationMatrix:function(t){var i,s=t.elements,h=s[0],o=s[1],a=s[2],n=s[3],r=s[4],l=s[5],c=s[6],m=s[7],p=s[8],u=h+r+p;return u>0?(i=.5/e.sqrt(u+1),this.w=.25/i,this.x=(m-l)*i,this.y=(a-c)*i,this.z=(n-o)*i):h>r&&h>p?(i=2*e.sqrt(1+h-r-p),this.w=(m-l)/i,this.x=.25*i,this.y=(o+n)/i,this.z=(a+c)/i):r>p?(i=2*e.sqrt(1+r-h-p),this.w=(a-c)/i,this.x=(o+n)/i,this.y=.25*i,this.z=(l+m)/i):(i=2*e.sqrt(1+p-h-r),this.w=(n-o)/i,this.x=(a+c)/i,this.y=(l+m)/i,this.z=.25*i),this}},e.Vec3=function(t,i,s){this.x=t||0,this.y=i||0,this.z=s||0},e.Vec3.prototype={constructor:e.Vec3,init:function(t,i,s){return this.x=t||0,this.y=i||0,this.z=s||0,this},set:function(t,i,s){return this.x=t,this.y=i,this.z=s,this},add:function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this},addEqual:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},addTime:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this},sub:function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this},subEqual:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},addScale:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this},scale:function(t,i){return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},scaleEqual:function(t){return this.x*=t,this.y*=t,this.z*=t,this},cross:function(t,i){var s=t.x,h=t.y,e=t.z,o=i.x,a=i.y,n=i.z;return this.x=h*n-e*a,this.y=e*o-s*n,this.z=s*a-h*o,this},mul:function(t,i,s){var h=s.elements;return this.x=t.x+i.x*h[0]+i.y*h[1]+i.z*h[2],this.y=t.y+i.x*h[3]+i.y*h[4]+i.z*h[5],this.z=t.z+i.x*h[6]+i.y*h[7]+i.z*h[8],this},mulMat:function(t,i){var s=t.elements;return this.x=s[0]*i.x+s[1]*i.y+s[2]*i.z,this.y=s[3]*i.x+s[4]*i.y+s[5]*i.z,this.z=s[6]*i.x+s[7]*i.y+s[8]*i.z,this},normalize:function(t){var i=t.x,s=t.y,h=t.z,o=i*i+s*s+h*h;return o>0&&(o=1/e.sqrt(o),this.x=i*o,this.y=s*o,this.z=h*o),this},invert:function(t){return this.x=-t.x,this.y=-t.y,this.z=-t.z,this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return e.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},applyQuaternion:function(t){var i=this.x,s=this.y,h=this.z,e=t.x,o=t.y,a=t.z,n=t.s,r=n*i+o*h-a*s,l=n*s+a*i-e*h,c=n*h+e*s-o*i,m=-e*i-o*s-a*h;return this.x=r*n+m*-e+l*-a-c*-o,this.y=l*n+m*-o+c*-e-r*-a,this.z=c*n+m*-a+r*-o-l*-e,this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z},testDiff:function(t){return t.x!==this.x||t.y!==this.y||t.z!==this.z},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},clone:function(){return new this.constructor(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"},multiplyScalar:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this},divideScalar:function(t){return this.multiplyScalar(1/t)},norm:function(){return this.divideScalar(this.length())}},e.Euler=function(t,i,s,h){this._x=t||0,this._y=i||0,this._z=s||0,this._order=h||e.Euler.DefaultOrder},e.Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],e.Euler.DefaultOrder="XYZ",e.clamp=function(t,i,s){return t<i?i:t>s?s:t},e.Euler.prototype={constructor:e.Euler,_x:0,_y:0,_z:0,_order:e.Euler.DefaultOrder,get x(){return this._x},set x(t){this._x=t,this.onChangeCallback()},get y(){return this._y},set y(t){this._y=t,this.onChangeCallback()},get z(){return this._z},set z(t){this._z=t,this.onChangeCallback()},get order(){return this._order},set order(t){this._order=t,this.onChangeCallback()},set:function(t,i,s,h){return this._x=t,this._y=i,this._z=s,this._order=h||this._order,this.onChangeCallback(),this},copy:function(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this.onChangeCallback(),this},setFromRotationMatrix:function(t,i){var s=e.clamp,h=t.elements,o=h[0],a=h[1],n=h[2],r=h[3],l=h[4],c=h[5],m=h[6],p=h[7],u=h[8];return i=i||this._order,"XYZ"===i?(this._y=e.asin(s(n,-1,1)),e.abs(n)<.99999?(this._x=e.atan2(-c,u),this._z=e.atan2(-a,o)):(this._x=e.atan2(p,l),this._z=0)):"YXZ"===i?(this._x=e.asin(-s(c,-1,1)),e.abs(c)<.99999?(this._y=e.atan2(n,u),this._z=e.atan2(r,l)):(this._y=e.atan2(-m,o),this._z=0)):"ZXY"===i?(this._x=e.asin(s(p,-1,1)),e.abs(p)<.99999?(this._y=e.atan2(-m,u),this._z=e.atan2(-a,l)):(this._y=0,this._z=e.atan2(r,o))):"ZYX"===i?(this._y=e.asin(-s(m,-1,1)),e.abs(m)<.99999?(this._x=e.atan2(p,u),
this._z=e.atan2(r,o)):(this._x=0,this._z=e.atan2(-a,l))):"YZX"===i?(this._z=e.asin(s(r,-1,1)),e.abs(r)<.99999?(this._x=e.atan2(-c,l),this._y=e.atan2(-m,o)):(this._x=0,this._y=e.atan2(n,u))):"XZY"===i?(this._z=e.asin(-s(a,-1,1)),e.abs(a)<.99999?(this._x=e.atan2(p,l),this._y=e.atan2(n,o)):(this._x=e.atan2(-c,u),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+i),this._order=i,this.onChangeCallback(),this},setFromQuaternion:function(t,i,s){var h=e.clamp,o=t.x*t.x,a=t.y*t.y,n=t.z*t.z,r=t.s*t.s;return i=i||this._order,"XYZ"===i?(this._x=e.atan2(2*(t.x*t.s-t.y*t.z),r-o-a+n),this._y=e.asin(h(2*(t.x*t.z+t.y*t.s),-1,1)),this._z=e.atan2(2*(t.z*t.s-t.x*t.y),r+o-a-n)):"YXZ"===i?(this._x=e.asin(h(2*(t.x*t.s-t.y*t.z),-1,1)),this._y=e.atan2(2*(t.x*t.z+t.y*t.s),r-o-a+n),this._z=e.atan2(2*(t.x*t.y+t.z*t.s),r-o+a-n)):"ZXY"===i?(this._x=e.asin(h(2*(t.x*t.s+t.y*t.z),-1,1)),this._y=e.atan2(2*(t.y*t.s-t.z*t.x),r-o-a+n),this._z=e.atan2(2*(t.z*t.s-t.x*t.y),r-o+a-n)):"ZYX"===i?(this._x=e.atan2(2*(t.x*t.s+t.z*t.y),r-o-a+n),this._y=e.asin(h(2*(t.y*t.s-t.x*t.z),-1,1)),this._z=e.atan2(2*(t.x*t.y+t.z*t.s),r+o-a-n)):"YZX"===i?(this._x=e.atan2(2*(t.x*t.s-t.z*t.y),r-o+a-n),this._y=e.atan2(2*(t.y*t.s-t.x*t.z),r+o-a-n),this._z=e.asin(h(2*(t.x*t.y+t.z*t.s),-1,1))):"XZY"===i?(this._x=e.atan2(2*(t.x*t.s+t.y*t.z),r-o+a-n),this._y=e.atan2(2*(t.x*t.z+t.y*t.s),r+o-a-n),this._z=e.asin(h(2*(t.z*t.s-t.x*t.y),-1,1))):console.warn("OIMO.Euler: .setFromQuaternion() given unsupported order: "+i),this._order=i,s!==!1&&this.onChangeCallback(),this},reorder:function(){var t=new e.Quat;return function(i){t.setFromEuler(this),this.setFromQuaternion(t,i)}}(),equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order},fromArray:function(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this.onChangeCallback(),this},toArray:function(){return[this._x,this._y,this._z,this._order]},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){},clone:function(){return new e.Euler(this._x,this._y,this._z,this._order)}},e.EulerToAxis=function(t,i,s){var h=e.cos(.5*i),o=e.sin(.5*i),a=e.cos(.5*s),n=e.sin(.5*s),r=e.cos(.5*t),l=e.sin(.5*t),c=h*a,m=o*n,p=c*r-m*l,u=c*l+m*r,x=o*a*r+h*n*l,y=h*n*r-o*a*l,d=2*e.acos(p),N=u*u+x*x+y*y;return N<.001?(u=1,x=y=0):(N=e.sqrt(N),u/=N,x/=N,y/=N),[d,u,x,y]},e.EulerToMatrix=function(t,i,s){var h=e.cos(i),o=e.sin(i),a=e.cos(s),n=e.sin(s),r=e.cos(t),l=e.sin(t),c=new e.Mat33,m=c.elements;return m[0]=h*a,m[1]=o*l-h*n*r,m[2]=h*n*l+o*r,m[3]=n,m[4]=a*r,m[5]=-a*l,m[6]=-o*a,m[7]=o*n*r+h*l,m[8]=-o*n*l+h*r,c},e.MatrixToEuler=function(t){var i,s,h,o=t.elements;return o[3]>.998?(s=e.atan2(o[2],o[8]),h=e.PI/2,i=0):o[3]<-.998?(s=e.atan2(o[2],o[8]),h=-e.PI/2,i=0):(s=e.atan2(-o[6],o[0]),i=e.atan2(-o[5],o[4]),h=e.asin(o[3])),[i,s,h]},e.unwrapDegrees=function(t){return t%=360,t>180&&(t-=360),t<-180&&(t+=360),t},e.unwrapRadian=function(t){return t%=e.TwoPI,t>e.PI&&(t-=e.TwoPI),t<-e.PI&&(t+=e.TwoPI),t},e.Distance3d=function(t,i){var s=i[0]-t[0],h=i[1]-t[1],o=i[2]-t[2];return e.sqrt(s*s+h*h+o*o)},e.Constraint=function(){this.parent=null,this.body1=null,this.body2=null,this.addedToIsland=!1},e.Constraint.prototype={constructor:e.Constraint,preSolve:function(t,i){e.Error("Constraint","Inheritance error.")},solve:function(){e.Error("Constraint","Inheritance error.")},postSolve:function(){e.Error("Constraint","Inheritance error.")}},e.Joint=function(t){e.Constraint.call(this),this.name="",this.type=e.JOINT_NULL,this.prev=null,this.next=null,this.body1=t.body1,this.body2=t.body2,this.localAnchorPoint1=(new e.Vec3).copy(t.localAnchorPoint1),this.localAnchorPoint2=(new e.Vec3).copy(t.localAnchorPoint2),this.relativeAnchorPoint1=new e.Vec3,this.relativeAnchorPoint2=new e.Vec3,this.anchorPoint1=new e.Vec3,this.anchorPoint2=new e.Vec3,this.allowCollision=t.allowCollision,this.b1Link=new e.JointLink(this),this.b2Link=new e.JointLink(this),this.matrix=new e.Mat44},e.Joint.prototype=Object.create(e.Constraint.prototype),e.Joint.prototype.constructor=e.Joint,e.Joint.prototype.updateAnchorPoints=function(){this.relativeAnchorPoint1.mulMat(this.body1.rotation,this.localAnchorPoint1),this.relativeAnchorPoint2.mulMat(this.body2.rotation,this.localAnchorPoint2),this.anchorPoint1.add(this.relativeAnchorPoint1,this.body1.position),this.anchorPoint2.add(this.relativeAnchorPoint2,this.body2.position)},e.Joint.prototype.attach=function(){this.b1Link.body=this.body2,this.b2Link.body=this.body1,null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null,this.body1.jointLink=this.b1Link,this.body1.numJoints++,null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null,this.body2.jointLink=this.b2Link,this.body2.numJoints++},e.Joint.prototype.detach=function(){var t=this.b1Link.prev,i=this.b1Link.next;null!=t&&(t.next=i),null!=i&&(i.prev=t),this.body1.jointLink==this.b1Link&&(this.body1.jointLink=i),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.body=null,this.body1.numJoints--,t=this.b2Link.prev,i=this.b2Link.next,null!=t&&(t.next=i),null!=i&&(i.prev=t),this.body2.jointLink==this.b2Link&&(this.body2.jointLink=i),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.body=null,this.body2.numJoints--,this.b1Link.body=null,this.b2Link.body=null},e.Joint.prototype.awake=function(){this.body1.awake(),this.body2.awake()},e.Joint.prototype.preSolve=function(t,i){},e.Joint.prototype.solve=function(){},e.Joint.prototype.postSolve=function(){},e.Joint.prototype.remove=function(){this.dispose()},e.Joint.prototype.dispose=function(){this.parent.removeJoint(this)},e.Joint.prototype.getPosition=function(){var t=(new e.Vec3).scale(this.anchorPoint1,e.WORLD_SCALE),i=(new e.Vec3).scale(this.anchorPoint2,e.WORLD_SCALE);return[t,i]},e.Joint.prototype.getMatrix=function(){var t=this.matrix.elements,i=this.anchorPoint1,s=this.anchorPoint2;return t[0]=i.x*e.WORLD_SCALE,t[1]=i.y*e.WORLD_SCALE,t[2]=i.z*e.WORLD_SCALE,t[3]=0,t[4]=s.x*e.WORLD_SCALE,t[5]=s.y*e.WORLD_SCALE,t[6]=s.z*e.WORLD_SCALE,t[7]=0,t},e.JointConfig=function(){this.body1=null,this.body2=null,this.localAnchorPoint1=new e.Vec3,this.localAnchorPoint2=new e.Vec3,this.localAxis1=new e.Vec3,this.localAxis2=new e.Vec3,this.allowCollision=!1},e.JointLink=function(t){this.prev=null,this.next=null,this.body=null,this.joint=t},e.LimitMotor=function(t,i){i=i||!1,this.axis=t,this.angle=0,this.lowerLimit=i?0:1,this.upperLimit=0,this.motorSpeed=0,this.maxMotorForce=0,this.frequency=0,this.dampingRatio=0},e.LimitMotor.prototype={constructor:e.LimitMotor,setLimit:function(t,i){this.lowerLimit=t,this.upperLimit=i},setMotor:function(t,i){this.motorSpeed=t,this.maxMotorForce=i},setSpring:function(t,i){this.frequency=t,this.dampingRatio=i}},e.BallAndSocketJoint=function(t){e.Joint.call(this,t),this.type=e.JOINT_BALL_AND_SOCKET,this.lc=new e.LinearConstraint(this)},e.BallAndSocketJoint.prototype=Object.create(e.Joint.prototype),e.BallAndSocketJoint.prototype.constructor=e.BallAndSocketJoint,e.BallAndSocketJoint.prototype.preSolve=function(t,i){this.updateAnchorPoints(),this.lc.preSolve(t,i)},e.BallAndSocketJoint.prototype.solve=function(){this.lc.solve()},e.BallAndSocketJoint.prototype.postSolve=function(){},e.DistanceJoint=function(t,i,s){e.Joint.call(this,t),this.type=e.JOINT_DISTANCE,this.normal=new e.Vec3,this.nr=new e.Vec3,this.limitMotor=new e.LimitMotor(this.normal,!0),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.t=new e.TranslationalConstraint(this,this.limitMotor)},e.DistanceJoint.prototype=Object.create(e.Joint.prototype),e.DistanceJoint.prototype.constructor=e.DistanceJoint,e.DistanceJoint.prototype.preSolve=function(t,i){this.updateAnchorPoints(),this.nr.sub(this.anchorPoint2,this.anchorPoint1),this.normal.normalize(this.nr),this.t.preSolve(t,i)},e.DistanceJoint.prototype.solve=function(){this.t.solve()},e.DistanceJoint.prototype.postSolve=function(){},e.HingeJoint=function(t,i,s){e.Joint.call(this,t),this.type=e.JOINT_HINGE,this.localAxis1=t.localAxis1.clone().norm(),this.localAxis2=t.localAxis2.clone().norm(),this.localAngle1=new e.Vec3(this.localAxis1.y*this.localAxis1.x-this.localAxis1.z*this.localAxis1.z,-this.localAxis1.z*this.localAxis1.y-this.localAxis1.x*this.localAxis1.x,this.localAxis1.x*this.localAxis1.z+this.localAxis1.y*this.localAxis1.y).norm();var h=(new e.Mat33).setQuat((new e.Quat).arc(this.localAxis1,this.localAxis2));this.localAngle2=(new e.Vec3).mulMat(h,this.localAngle1),this.nor=new e.Vec3,this.tan=new e.Vec3,this.bin=new e.Vec3,this.ax1=new e.Vec3,this.ax2=new e.Vec3,this.an1=new e.Vec3,this.an2=new e.Vec3,this.limitMotor=new e.LimitMotor(this.nor,!1),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.lc=new e.LinearConstraint(this),this.r3=new e.Rotational3Constraint(this,this.limitMotor,new e.LimitMotor(this.tan,!0),new e.LimitMotor(this.bin,!0))},e.HingeJoint.prototype=Object.create(e.Joint.prototype),e.HingeJoint.prototype.constructor=e.HingeJoint,e.HingeJoint.prototype.preSolve=function(t,i){var s,h,e,o;this.updateAnchorPoints(),this.ax1.mulMat(this.body1.rotation,this.localAxis1),this.ax2.mulMat(this.body2.rotation,this.localAxis2),this.an1.mulMat(this.body1.rotation,this.localAngle1),this.an2.mulMat(this.body2.rotation,this.localAngle2),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).norm(),this.tan.set(this.nor.y*this.nor.x-this.nor.z*this.nor.z,-this.nor.z*this.nor.y-this.nor.x*this.nor.x,this.nor.x*this.nor.z+this.nor.y*this.nor.y).norm(),this.bin.set(this.nor.y*this.tan.z-this.nor.z*this.tan.y,this.nor.z*this.tan.x-this.nor.x*this.tan.z,this.nor.x*this.tan.y-this.nor.y*this.tan.x),o=this.acosClamp(this.an1.x*this.an2.x+this.an1.y*this.an2.y+this.an1.z*this.an2.z),this.nor.x*(this.an1.y*this.an2.z-this.an1.z*this.an2.y)+this.nor.y*(this.an1.z*this.an2.x-this.an1.x*this.an2.z)+this.nor.z*(this.an1.x*this.an2.y-this.an1.y*this.an2.x)<0?this.limitMotor.angle=-o:this.limitMotor.angle=o,s=this.ax1.y*this.ax2.z-this.ax1.z*this.ax2.y,h=this.ax1.z*this.ax2.x-this.ax1.x*this.ax2.z,e=this.ax1.x*this.ax2.y-this.ax1.y*this.ax2.x,this.r3.limitMotor2.angle=this.tan.x*s+this.tan.y*h+this.tan.z*e,this.r3.limitMotor3.angle=this.bin.x*s+this.bin.y*h+this.bin.z*e,this.r3.preSolve(t,i),this.lc.preSolve(t,i)},e.HingeJoint.prototype.solve=function(){this.r3.solve(),this.lc.solve()},e.HingeJoint.prototype.postSolve=function(){},e.HingeJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?e.PI:e.acos(t)},e.PrismaticJoint=function(t,i,s){e.Joint.call(this,t),this.type=e.JOINT_PRISMATIC,this.localAxis1=(new e.Vec3).normalize(t.localAxis1),this.localAxis2=(new e.Vec3).normalize(t.localAxis2),this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z,this.nor=new e.Vec3,this.tan=new e.Vec3,this.bin=new e.Vec3,this.ac=new e.AngularConstraint(this,(new e.Quat).arc(this.localAxis1,this.localAxis2)),this.limitMotor=new e.LimitMotor(this.nor,!0),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.t3=new e.Translational3Constraint(this,this.limitMotor,new e.LimitMotor(this.tan,!0),new e.LimitMotor(this.bin,!0))},e.PrismaticJoint.prototype=Object.create(e.Joint.prototype),e.PrismaticJoint.prototype.constructor=e.PrismaticJoint,e.PrismaticJoint.prototype.preSolve=function(t,i){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var o=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],a=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],n=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8];s=this.body2.rotation.elements;var r=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],l=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],c=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],m=o*this.body2.inverseMass+r*this.body1.inverseMass,p=a*this.body2.inverseMass+l*this.body1.inverseMass,u=n*this.body2.inverseMass+c*this.body1.inverseMass;h=e.sqrt(m*m+p*p+u*u),h>0&&(h=1/h),m*=h,p*=h,u*=h;var x=p*m-u*u,y=-u*p-m*m,d=m*u+p*p;h=1/e.sqrt(x*x+y*y+d*d),x*=h,y*=h,d*=h;var N=p*d-u*y,f=u*x-m*d,z=m*y-p*x;this.nor.init(m,p,u),this.tan.init(x,y,d),this.bin.init(N,f,z),this.ac.preSolve(t,i),this.t3.preSolve(t,i)},e.PrismaticJoint.prototype.solve=function(){this.ac.solve(),this.t3.solve()},e.PrismaticJoint.prototype.postSolve=function(){},e.SliderJoint=function(t,i,s){e.Joint.call(this,t),this.type=e.JOINT_SLIDER,this.localAxis1=(new e.Vec3).normalize(t.localAxis1),this.localAxis2=(new e.Vec3).normalize(t.localAxis2);var h;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,h=1/e.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=h,this.localAngAxis1Y*=h,this.localAngAxis1Z*=h,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var o=(new e.Mat33).setQuat((new e.Quat).arc(this.localAxis1,this.localAxis2)),a=o.elements;this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*a[1]+this.localAngAxis1Z*a[2],this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5],this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8],this.nor=new e.Vec3,this.tan=new e.Vec3,this.bin=new e.Vec3,this.rotationalLimitMotor=new e.LimitMotor(this.nor,!1),this.r3=new e.Rotational3Constraint(this,this.rotationalLimitMotor,new e.LimitMotor(this.tan,!0),new e.LimitMotor(this.bin,!0)),this.translationalLimitMotor=new e.LimitMotor(this.nor,!0),this.translationalLimitMotor.lowerLimit=i,this.translationalLimitMotor.upperLimit=s,this.t3=new e.Translational3Constraint(this,this.translationalLimitMotor,new e.LimitMotor(this.tan,!0),new e.LimitMotor(this.bin,!0))},e.SliderJoint.prototype=Object.create(e.Joint.prototype),e.SliderJoint.prototype.constructor=e.SliderJoint,e.SliderJoint.prototype.preSolve=function(t,i){var s,h,o,a;this.updateAnchorPoints(),s=this.body1.rotation.elements;var n=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],r=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],l=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],c=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],m=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],p=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var u=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],x=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],y=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],d=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],N=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],f=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8],z=n*this.body2.inverseMass+u*this.body1.inverseMass,v=r*this.body2.inverseMass+x*this.body1.inverseMass,b=l*this.body2.inverseMass+y*this.body1.inverseMass;h=e.sqrt(z*z+v*v+b*b),h>0&&(h=1/h),z*=h,v*=h,b*=h;var A=v*z-b*b,k=-b*v-z*z,S=z*b+v*v;h=1/e.sqrt(A*A+k*k+S*S),A*=h,k*=h,S*=h;var g=v*S-b*k,P=b*A-z*S,I=z*k-v*A;this.nor.init(z,v,b),this.tan.init(A,k,S),this.bin.init(g,P,I),z*(m*f-p*N)+v*(p*d-c*f)+b*(c*N-m*d)<0?this.rotationalLimitMotor.angle=-this.acosClamp(c*d+m*N+p*f):this.rotationalLimitMotor.angle=this.acosClamp(c*d+m*N+p*f),h=r*y-l*x,o=l*u-n*y,a=n*x-r*u,this.r3.limitMotor2.angle=A*h+k*o+S*a,this.r3.limitMotor3.angle=g*h+P*o+I*a,this.r3.preSolve(t,i),this.t3.preSolve(t,i)},e.SliderJoint.prototype.solve=function(){this.r3.solve(),this.t3.solve()},e.SliderJoint.prototype.postSolve=function(){},e.SliderJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?e.PI:e.acos(t)},e.WheelJoint=function(t){e.Joint.call(this,t),this.type=e.JOINT_WHEEL,this.localAxis1=(new e.Vec3).normalize(t.localAxis1),this.localAxis2=(new e.Vec3).normalize(t.localAxis2);var i;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var s=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;if(s>-1&&s<1)this.localAngAxis1X=this.localAxis2X-s*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-s*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-s*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-s*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-s*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-s*this.localAxis2Z,i=1/e.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=i,this.localAngAxis1Y*=i,this.localAngAxis1Z*=i,i=1/e.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=i,this.localAngAxis2Y*=i,this.localAngAxis2Z*=i;else{this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,i=1/e.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=i,this.localAngAxis1Y*=i,this.localAngAxis1Z*=i;var h=(new e.Mat33).setQuat((new e.Quat).arc(this.localAxis1,this.localAxis2)),o=h.elements;this.localAngAxis2X=this.localAngAxis1X*o[0]+this.localAngAxis1Y*o[1]+this.localAngAxis1Z*o[2],this.localAngAxis2Y=this.localAngAxis1X*o[3]+this.localAngAxis1Y*o[4]+this.localAngAxis1Z*o[5],this.localAngAxis2Z=this.localAngAxis1X*o[6]+this.localAngAxis1Y*o[7]+this.localAngAxis1Z*o[8]}this.nor=new e.Vec3,this.tan=new e.Vec3,this.bin=new e.Vec3,this.translationalLimitMotor=new e.LimitMotor(this.tan,!0),this.translationalLimitMotor.frequency=8,this.translationalLimitMotor.dampingRatio=1,this.rotationalLimitMotor1=new e.LimitMotor(this.tan,!1),this.rotationalLimitMotor2=new e.LimitMotor(this.bin,!1),this.t3=new e.Translational3Constraint(this,new e.LimitMotor(this.nor,!0),this.translationalLimitMotor,new e.LimitMotor(this.bin,!0)),this.t3.weight=1,this.r3=new e.Rotational3Constraint(this,new e.LimitMotor(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)},e.WheelJoint.prototype=Object.create(e.Joint.prototype),e.WheelJoint.prototype.constructor=e.WheelJoint,e.WheelJoint.prototype.preSolve=function(t,i){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var o=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],a=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],n=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],r=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],l=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],c=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var m=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],p=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],u=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],x=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],y=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],d=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8];this.r3.limitMotor1.angle=o*m+a*p+n*u,o*(l*u-c*p)+a*(c*m-r*u)+n*(r*p-l*m)<0?this.rotationalLimitMotor1.angle=-this.acosClamp(r*m+l*p+c*u):this.rotationalLimitMotor1.angle=this.acosClamp(r*m+l*p+c*u),m*(y*n-d*a)+p*(d*o-x*n)+u*(x*a-y*o)<0?this.rotationalLimitMotor2.angle=this.acosClamp(x*o+y*a+d*n):this.rotationalLimitMotor2.angle=-this.acosClamp(x*o+y*a+d*n);var N=p*n-u*a,f=u*o-m*n,z=m*a-p*o;h=e.sqrt(N*N+f*f+z*z),h>0&&(h=1/h),N*=h,f*=h,z*=h;var v=f*u-z*p,b=z*m-N*u,A=N*p-f*m;h=e.sqrt(v*v+b*b+A*A),h>0&&(h=1/h),v*=h,b*=h,A*=h;var k=a*z-n*f,S=n*N-o*z,g=o*f-a*N;h=e.sqrt(k*k+S*S+g*g),h>0&&(h=1/h),k*=h,S*=h,g*=h,this.nor.init(N,f,z),this.tan.init(v,b,A),this.bin.init(k,S,g),this.r3.preSolve(t,i),this.t3.preSolve(t,i)},e.WheelJoint.prototype.solve=function(){this.r3.solve(),this.t3.solve()},e.WheelJoint.prototype.postSolve=function(){},e.WheelJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?e.PI:e.acos(t)},e.AngularConstraint=function(t,i){this.joint=t,this.targetOrientation=(new e.Quat).invert(i),this.relativeOrientation=new e.Quat,this.ii1=null,this.ii2=null,this.dd=null,this.vel=new e.Vec3,this.imp=new e.Vec3,this.rn0=new e.Vec3,this.rn1=new e.Vec3,this.rn2=new e.Vec3,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia},e.AngularConstraint.prototype={constructor:e.AngularConstraint,preSolve:function(t,i){var s,h,o;this.ii1=this.i1.clone(),this.ii2=this.i2.clone(),o=(new e.Mat33).add(this.ii1,this.ii2).elements,s=1/(o[0]*(o[4]*o[8]-o[7]*o[5])+o[3]*(o[7]*o[2]-o[1]*o[8])+o[6]*(o[1]*o[5]-o[4]*o[2])),this.dd=new e.Mat33(o[4]*o[8]-o[5]*o[7],o[2]*o[7]-o[1]*o[8],o[1]*o[5]-o[2]*o[4],o[5]*o[6]-o[3]*o[8],o[0]*o[8]-o[2]*o[6],o[2]*o[3]-o[0]*o[5],o[3]*o[7]-o[4]*o[6],o[1]*o[6]-o[0]*o[7],o[0]*o[4]-o[1]*o[3]).multiply(s),this.relativeOrientation.invert(this.b1.orientation),this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation),this.relativeOrientation.mul(this.b2.orientation,this.relativeOrientation),s=2*this.relativeOrientation.s,this.vel.scale(this.relativeOrientation,s),h=this.vel.length(),h>.02?(h=(.02-h)/h*i*.05,this.vel.scaleEqual(h)):this.vel.init(),this.rn1.mulMat(this.ii1,this.imp),this.rn2.mulMat(this.ii2,this.imp),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)},solve:function(){var t=this.a2.clone().subEqual(this.a1).subEqual(this.vel);this.rn0.mulMat(this.dd,t),this.rn1.mulMat(this.ii1,this.rn0),this.rn2.mulMat(this.ii2,this.rn0),this.imp.addEqual(this.rn0),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)}},e.LinearConstraint=function(t){this.m1=NaN,this.m2=NaN,this.ii1=null,this.ii2=null,this.dd=null,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.ax1x=NaN,this.ax1y=NaN,this.ax1z=NaN,this.ay1x=NaN,this.ay1y=NaN,this.ay1z=NaN,this.az1x=NaN,this.az1y=NaN,this.az1z=NaN,this.ax2x=NaN,this.ax2y=NaN,this.ax2z=NaN,this.ay2x=NaN,this.ay2y=NaN,this.ay2z=NaN,this.az2x=NaN,this.az2y=NaN,this.az2z=NaN,this.vel=NaN,this.velx=NaN,this.vely=NaN,this.velz=NaN,this.joint=t,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.b1=t.body1,this.b2=t.body2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.impx=0,this.impy=0,this.impz=0},e.LinearConstraint.prototype={constructor:e.LinearConstraint,preSolve:function(t,i){this.r1x=this.r1.x,this.r1y=this.r1.y,this.r1z=this.r1.z,this.r2x=this.r2.x,this.r2y=this.r2.y,this.r2z=this.r2.z,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,h=this.ii2.elements;this.ax1x=this.r1z*s[1]+-this.r1y*s[2],this.ax1y=this.r1z*s[4]+-this.r1y*s[5],this.ax1z=this.r1z*s[7]+-this.r1y*s[8],this.ay1x=-this.r1z*s[0]+this.r1x*s[2],this.ay1y=-this.r1z*s[3]+this.r1x*s[5],this.ay1z=-this.r1z*s[6]+this.r1x*s[8],this.az1x=this.r1y*s[0]+-this.r1x*s[1],this.az1y=this.r1y*s[3]+-this.r1x*s[4],this.az1z=this.r1y*s[6]+-this.r1x*s[7],this.ax2x=this.r2z*h[1]+-this.r2y*h[2],this.ax2y=this.r2z*h[4]+-this.r2y*h[5],this.ax2z=this.r2z*h[7]+-this.r2y*h[8],this.ay2x=-this.r2z*h[0]+this.r2x*h[2],this.ay2y=-this.r2z*h[3]+this.r2x*h[5],this.ay2z=-this.r2z*h[6]+this.r2x*h[8],this.az2x=this.r2y*h[0]+-this.r2x*h[1],this.az2y=this.r2y*h[3]+-this.r2x*h[4],this.az2z=this.r2y*h[6]+-this.r2x*h[7];var o=this.m1+this.m2,a=new e.Mat33(o,0,0,0,o,0,0,0,o),n=a.elements;n[0]+=s[4]*this.r1z*this.r1z-(s[7]+s[5])*this.r1y*this.r1z+s[8]*this.r1y*this.r1y,n[1]+=(s[6]*this.r1y+s[5]*this.r1x)*this.r1z-s[3]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,n[2]+=(s[3]*this.r1y-s[4]*this.r1x)*this.r1z-s[6]*this.r1y*this.r1y+s[7]*this.r1x*this.r1y,n[3]+=(s[2]*this.r1y+s[7]*this.r1x)*this.r1z-s[1]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,n[4]+=s[0]*this.r1z*this.r1z-(s[6]+s[2])*this.r1x*this.r1z+s[8]*this.r1x*this.r1x,n[5]+=(s[1]*this.r1x-s[0]*this.r1y)*this.r1z-s[7]*this.r1x*this.r1x+s[6]*this.r1x*this.r1y,n[6]+=(s[1]*this.r1y-s[4]*this.r1x)*this.r1z-s[2]*this.r1y*this.r1y+s[5]*this.r1x*this.r1y,n[7]+=(s[3]*this.r1x-s[0]*this.r1y)*this.r1z-s[5]*this.r1x*this.r1x+s[2]*this.r1x*this.r1y,n[8]+=s[0]*this.r1y*this.r1y-(s[3]+s[1])*this.r1x*this.r1y+s[4]*this.r1x*this.r1x,n[0]+=h[4]*this.r2z*this.r2z-(h[7]+h[5])*this.r2y*this.r2z+h[8]*this.r2y*this.r2y,n[1]+=(h[6]*this.r2y+h[5]*this.r2x)*this.r2z-h[3]*this.r2z*this.r2z-h[8]*this.r2x*this.r2y,n[2]+=(h[3]*this.r2y-h[4]*this.r2x)*this.r2z-h[6]*this.r2y*this.r2y+h[7]*this.r2x*this.r2y,n[3]+=(h[2]*this.r2y+h[7]*this.r2x)*this.r2z-h[1]*this.r2z*this.r2z-h[8]*this.r2x*this.r2y,n[4]+=h[0]*this.r2z*this.r2z-(h[6]+h[2])*this.r2x*this.r2z+h[8]*this.r2x*this.r2x,n[5]+=(h[1]*this.r2x-h[0]*this.r2y)*this.r2z-h[7]*this.r2x*this.r2x+h[6]*this.r2x*this.r2y,n[6]+=(h[1]*this.r2y-h[4]*this.r2x)*this.r2z-h[2]*this.r2y*this.r2y+h[5]*this.r2x*this.r2y,n[7]+=(h[3]*this.r2x-h[0]*this.r2y)*this.r2z-h[5]*this.r2x*this.r2x+h[2]*this.r2x*this.r2y,n[8]+=h[0]*this.r2y*this.r2y-(h[3]+h[1])*this.r2x*this.r2y+h[4]*this.r2x*this.r2x;var r=1/(n[0]*(n[4]*n[8]-n[7]*n[5])+n[3]*(n[7]*n[2]-n[1]*n[8])+n[6]*(n[1]*n[5]-n[4]*n[2]));this.dd=new e.Mat33(n[4]*n[8]-n[5]*n[7],n[2]*n[7]-n[1]*n[8],n[1]*n[5]-n[2]*n[4],n[5]*n[6]-n[3]*n[8],n[0]*n[8]-n[2]*n[6],n[2]*n[3]-n[0]*n[5],n[3]*n[7]-n[4]*n[6],n[1]*n[6]-n[0]*n[7],n[0]*n[4]-n[1]*n[3]).multiply(r),this.velx=this.p2.x-this.p1.x,this.vely=this.p2.y-this.p1.y,this.velz=this.p2.z-this.p1.z;var l=e.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);l>.005?(l=(.005-l)/l*i*.05,this.velx*=l,this.vely*=l,this.velz*=l):(this.velx=0,this.vely=0,this.velz=0),this.impx*=.95,this.impy*=.95,this.impz*=.95,this.l1.x+=this.impx*this.m1,this.l1.y+=this.impy*this.m1,this.l1.z+=this.impz*this.m1,this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x,this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y,this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z,this.l2.x-=this.impx*this.m2,this.l2.y-=this.impy*this.m2,this.l2.z-=this.impz*this.m2,this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x,this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y,this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var t=this.dd.elements,i=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,s=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,h=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,e=i*t[0]+s*t[1]+h*t[2],o=i*t[3]+s*t[4]+h*t[5],a=i*t[6]+s*t[7]+h*t[8];this.impx+=e,this.impy+=o,this.impz+=a,this.l1.x+=e*this.m1,this.l1.y+=o*this.m1,this.l1.z+=a*this.m1,this.a1.x+=e*this.ax1x+o*this.ay1x+a*this.az1x,this.a1.y+=e*this.ax1y+o*this.ay1y+a*this.az1y,this.a1.z+=e*this.ax1z+o*this.ay1z+a*this.az1z,this.l2.x-=e*this.m2,this.l2.y-=o*this.m2,this.l2.z-=a*this.m2,this.a2.x-=e*this.ax2x+o*this.ay2x+a*this.az2x,this.a2.y-=e*this.ax2y+o*this.ay2y+a*this.az2y,this.a2.z-=e*this.ax2z+o*this.ay2z+a*this.az2z}},e.Rotational3Constraint=function(t,i,s,h){this.cfm1=NaN,this.cfm2=NaN,this.cfm3=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=s,this.limitMotor3=h,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0},e.Rotational3Constraint.prototype={constructor:e.Rotational3Constraint,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor1.frequency,o=this.limitMotor2.frequency,a=this.limitMotor3.frequency,n=e>0,r=o>0,l=a>0,c=this.lowerLimit1<=this.upperLimit1,m=this.lowerLimit2<=this.upperLimit2,p=this.lowerLimit3<=this.upperLimit3,u=this.limitMotor1.angle;
c?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-u):u<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-u):u>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-u):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),n||(this.limitVelocity1>.02?this.limitVelocity1-=.02:this.limitVelocity1<-.02?this.limitVelocity1+=.02:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0);var x=this.limitMotor2.angle;m?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-x):x<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-x):x>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-x):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),r||(this.limitVelocity2>.02?this.limitVelocity2-=.02:this.limitVelocity2<-.02?this.limitVelocity2+=.02:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0);var y=this.limitMotor3.angle;if(p?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-y):y<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-y):y>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-y):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),l||(this.limitVelocity3>.02?this.limitVelocity3-=.02:this.limitVelocity3<-.02?this.limitVelocity3+=.02:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||n)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||r)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||l)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0),this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02,this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12,this.a1z1=this.ax1*this.i1e20+this.ay1*this.i1e21+this.az1*this.i1e22,this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02,this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12,this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22,this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02,this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12,this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22,this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+this.az2*this.i2e02,this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12,this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22,this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02,this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12,this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22,this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02,this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12,this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22,this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1),this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2),this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3),this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1),this.k11=this.ax2*(this.a1x2+this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2),this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3),this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1),this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2),this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3),this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,n&&2!=this.limitState1){var d=6.2831853*e,N=d*d*t,f=i/(N+2*this.limitMotor1.dampingRatio*d);this.cfm1=this.kv00*f,this.limitVelocity1*=N*f}else this.cfm1=0,this.limitVelocity1*=.05*i;r&&2!=this.limitState2?(d=6.2831853*o,N=d*d*t,f=i/(N+2*this.limitMotor2.dampingRatio*d),this.cfm2=this.kv11*f,this.limitVelocity2*=N*f):(this.cfm2=0,this.limitVelocity2*=.05*i),l&&2!=this.limitState3?(d=6.2831853*a,N=d*d*t,f=i/(N+2*this.limitMotor3.dampingRatio*d),this.cfm3=this.kv22*f,this.limitVelocity3*=N*f):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var z=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*z,this.d01=(this.k02*this.k21-this.k01*this.k22)*z,this.d02=(this.k01*this.k12-this.k02*this.k11)*z,this.d10=(this.k12*this.k20-this.k10*this.k22)*z,this.d11=(this.k00*this.k22-this.k02*this.k20)*z,this.d12=(this.k02*this.k10-this.k00*this.k12)*z,this.d20=(this.k10*this.k21-this.k11*this.k20)*z,this.d21=(this.k01*this.k20-this.k00*this.k21)*z,this.d22=(this.k00*this.k11-this.k01*this.k10)*z,this.limitImpulse1*=.95,this.motorImpulse1*=.95,this.limitImpulse2*=.95,this.motorImpulse2*=.95,this.limitImpulse3*=.95,this.motorImpulse3*=.95;var v=this.limitImpulse1+this.motorImpulse1,b=this.limitImpulse2+this.motorImpulse2,A=this.limitImpulse3+this.motorImpulse3;this.a1.x+=v*this.a1x1+b*this.a1x2+A*this.a1x3,this.a1.y+=v*this.a1y1+b*this.a1y2+A*this.a1y3,this.a1.z+=v*this.a1z1+b*this.a1z2+A*this.a1z3,this.a2.x-=v*this.a2x1+b*this.a2x2+A*this.a2x3,this.a2.y-=v*this.a2y1+b*this.a2y2+A*this.a2y3,this.a2.z-=v*this.a2z1+b*this.a2z2+A*this.a2z3},solve_:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z;this.limitVelocity3=30;var h=t*this.ax1+i*this.ay1+s*this.az1-this.limitVelocity1,e=t*this.ax2+i*this.ay2+s*this.az2-this.limitVelocity2,o=t*this.ax3+i*this.ay3+s*this.az3-this.limitVelocity3,a=h*this.d00+e*this.d01+o*this.d02,n=h*this.d10+e*this.d11+o*this.d12,r=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=a,this.limitImpulse2+=n,this.limitImpulse3+=r,this.a1.x+=a*this.a1x1+n*this.a1x2+r*this.a1x3,this.a1.y+=a*this.a1y1+n*this.a1y2+r*this.a1y3,this.a1.z+=a*this.a1z1+n*this.a1z2+r*this.a1z3,this.a2.x-=a*this.a2x1+n*this.a2x2+r*this.a2x3,this.a2.y-=a*this.a2y1+n*this.a2y2+r*this.a2y3,this.a2.z-=a*this.a2z1+n*this.a2z2+r*this.a2z3},solve:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,h=t*this.ax1+i*this.ay1+s*this.az1,e=t*this.ax2+i*this.ay2+s*this.az2,o=t*this.ax3+i*this.ay3+s*this.az3,a=this.motorImpulse1,n=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-a),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-n),this.enableMotor3&&(m=(o-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,o+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,o-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,u=this.limitImpulse2,x=this.limitImpulse3,y=h*this.d00+e*this.d01+o*this.d02,d=h*this.d10+e*this.d11+o*this.d12,N=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=y,this.limitImpulse2+=d,this.limitImpulse3+=N;var f=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(y=-p,e+=y*this.k10,o+=y*this.k20,f|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(d=-u,h+=d*this.k01,o+=d*this.k21,f|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(N=-x,h+=N*this.k02,e+=N*this.k12,f|=4);var z;switch(f){case 1:z=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*o)*z,N=(-this.k21*e+this.k11*o)*z;break;case 2:z=1/(this.k00*this.k22-this.k02*this.k20),y=(this.k22*h+-this.k02*o)*z,N=(-this.k20*h+this.k00*o)*z;break;case 3:N=o/this.k22;break;case 4:z=1/(this.k00*this.k11-this.k01*this.k10),y=(this.k11*h+-this.k01*e)*z,d=(-this.k10*h+this.k00*e)*z;break;case 5:d=e/this.k11;break;case 6:y=h/this.k00}this.limitImpulse1=y+p,this.limitImpulse2=d+u,this.limitImpulse3=N+x;var v=l+y,b=c+d,A=m+N;this.a1.x+=v*this.a1x1+b*this.a1x2+A*this.a1x3,this.a1.y+=v*this.a1y1+b*this.a1y2+A*this.a1y3,this.a1.z+=v*this.a1z1+b*this.a1z2+A*this.a1z3,this.a2.x-=v*this.a2x1+b*this.a2x2+A*this.a2x3,this.a2.y-=v*this.a2y1+b*this.a2y2+A*this.a2y3,this.a2.z-=v*this.a2z1+b*this.a2z2+A*this.a2z3,t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,e=t*this.ax2+i*this.ay2+s*this.az2}},e.RotationalConstraint=function(t,i){this.cfm=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.enableLimit=!1,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=i,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0},e.RotationalConstraint.prototype={constructor:e.RotationalConstraint,preSolve:function(t,i){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor.frequency,o=e>0,a=this.lowerLimit<=this.upperLimit,n=this.limitMotor.angle;if(a?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n):n<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n):n>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-n):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),o||(this.limitVelocity>.02?this.limitVelocity-=.02:this.limitVelocity<-.02?this.limitVelocity+=.02:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||o)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0),this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02,this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12,this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22,this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02,this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12,this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22,this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z),this.invMotorDenom=1/this.motorDenom,o&&2!=this.limitState){var r=6.2831853*e,l=r*r*t,c=i/(l+2*this.limitMotor.dampingRatio*r);this.cfm=this.motorDenom*c,this.limitVelocity*=l*c}else this.cfm=0,this.limitVelocity*=.05*i;this.invDenom=1/(this.motorDenom+this.cfm),this.limitImpulse*=.95,this.motorImpulse*=.95;var m=this.limitImpulse+this.motorImpulse;this.a1.x+=m*this.a1x,this.a1.y+=m*this.a1y,this.a1.z+=m*this.a1z,this.a2.x-=m*this.a2x,this.a2.y-=m*this.a2y,this.a2.z-=m*this.a2z},solve:function(){var t,i=this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z);if(this.enableMotor){t=(i-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),t=this.motorImpulse-s,i-=t*this.motorDenom}else t=0;var h;if(2!=this.limitState){h=(i-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var o=h+t;this.a1.x+=o*this.a1x,this.a1.y+=o*this.a1y,this.a1.z+=o*this.a1z,this.a2.x-=o*this.a2x,this.a2.y-=o*this.a2y,this.a2.z-=o*this.a2z}},e.Translational3Constraint=function(t,i,s,h){this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x1=NaN,this.t1y1=NaN,this.t1z1=NaN,this.t2x1=NaN,this.t2y1=NaN,this.t2z1=NaN,this.l1x1=NaN,this.l1y1=NaN,this.l1z1=NaN,this.l2x1=NaN,this.l2y1=NaN,this.l2z1=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.t1x2=NaN,this.t1y2=NaN,this.t1z2=NaN,this.t2x2=NaN,this.t2y2=NaN,this.t2z2=NaN,this.l1x2=NaN,this.l1y2=NaN,this.l1z2=NaN,this.l2x2=NaN,this.l2y2=NaN,this.l2z2=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.t1x3=NaN,this.t1y3=NaN,this.t1z3=NaN,this.t2x3=NaN,this.t2y3=NaN,this.t2z3=NaN,this.l1x3=NaN,this.l1y3=NaN,this.l1z3=NaN,this.l2x3=NaN,this.l2y3=NaN,this.l2z3=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=s,this.limitMotor3=h,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0,this.cfm1=0,this.cfm2=0,this.cfm3=0,this.weight=-1},e.Translational3Constraint.prototype={constructor:e.Translational3Constraint,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,o=this.p2.y-this.p1.y,a=this.p2.z-this.p1.z,n=e*this.ax1+o*this.ay1+a*this.az1,r=e*this.ax2+o*this.ay2+a*this.az2,l=e*this.ax3+o*this.ay3+a*this.az3,c=this.limitMotor1.frequency,m=this.limitMotor2.frequency,p=this.limitMotor3.frequency,u=c>0,x=m>0,y=p>0,d=this.lowerLimit1<=this.upperLimit1,N=this.lowerLimit2<=this.upperLimit2,f=this.lowerLimit3<=this.upperLimit3;(u&&n>20||n<-20)&&(u=!1),(x&&r>20||r<-20)&&(x=!1),(y&&l>20||l<-20)&&(y=!1),d?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,u||(n=this.lowerLimit1)):n<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,u||(n=this.lowerLimit1)):n>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-n,u||(n=this.upperLimit1)):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),u||(this.limitVelocity1>.005?this.limitVelocity1-=.005:this.limitVelocity1<-.005?this.limitVelocity1+=.005:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0),N?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,x||(r=this.lowerLimit2)):r<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,x||(r=this.lowerLimit2)):r>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-r,x||(r=this.upperLimit2)):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),x||(this.limitVelocity2>.005?this.limitVelocity2-=.005:this.limitVelocity2<-.005?this.limitVelocity2+=.005:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0),f?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,y||(l=this.lowerLimit3)):l<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,y||(l=this.lowerLimit3)):l>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-l,y||(l=this.upperLimit3)):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),y||(this.limitVelocity3>.005?this.limitVelocity3-=.005:this.limitVelocity3<-.005?this.limitVelocity3+=.005:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||u)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||x)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||y)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0);var z=n*this.ax1+r*this.ax2+l*this.ax2,v=n*this.ay1+r*this.ay2+l*this.ay2,b=n*this.az1+r*this.az2+l*this.az2,A=this.m2/(this.m1+this.m2);this.weight>=0&&(A=this.weight);var k=1-A;this.r1x=this.r1.x+z*A,this.r1y=this.r1.y+v*A,this.r1z=this.r1.z+b*A,this.r2x=this.r2.x-z*k,this.r2y=this.r2.y-v*k,this.r2z=this.r2.z-b*k,this.t1x1=this.r1y*this.az1-this.r1z*this.ay1,this.t1y1=this.r1z*this.ax1-this.r1x*this.az1,this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1,this.t2x1=this.r2y*this.az1-this.r2z*this.ay1,this.t2y1=this.r2z*this.ax1-this.r2x*this.az1,this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1,this.l1x1=this.ax1*this.m1,this.l1y1=this.ay1*this.m1,this.l1z1=this.az1*this.m1,this.l2x1=this.ax1*this.m2,this.l2y1=this.ay1*this.m2,this.l2z1=this.az1*this.m2,this.a1x1=this.t1x1*this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02,this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12,this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22,this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02,this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12,this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22,this.t1x2=this.r1y*this.az2-this.r1z*this.ay2,this.t1y2=this.r1z*this.ax2-this.r1x*this.az2,this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2,this.t2x2=this.r2y*this.az2-this.r2z*this.ay2,this.t2y2=this.r2z*this.ax2-this.r2x*this.az2,this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2,this.l1x2=this.ax2*this.m1,this.l1y2=this.ay2*this.m1,this.l1z2=this.az2*this.m1,this.l2x2=this.ax2*this.m2,this.l2y2=this.ay2*this.m2,this.l2z2=this.az2*this.m2,this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02,this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12,this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22,this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02,this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12,this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22,this.t1x3=this.r1y*this.az3-this.r1z*this.ay3,this.t1y3=this.r1z*this.ax3-this.r1x*this.az3,this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3,this.t2x3=this.r2y*this.az3-this.r2z*this.ay3,this.t2y3=this.r2z*this.ax3-this.r2x*this.az3,this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3,this.l1x3=this.ax3*this.m1,this.l1y3=this.ay3*this.m1,this.l1z3=this.az3*this.m1,this.l2x3=this.ax3*this.m2,this.l2y3=this.ay3*this.m2,this.l2z3=this.az3*this.m2,this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02,this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12,this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22,this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*this.i2e02,this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12,this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;var S=this.m1+this.m2;if(this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*S,this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*S,this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*S,this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*S,this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*S,this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*S,this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*S,this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*S,this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*S,this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1,this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2,this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3,this.k10+=this.t1x2*this.a1x1+this.t1y2*this.a1y1+this.t1z2*this.a1z1,this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2,this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3,this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1,this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2,this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3,this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1,this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+this.t2z1*this.a2z2,this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3,this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1,this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2,this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3,this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1,this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2,this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3,this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,u&&2!=this.limitState1){var g=6.2831853*c,P=g*g*t,I=i/(P+2*this.limitMotor1.dampingRatio*g);this.cfm1=this.kv00*I,this.limitVelocity1*=P*I}else this.cfm1=0,this.limitVelocity1*=.05*i;x&&2!=this.limitState2?(g=6.2831853*m,P=g*g*t,I=i/(P+2*this.limitMotor2.dampingRatio*g),this.cfm2=this.kv11*I,this.limitVelocity2*=P*I):(this.cfm2=0,this.limitVelocity2*=.05*i),y&&2!=this.limitState3?(g=6.2831853*p,P=g*g*t,I=i/(P+2*this.limitMotor3.dampingRatio*g),this.cfm3=this.kv22*I,this.limitVelocity3*=P*I):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var w=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*w,this.d01=(this.k02*this.k21-this.k01*this.k22)*w,this.d02=(this.k01*this.k12-this.k02*this.k11)*w,this.d10=(this.k12*this.k20-this.k10*this.k22)*w,this.d11=(this.k00*this.k22-this.k02*this.k20)*w,this.d12=(this.k02*this.k10-this.k00*this.k12)*w,this.d20=(this.k10*this.k21-this.k11*this.k20)*w,this.d21=(this.k01*this.k20-this.k00*this.k21)*w,this.d22=(this.k00*this.k11-this.k01*this.k10)*w;var L=this.limitImpulse1+this.motorImpulse1,M=this.limitImpulse2+this.motorImpulse2,V=this.limitImpulse3+this.motorImpulse3;this.l1.x+=L*this.l1x1+M*this.l1x2+V*this.l1x3,this.l1.y+=L*this.l1y1+M*this.l1y2+V*this.l1y3,this.l1.z+=L*this.l1z1+M*this.l1z2+V*this.l1z3,this.a1.x+=L*this.a1x1+M*this.a1x2+V*this.a1x3,this.a1.y+=L*this.a1y1+M*this.a1y2+V*this.a1y3,this.a1.z+=L*this.a1z1+M*this.a1z2+V*this.a1z3,this.l2.x-=L*this.l2x1+M*this.l2x2+V*this.l2x3,this.l2.y-=L*this.l2y1+M*this.l2y2+V*this.l2y3,this.l2.z-=L*this.l2z1+M*this.l2z2+V*this.l2z3,this.a2.x-=L*this.a2x1+M*this.a2x2+V*this.a2x3,this.a2.y-=L*this.a2y1+M*this.a2y2+V*this.a2y3,this.a2.z-=L*this.a2z1+M*this.a2z2+V*this.a2z3},solve:function(){var t=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,i=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,s=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,h=t*this.ax1+i*this.ay1+s*this.az1,e=t*this.ax2+i*this.ay2+s*this.az2,o=t*this.ax3+i*this.ay3+s*this.az3,a=this.motorImpulse1,n=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-a),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-n),this.enableMotor3&&(m=(o-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,o+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,o-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,u=this.limitImpulse2,x=this.limitImpulse3,y=h*this.d00+e*this.d01+o*this.d02,d=h*this.d10+e*this.d11+o*this.d12,N=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=y,this.limitImpulse2+=d,this.limitImpulse3+=N;var f=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(y=-p,e+=y*this.k10,o+=y*this.k20,f|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(d=-u,h+=d*this.k01,o+=d*this.k21,f|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(N=-x,h+=N*this.k02,e+=N*this.k12,f|=4);var z;switch(f){case 1:z=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*o)*z,N=(-this.k21*e+this.k11*o)*z;break;case 2:z=1/(this.k00*this.k22-this.k02*this.k20),y=(this.k22*h+-this.k02*o)*z,N=(-this.k20*h+this.k00*o)*z;break;case 3:N=o/this.k22;break;case 4:z=1/(this.k00*this.k11-this.k01*this.k10),y=(this.k11*h+-this.k01*e)*z,d=(-this.k10*h+this.k00*e)*z;break;case 5:d=e/this.k11;break;case 6:y=h/this.k00}this.limitImpulse1=p+y,this.limitImpulse2=u+d,this.limitImpulse3=x+N;var v=l+y,b=c+d,A=m+N;this.l1.x+=v*this.l1x1+b*this.l1x2+A*this.l1x3,this.l1.y+=v*this.l1y1+b*this.l1y2+A*this.l1y3,this.l1.z+=v*this.l1z1+b*this.l1z2+A*this.l1z3,this.a1.x+=v*this.a1x1+b*this.a1x2+A*this.a1x3,this.a1.y+=v*this.a1y1+b*this.a1y2+A*this.a1y3,this.a1.z+=v*this.a1z1+b*this.a1z2+A*this.a1z3,this.l2.x-=v*this.l2x1+b*this.l2x2+A*this.l2x3,this.l2.y-=v*this.l2y1+b*this.l2y2+A*this.l2y3,this.l2.z-=v*this.l2z1+b*this.l2z2+A*this.l2z3,this.a2.x-=v*this.a2x1+b*this.a2x2+A*this.a2x3,this.a2.y-=v*this.a2y1+b*this.a2y2+A*this.a2y3,this.a2.z-=v*this.a2z1+b*this.a2z2+A*this.a2z3}},e.TranslationalConstraint=function(t,i){this.cfm=NaN,this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x=NaN,this.t1y=NaN,this.t1z=NaN,this.t2x=NaN,this.t2y=NaN,this.t2z=NaN,this.l1x=NaN,this.l1y=NaN,this.l1z=NaN,this.l2x=NaN,this.l2y=NaN,this.l2z=NaN,this.a1x=NaN,
this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=i,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0},e.TranslationalConstraint.prototype={constructor:e.TranslationalConstraint,preSolve:function(t,i){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,o=this.p2.y-this.p1.y,a=this.p2.z-this.p1.z,n=e*this.ax+o*this.ay+a*this.az,r=this.limitMotor.frequency,l=r>0,c=this.lowerLimit<=this.upperLimit;(l&&n>20||n<-20)&&(l=!1),c?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,l||(n=this.lowerLimit)):n<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,l||(n=this.lowerLimit)):n>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-n,l||(n=this.upperLimit)):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),l||(this.limitVelocity>.005?this.limitVelocity-=.005:this.limitVelocity<-.005?this.limitVelocity+=.005:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||l)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0);var m=n*this.ax,p=n*this.ay,u=n*this.az,x=this.m1/(this.m1+this.m2),y=1-x;if(this.r1x=this.r1.x+m*x,this.r1y=this.r1.y+p*x,this.r1z=this.r1.z+u*x,this.r2x=this.r2.x-m*y,this.r2y=this.r2.y-p*y,this.r2z=this.r2.z-u*y,this.t1x=this.r1y*this.az-this.r1z*this.ay,this.t1y=this.r1z*this.ax-this.r1x*this.az,this.t1z=this.r1x*this.ay-this.r1y*this.ax,this.t2x=this.r2y*this.az-this.r2z*this.ay,this.t2y=this.r2z*this.ax-this.r2x*this.az,this.t2z=this.r2x*this.ay-this.r2y*this.ax,this.l1x=this.ax*this.m1,this.l1y=this.ay*this.m1,this.l1z=this.az*this.m1,this.l2x=this.ax*this.m2,this.l2y=this.ay*this.m2,this.l2z=this.az*this.m2,this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02,this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12,this.a1z=this.t1x*this.i1e20+this.t1y*this.i1e21+this.t1z*this.i1e22,this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02,this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12,this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22,this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-this.a2y*this.r2x),this.invMotorDenom=1/this.motorDenom,l&&2!=this.limitState){var d=6.2831853*r,N=d*d*t,f=i/(N+2*this.limitMotor.dampingRatio*d);this.cfm=this.motorDenom*f,this.limitVelocity*=N*f}else this.cfm=0,this.limitVelocity*=.05*i;this.invDenom=1/(this.motorDenom+this.cfm);var z=this.limitImpulse+this.motorImpulse;this.l1.x+=z*this.l1x,this.l1.y+=z*this.l1y,this.l1.z+=z*this.l1z,this.a1.x+=z*this.a1x,this.a1.y+=z*this.a1y,this.a1.z+=z*this.a1z,this.l2.x-=z*this.l2x,this.l2.y-=z*this.l2y,this.l2.z-=z*this.l2z,this.a2.x-=z*this.a2x,this.a2.y-=z*this.a2y,this.a2.z-=z*this.a2z},solve:function(){var t,i=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z;if(this.enableMotor){t=(i-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),t=this.motorImpulse-s,i-=t*this.motorDenom}else t=0;var h;if(2!=this.limitState){h=(i-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var o=h+t;this.l1.x+=o*this.l1x,this.l1.y+=o*this.l1y,this.l1.z+=o*this.l1z,this.a1.x+=o*this.a1x,this.a1.y+=o*this.a1y,this.a1.z+=o*this.a1z,this.l2.x-=o*this.l2x,this.l2.y-=o*this.l2y,this.l2.z-=o*this.l2z,this.a2.x-=o*this.a2x,this.a2.y-=o*this.a2y,this.a2.z-=o*this.a2z}},e.Contact=function(){this.shape1=null,this.shape2=null,this.body1=null,this.body2=null,this.prev=null,this.next=null,this.persisting=!1,this.sleeping=!1,this.detector=null,this.constraint=null,this.touching=!1,this.b1Link=new e.ContactLink(this),this.b2Link=new e.ContactLink(this),this.s1Link=new e.ContactLink(this),this.s2Link=new e.ContactLink(this),this.manifold=new e.ContactManifold,this.buffer=[],this.buffer.length=4,this.buffer[0]=new e.ImpulseDataBuffer,this.buffer[1]=new e.ImpulseDataBuffer,this.buffer[2]=new e.ImpulseDataBuffer,this.buffer[3]=new e.ImpulseDataBuffer,this.points=this.manifold.points,this.constraint=new e.ContactConstraint(this.manifold)},e.Contact.prototype={constructor:e.Contact,mixRestitution:function(t,i){return e.sqrt(t*i)},mixFriction:function(t,i){return e.sqrt(t*i)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution),this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var t=this.manifold.numPoints,i=t;i--;){var s=this.buffer[i],h=this.points[i];s.lp1X=h.localPoint1.x,s.lp1Y=h.localPoint1.y,s.lp1Z=h.localPoint1.z,s.lp2X=h.localPoint2.x,s.lp2Y=h.localPoint2.y,s.lp2Z=h.localPoint2.z,s.impulse=h.normalImpulse}this.manifold.numPoints=0,this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var e=this.manifold.numPoints;if(0==e)return void(this.touching=!1);for(this.touching=!0,i=e;i--;){h=this.points[i];for(var o=h.localPoint1.x,a=h.localPoint1.y,n=h.localPoint1.z,r=h.localPoint2.x,l=h.localPoint2.y,c=h.localPoint2.z,m=-1,p=4e-4,u=t;u--;){s=this.buffer[u];var x=s.lp1X-o,y=s.lp1Y-a,d=s.lp1Z-n,N=x*x+y*y+d*d;x=s.lp2X-r,y=s.lp2Y-l,d=s.lp2Z-c;var f=x*x+y*y+d*d;N<f?N<p&&(p=N,m=u):f<p&&(p=f,m=u)}if(m!=-1){var z=this.buffer[m];this.buffer[m]=this.buffer[--t],this.buffer[t]=z,h.normalImpulse=z.impulse,h.warmStarted=!0}else h.normalImpulse=0,h.warmStarted=!1}},attach:function(t,i){this.shape1=t,this.shape2=i,this.body1=t.parent,this.body2=i.parent,this.manifold.body1=this.body1,this.manifold.body2=this.body2,this.constraint.body1=this.body1,this.constraint.body2=this.body2,this.constraint.attach(),this.s1Link.shape=i,this.s1Link.body=this.body2,this.s2Link.shape=t,this.s2Link.body=this.body1,null!=t.contactLink?(this.s1Link.next=t.contactLink).prev=this.s1Link:this.s1Link.next=null,t.contactLink=this.s1Link,t.numContacts++,null!=i.contactLink?(this.s2Link.next=i.contactLink).prev=this.s2Link:this.s2Link.next=null,i.contactLink=this.s2Link,i.numContacts++,this.b1Link.shape=i,this.b1Link.body=this.body2,this.b2Link.shape=t,this.b2Link.body=this.body1,null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:this.b1Link.next=null,this.body1.contactLink=this.b1Link,this.body1.numContacts++,null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null,this.body2.contactLink=this.b2Link,this.body2.numContacts++,this.prev=null,this.next=null,this.persisting=!0,this.sleeping=this.body1.sleeping&&this.body2.sleeping,this.manifold.numPoints=0},detach:function(){var t=this.s1Link.prev,i=this.s1Link.next;null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape1.contactLink==this.s1Link&&(this.shape1.contactLink=i),this.s1Link.prev=null,this.s1Link.next=null,this.s1Link.shape=null,this.s1Link.body=null,this.shape1.numContacts--,t=this.s2Link.prev,i=this.s2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=i),this.s2Link.prev=null,this.s2Link.next=null,this.s2Link.shape=null,this.s2Link.body=null,this.shape2.numContacts--,t=this.b1Link.prev,i=this.b1Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body1.contactLink==this.b1Link&&(this.body1.contactLink=i),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.shape=null,this.b1Link.body=null,this.body1.numContacts--,t=this.b2Link.prev,i=this.b2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body2.contactLink==this.b2Link&&(this.body2.contactLink=i),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.shape=null,this.b2Link.body=null,this.body2.numContacts--,this.manifold.body1=null,this.manifold.body2=null,this.constraint.body1=null,this.constraint.body2=null,this.constraint.detach(),this.shape1=null,this.shape2=null,this.body1=null,this.body2=null}},e.ContactConstraint=function(t){e.Constraint.call(this),this.manifold=t,this.restitution=NaN,this.friction=NaN,this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null,this.ii1=null,this.ii2=null,this.m1=NaN,this.m2=NaN,this.num=0,this.ps=t.points,this.cs=new e.ContactPointDataBuffer,this.cs.next=new e.ContactPointDataBuffer,this.cs.next.next=new e.ContactPointDataBuffer,this.cs.next.next.next=new e.ContactPointDataBuffer},e.ContactConstraint.prototype=Object.create(e.Constraint.prototype),e.ContactConstraint.prototype.attach=function(){this.p1=this.body1.position,this.p2=this.body2.position,this.lv1=this.body1.linearVelocity,this.av1=this.body1.angularVelocity,this.lv2=this.body2.linearVelocity,this.av2=this.body2.angularVelocity,this.i1=this.body1.inverseInertia,this.i2=this.body2.inverseInertia},e.ContactConstraint.prototype.detach=function(){this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null},e.ContactConstraint.prototype.preSolve=function(t,i){this.m1=this.body1.inverseMass,this.m2=this.body2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,h=this.ii2.elements,o=this.p1.x,a=this.p1.y,n=this.p1.z,r=this.p2.x,l=this.p2.y,c=this.p2.z,m=this.m1+this.m2;this.num=this.manifold.numPoints;for(var p=this.cs,u=0;u<this.num;u++){var x,y,d,N,f,z,v=this.ps[u];x=v.position.x,y=v.position.y,d=v.position.z;var b=x-o,A=y-a,k=d-n,S=x-r,g=y-l,P=d-c;p.rp1X=b,p.rp1Y=A,p.rp1Z=k,p.rp2X=S,p.rp2Y=g,p.rp2Z=P,p.norImp=v.normalImpulse,p.tanImp=v.tangentImpulse,p.binImp=v.binormalImpulse;var I=v.normal.x,w=v.normal.y,L=v.normal.z,M=this.lv2.x+this.av2.y*P-this.av2.z*g-(this.lv1.x+this.av1.y*k-this.av1.z*A),V=this.lv2.y+this.av2.z*S-this.av2.x*P-(this.lv1.y+this.av1.z*b-this.av1.x*k),C=this.lv2.z+this.av2.x*g-this.av2.y*S-(this.lv1.z+this.av1.x*A-this.av1.y*b),T=I*M+w*V+L*C,D=M-T*I,B=V-T*w,E=C-T*L,_=D*D+B*B+E*E;_>.04?_=1/e.sqrt(_):(D=w*I-L*L,B=-L*w-I*I,E=I*L+w*w,_=1/e.sqrt(D*D+B*B+E*E)),D*=_,B*=_,E*=_;var Y=w*E-L*B,X=L*D-I*E,Z=I*B-w*D;p.norX=I,p.norY=w,p.norZ=L,p.tanX=D,p.tanY=B,p.tanZ=E,p.binX=Y,p.binY=X,p.binZ=Z,p.norU1X=I*this.m1,p.norU1Y=w*this.m1,p.norU1Z=L*this.m1,p.norU2X=I*this.m2,p.norU2Y=w*this.m2,p.norU2Z=L*this.m2,p.tanU1X=D*this.m1,p.tanU1Y=B*this.m1,p.tanU1Z=E*this.m1,p.tanU2X=D*this.m2,p.tanU2Y=B*this.m2,p.tanU2Z=E*this.m2,p.binU1X=Y*this.m1,p.binU1Y=X*this.m1,p.binU1Z=Z*this.m1,p.binU2X=Y*this.m2,p.binU2Y=X*this.m2,p.binU2Z=Z*this.m2;var R=A*L-k*w,U=k*I-b*L,O=b*w-A*I,J=g*L-P*w,q=P*I-S*L,F=S*w-g*I,j=A*E-k*B,H=k*D-b*E,W=b*B-A*D,Q=g*E-P*B,G=P*D-S*E,K=S*B-g*D,$=A*Z-k*X,tt=k*Y-b*Z,it=b*X-A*Y,st=g*Z-P*X,ht=P*Y-S*Z,et=S*X-g*Y,ot=R*s[0]+U*s[1]+O*s[2],at=R*s[3]+U*s[4]+O*s[5],nt=R*s[6]+U*s[7]+O*s[8],rt=J*h[0]+q*h[1]+F*h[2],lt=J*h[3]+q*h[4]+F*h[5],ct=J*h[6]+q*h[7]+F*h[8],mt=j*s[0]+H*s[1]+W*s[2],pt=j*s[3]+H*s[4]+W*s[5],ut=j*s[6]+H*s[7]+W*s[8],xt=Q*h[0]+G*h[1]+K*h[2],yt=Q*h[3]+G*h[4]+K*h[5],dt=Q*h[6]+G*h[7]+K*h[8],Nt=$*s[0]+tt*s[1]+it*s[2],ft=$*s[3]+tt*s[4]+it*s[5],zt=$*s[6]+tt*s[7]+it*s[8],vt=st*h[0]+ht*h[1]+et*h[2],bt=st*h[3]+ht*h[4]+et*h[5],At=st*h[6]+ht*h[7]+et*h[8];p.norT1X=R,p.norT1Y=U,p.norT1Z=O,p.tanT1X=j,p.tanT1Y=H,p.tanT1Z=W,p.binT1X=$,p.binT1Y=tt,p.binT1Z=it,p.norT2X=J,p.norT2Y=q,p.norT2Z=F,p.tanT2X=Q,p.tanT2Y=G,p.tanT2Z=K,p.binT2X=st,p.binT2Y=ht,p.binT2Z=et,p.norTU1X=ot,p.norTU1Y=at,p.norTU1Z=nt,p.tanTU1X=mt,p.tanTU1Y=pt,p.tanTU1Z=ut,p.binTU1X=Nt,p.binTU1Y=ft,p.binTU1Z=zt,p.norTU2X=rt,p.norTU2Y=lt,p.norTU2Z=ct,p.tanTU2X=xt,p.tanTU2Y=yt,p.tanTU2Z=dt,p.binTU2X=vt,p.binTU2Y=bt,p.binTU2Z=At,x=R*s[0]+U*s[1]+O*s[2],y=R*s[3]+U*s[4]+O*s[5],d=R*s[6]+U*s[7]+O*s[8],N=y*k-d*A,f=d*b-x*k,z=x*A-y*b,x=J*h[0]+q*h[1]+F*h[2],y=J*h[3]+q*h[4]+F*h[5],d=J*h[6]+q*h[7]+F*h[8],N+=y*P-d*g,f+=d*S-x*P,z+=x*g-y*S;var kt=1/(m+I*N+w*f+L*z);x=j*s[0]+H*s[1]+W*s[2],y=j*s[3]+H*s[4]+W*s[5],d=j*s[6]+H*s[7]+W*s[8],N=y*k-d*A,f=d*b-x*k,z=x*A-y*b,x=Q*h[0]+G*h[1]+K*h[2],y=Q*h[3]+G*h[4]+K*h[5],d=Q*h[6]+G*h[7]+K*h[8],N+=y*P-d*g,f+=d*S-x*P,z+=x*g-y*S;var St=1/(m+D*N+B*f+E*z);x=$*s[0]+tt*s[1]+it*s[2],y=$*s[3]+tt*s[4]+it*s[5],d=$*s[6]+tt*s[7]+it*s[8],N=y*k-d*A,f=d*b-x*k,z=x*A-y*b,x=st*h[0]+ht*h[1]+et*h[2],y=st*h[3]+ht*h[4]+et*h[5],d=st*h[6]+ht*h[7]+et*h[8],N+=y*P-d*g,f+=d*S-x*P,z+=x*g-y*S;var gt=1/(m+Y*N+X*f+Z*z);if(p.norDen=kt,p.tanDen=St,p.binDen=gt,v.warmStarted){var Pt=v.normalImpulse;this.lv1.x+=p.norU1X*Pt,this.lv1.y+=p.norU1Y*Pt,this.lv1.z+=p.norU1Z*Pt,this.av1.x+=ot*Pt,this.av1.y+=at*Pt,this.av1.z+=nt*Pt,this.lv2.x-=p.norU2X*Pt,this.lv2.y-=p.norU2Y*Pt,this.lv2.z-=p.norU2Z*Pt,this.av2.x-=rt*Pt,this.av2.y-=lt*Pt,this.av2.z-=ct*Pt,p.norImp=Pt,p.tanImp=0,p.binImp=0,T=0}else p.norImp=0,p.tanImp=0,p.binImp=0;T>-1&&(T=0);var It=this.restitution*-T,wt=-(v.penetration+.005)*i*.05;It<wt&&(It=wt),p.norTar=It,p.last=u==this.num-1,p=p.next}},e.ContactConstraint.prototype.solve=function(){for(var t=this.lv1.x,i=this.lv1.y,s=this.lv1.z,h=this.lv2.x,o=this.lv2.y,a=this.lv2.z,n=this.av1.x,r=this.av1.y,l=this.av1.z,c=this.av2.x,m=this.av2.y,p=this.av2.z,u=this.cs;;){var x,y,d,N,f,z=u.norImp,v=u.tanImp,b=u.binImp,A=-z*this.friction,k=h-t,S=o-i,g=a-s;f=k*u.tanX+S*u.tanY+g*u.tanZ+c*u.tanT2X+m*u.tanT2Y+p*u.tanT2Z-n*u.tanT1X-r*u.tanT1Y-l*u.tanT1Z,x=v,y=f*u.tanDen,v+=y,f=k*u.binX+S*u.binY+g*u.binZ+c*u.binT2X+m*u.binT2Y+p*u.binT2Z-n*u.binT1X-r*u.binT1Y-l*u.binT1Z,d=b,N=f*u.binDen,b+=N;var P=v*v+b*b;if(P>A*A&&(P=A/e.sqrt(P),v*=P,b*=P),y=v-x,N=b-d,t+=u.tanU1X*y+u.binU1X*N,i+=u.tanU1Y*y+u.binU1Y*N,s+=u.tanU1Z*y+u.binU1Z*N,n+=u.tanTU1X*y+u.binTU1X*N,r+=u.tanTU1Y*y+u.binTU1Y*N,l+=u.tanTU1Z*y+u.binTU1Z*N,h-=u.tanU2X*y+u.binU2X*N,o-=u.tanU2Y*y+u.binU2Y*N,a-=u.tanU2Z*y+u.binU2Z*N,c-=u.tanTU2X*y+u.binTU2X*N,m-=u.tanTU2Y*y+u.binTU2Y*N,p-=u.tanTU2Z*y+u.binTU2Z*N,f=(h-t)*u.norX+(o-i)*u.norY+(a-s)*u.norZ+c*u.norT2X+m*u.norT2Y+p*u.norT2Z-n*u.norT1X-r*u.norT1Y-l*u.norT1Z,x=z,y=(f-u.norTar)*u.norDen,z+=y,z>0&&(z=0),y=z-x,t+=u.norU1X*y,i+=u.norU1Y*y,s+=u.norU1Z*y,n+=u.norTU1X*y,r+=u.norTU1Y*y,l+=u.norTU1Z*y,h-=u.norU2X*y,o-=u.norU2Y*y,a-=u.norU2Z*y,c-=u.norTU2X*y,m-=u.norTU2Y*y,p-=u.norTU2Z*y,u.norImp=z,u.tanImp=v,u.binImp=b,u.last)break;u=u.next}this.lv1.x=t,this.lv1.y=i,this.lv1.z=s,this.lv2.x=h,this.lv2.y=o,this.lv2.z=a,this.av1.x=n,this.av1.y=r,this.av1.z=l,this.av2.x=c,this.av2.y=m,this.av2.z=p},e.ContactConstraint.prototype.postSolve=function(){for(var t=this.cs,i=this.num;i--;){var s=this.ps[i];s.normal.x=t.norX,s.normal.y=t.norY,s.normal.z=t.norZ,s.tangent.x=t.tanX,s.tangent.y=t.tanY,s.tangent.z=t.tanZ,s.binormal.x=t.binX,s.binormal.y=t.binY,s.binormal.z=t.binZ,s.normalImpulse=t.norImp,s.tangentImpulse=t.tanImp,s.binormalImpulse=t.binImp,s.normalDenominator=t.norDen,s.tangentDenominator=t.tanDen,s.binormalDenominator=t.binDen,t=t.next}},e.ContactLink=function(t){this.prev=null,this.next=null,this.shape=null,this.body=null,this.contact=t},e.ContactManifold=function(){this.body1=null,this.body2=null,this.numPoints=0,this.points=[],this.points.length=4,this.points[0]=new e.ManifoldPoint,this.points[1]=new e.ManifoldPoint,this.points[2]=new e.ManifoldPoint,this.points[3]=new e.ManifoldPoint},e.ContactManifold.prototype={constructor:e.ContactManifold,reset:function(t,i){this.body1=t.parent,this.body2=i.parent,this.numPoints=0},addPoint:function(t,i,s,h,e,o,a,n){var r=this.points[this.numPoints++];r.position.x=t,r.position.y=i,r.position.z=s;var l=this.body1.rotation,c=t-this.body1.position.x,m=i-this.body1.position.y,p=s-this.body1.position.z,u=l.elements;r.localPoint1.x=c*u[0]+m*u[3]+p*u[6],r.localPoint1.y=c*u[1]+m*u[4]+p*u[7],r.localPoint1.z=c*u[2]+m*u[5]+p*u[8],l=this.body2.rotation,c=t-this.body2.position.x,m=i-this.body2.position.y,p=s-this.body2.position.z,r.localPoint2.x=c*u[0]+m*u[3]+p*u[6],r.localPoint2.y=c*u[1]+m*u[4]+p*u[7],r.localPoint2.z=c*u[2]+m*u[5]+p*u[8],r.normalImpulse=0,n?(r.normal.x=-h,r.normal.y=-e,r.normal.z=-o):(r.normal.x=h,r.normal.y=e,r.normal.z=o),r.penetration=a,r.warmStarted=!1}},e.ContactPointDataBuffer=function(){this.norX=NaN,this.norY=NaN,this.norZ=NaN,this.tanX=NaN,this.tanY=NaN,this.tanZ=NaN,this.binX=NaN,this.binY=NaN,this.binZ=NaN,this.rp1X=NaN,this.rp1Y=NaN,this.rp1Z=NaN,this.rp2X=NaN,this.rp2Y=NaN,this.rp2Z=NaN,this.norU1X=NaN,this.norU1Y=NaN,this.norU1Z=NaN,this.norU2X=NaN,this.norU2Y=NaN,this.norU2Z=NaN,this.tanU1X=NaN,this.tanU1Y=NaN,this.tanU1Z=NaN,this.tanU2X=NaN,this.tanU2Y=NaN,this.tanU2Z=NaN,this.binU1X=NaN,this.binU1Y=NaN,this.binU1Z=NaN,this.binU2X=NaN,this.binU2Y=NaN,this.binU2Z=NaN,this.norT1X=NaN,this.norT1Y=NaN,this.norT1Z=NaN,this.norT2X=NaN,this.norT2Y=NaN,this.norT2Z=NaN,this.tanT1X=NaN,this.tanT1Y=NaN,this.tanT1Z=NaN,this.tanT2X=NaN,this.tanT2Y=NaN,this.tanT2Z=NaN,this.binT1X=NaN,this.binT1Y=NaN,this.binT1Z=NaN,this.binT2X=NaN,this.binT2Y=NaN,this.binT2Z=NaN,this.norTU1X=NaN,this.norTU1Y=NaN,this.norTU1Z=NaN,this.norTU2X=NaN,this.norTU2Y=NaN,this.norTU2Z=NaN,this.tanTU1X=NaN,this.tanTU1Y=NaN,this.tanTU1Z=NaN,this.tanTU2X=NaN,this.tanTU2Y=NaN,this.tanTU2Z=NaN,this.binTU1X=NaN,this.binTU1Y=NaN,this.binTU1Z=NaN,this.binTU2X=NaN,this.binTU2Y=NaN,this.binTU2Z=NaN,this.norImp=NaN,this.tanImp=NaN,this.binImp=NaN,this.norDen=NaN,this.tanDen=NaN,this.binDen=NaN,this.norTar=NaN,this.next=null,this.last=!1},e.ImpulseDataBuffer=function(){this.lp1X=NaN,this.lp1Y=NaN,this.lp1Z=NaN,this.lp2X=NaN,this.lp2Y=NaN,this.lp2Z=NaN,this.impulse=NaN},e.ManifoldPoint=function(){this.warmStarted=!1,this.position=new e.Vec3,this.localPoint1=new e.Vec3,this.localPoint2=new e.Vec3,this.normal=new e.Vec3,this.tangent=new e.Vec3,this.binormal=new e.Vec3,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0,this.normalDenominator=0,this.tangentDenominator=0,this.binormalDenominator=0,this.penetration=0},e.MassInfo=function(){this.mass=0,this.inertia=new e.Mat33},e.Shape=function(t){this.type=e.SHAPE_NULL,this.id=e.nextID++,this.prev=null,this.next=null,this.proxy=null,this.parent=null,this.contactLink=null,this.numContacts=0,this.position=new e.Vec3,this.rotation=new e.Mat33,this.relativePosition=(new e.Vec3).copy(t.relativePosition),this.relativeRotation=(new e.Mat33).copy(t.relativeRotation),this.aabb=new e.AABB,this.density=t.density,this.friction=t.friction,this.restitution=t.restitution,this.belongsTo=t.belongsTo,this.collidesWith=t.collidesWith},e.Shape.prototype={constructor:e.Shape,calculateMassInfo:function(t){e.Error("Shape","Inheritance error.")},updateProxy:function(){e.Error("Shape","Inheritance error.")}},e.ShapeConfig=function(){this.relativePosition=new e.Vec3,this.relativeRotation=new e.Mat33,this.friction=.4,this.restitution=.2,this.density=1,this.belongsTo=1,this.collidesWith=4294967295},e.BoxShape=function(t,i,s,o){e.Shape.call(this,t),this.type=e.SHAPE_BOX,this.width=i,this.height=s,this.depth=o,this.halfWidth=.5*i,this.halfHeight=.5*s,this.halfDepth=.5*o,this.dimentions=new h(18),this.elements=new h(24)},e.BoxShape.prototype=Object.create(e.Shape.prototype),e.BoxShape.prototype.constructor=e.BoxShape,e.BoxShape.prototype.calculateMassInfo=function(t){var i=this.width*this.height*this.depth*this.density,s=1/12;t.mass=i,t.inertia.set(i*(this.height*this.height+this.depth*this.depth)*s,0,0,0,i*(this.width*this.width+this.depth*this.depth)*s,0,0,0,i*(this.width*this.width+this.height*this.height)*s)},e.BoxShape.prototype.updateProxy=function(){var t=this.rotation.elements,i=this.dimentions;i[0]=t[0],i[1]=t[3],i[2]=t[6],i[3]=t[1],i[4]=t[4],i[5]=t[7],i[6]=t[2],i[7]=t[5],i[8]=t[8],i[9]=t[0]*this.halfWidth,i[10]=t[3]*this.halfWidth,i[11]=t[6]*this.halfWidth,i[12]=t[1]*this.halfHeight,i[13]=t[4]*this.halfHeight,i[14]=t[7]*this.halfHeight,i[15]=t[2]*this.halfDepth,i[16]=t[5]*this.halfDepth,i[17]=t[8]*this.halfDepth;var s=i[9],h=i[10],o=i[11],a=i[12],n=i[13],r=i[14],l=i[15],c=i[16],m=i[17],p=this.position.x,u=this.position.y,x=this.position.z,y=this.elements;y[0]=p+s+a+l,y[1]=u+h+n+c,y[2]=x+o+r+m,y[3]=p+s+a-l,y[4]=u+h+n-c,y[5]=x+o+r-m,y[6]=p+s-a+l,y[7]=u+h-n+c,y[8]=x+o-r+m,y[9]=p+s-a-l,y[10]=u+h-n-c,y[11]=x+o-r-m,y[12]=p-s+a+l,y[13]=u-h+n+c,y[14]=x-o+r+m,y[15]=p-s+a-l,y[16]=u-h+n-c,y[17]=x-o+r-m,y[18]=p-s-a+l,y[19]=u-h-n+c,y[20]=x-o-r+m,y[21]=p-s-a-l,y[22]=u-h-n-c,y[23]=x-o-r-m;var d=i[9]<0?-i[9]:i[9],N=i[10]<0?-i[10]:i[10],f=i[11]<0?-i[11]:i[11];d=i[12]<0?d-i[12]:d+i[12],N=i[13]<0?N-i[13]:N+i[13],f=i[14]<0?f-i[14]:f+i[14],d=i[15]<0?d-i[15]:d+i[15],N=i[16]<0?N-i[16]:N+i[16],f=i[17]<0?f-i[17]:f+i[17];var z=e.AABB_PROX;this.aabb.set(this.position.x-d-z,this.position.x+d+z,this.position.y-N-z,this.position.y+N+z,this.position.z-f-z,this.position.z+f+z),null!=this.proxy&&this.proxy.update()},e.SphereShape=function(t,i){e.Shape.call(this,t),this.type=e.SHAPE_SPHERE,this.radius=i},e.SphereShape.prototype=Object.create(e.Shape.prototype),e.SphereShape.prototype.constructor=e.SphereShape,e.SphereShape.prototype.calculateMassInfo=function(t){var i=1.333*e.PI*this.radius*this.radius*this.radius*this.density;t.mass=i;var s=i*this.radius*this.radius*.4;t.inertia.set(s,0,0,0,s,0,0,0,s)},e.SphereShape.prototype.updateProxy=function(){var t=e.AABB_PROX;this.aabb.set(this.position.x-this.radius-t,this.position.x+this.radius+t,this.position.y-this.radius-t,this.position.y+this.radius+t,this.position.z-this.radius-t,this.position.z+this.radius+t),null!=this.proxy&&this.proxy.update()},e.CylinderShape=function(t,i,s){e.Shape.call(this,t),this.type=e.SHAPE_CYLINDER,this.radius=i,this.height=s,this.halfHeight=.5*s,this.normalDirection=new e.Vec3,this.halfDirection=new e.Vec3},e.CylinderShape.prototype=Object.create(e.Shape.prototype),e.CylinderShape.prototype.constructor=e.CylinderShape,e.CylinderShape.prototype.calculateMassInfo=function(t){var i=this.radius*this.radius,s=e.PI*i*this.height*this.density,h=(.25*i+.0833*this.height*this.height)*s,o=.5*i;t.mass=s,t.inertia.set(h,0,0,0,o,0,0,0,h)},e.CylinderShape.prototype.updateProxy=function(){var t,i,s,h,o,a,n,r,l,c,m,p=this.rotation.elements;o=p[1]*p[1],a=p[4]*p[4],n=p[7]*p[7],this.normalDirection.set(p[1],p[4],p[7]),this.halfDirection.scale(this.normalDirection,this.halfHeight),i=1-o,t=e.sqrt(i*i+o*a+o*n),t>0&&(t=this.radius/t),i*=t,s=1-a,t=e.sqrt(a*o+s*s+a*n),t>0&&(t=this.radius/t),s*=t,h=1-n,t=e.sqrt(n*o+n*a+h*h),t>0&&(t=this.radius/t),h*=t,r=this.halfDirection.x<0?-this.halfDirection.x:this.halfDirection.x,l=this.halfDirection.y<0?-this.halfDirection.y:this.halfDirection.y,c=this.halfDirection.z<0?-this.halfDirection.z:this.halfDirection.z,r=i<0?r-i:r+i,l=s<0?l-s:l+s,c=h<0?c-h:c+h,m=e.AABB_PROX,this.aabb.set(this.position.x-r-m,this.position.x+r+m,this.position.y-l-m,this.position.y+l+m,this.position.z-c-m,this.position.z+c+m),null!=this.proxy&&this.proxy.update()},e.TetraShape=function(i,s,h,o,a){e.Shape.call(this,i),this.type=e.SHAPE_TETRA,this.verts=[s,h,o,a],this.faces=[t(0,1,2),t(1,2,3),t(2,3,4),t(4,0,1)]},e.TetraShape.prototype=Object.create(e.Shape.prototype),e.TetraShape.prototype.constructor=e.TetraShape,e.TetraShape.prototype.calculateMassInfo=function(){},e.TetraShape.prototype.updateProxy=function(){this.aabb.setFromPoints(this.verts),null!==this.proxy&&this.proxy.update()},e.CollisionDetector=function(){this.flip=!1},e.CollisionDetector.prototype={constructor:e.CollisionDetector,detectCollision:function(t,i,s){e.Error("CollisionDetector","Inheritance error.")}},e.BoxBoxCollisionDetector=function(){e.CollisionDetector.call(this),this.clipVertices1=new h(24),this.clipVertices2=new h(24),this.used=new h(8),this.INF=1/0},e.BoxBoxCollisionDetector.prototype=Object.create(e.CollisionDetector.prototype),e.BoxBoxCollisionDetector.prototype.constructor=e.BoxBoxCollisionDetector,e.BoxBoxCollisionDetector.prototype.detectCollision=function(t,i,s){var h,o;t.id<i.id?(h=t,o=i):(h=i,o=t);var a,n,r,l,c,m,p,u,x,y,d,N,f,z,v,b,A,k,S,g,P,I,w,L,M,V,C,T,D,B,E,_,Y,X,Z,R,U=h.elements,O=o.elements,J=h.dimentions,q=o.dimentions,F=h.position,j=o.position,H=F.x,W=F.y,Q=F.z,G=j.x,K=j.y,$=j.z,tt=G-H,it=K-W,st=$-Q,ht=h.halfWidth,et=h.halfHeight,ot=h.halfDepth,at=o.halfWidth,nt=o.halfHeight,rt=o.halfDepth,lt=J[0],ct=J[1],mt=J[2],pt=J[3],ut=J[4],xt=J[5],yt=J[6],dt=J[7],Nt=J[8],ft=J[9],zt=J[10],vt=J[11],bt=J[12],At=J[13],kt=J[14],St=J[15],gt=J[16],Pt=J[17],It=q[0],wt=q[1],Lt=q[2],Mt=q[3],Vt=q[4],Ct=q[5],Tt=q[6],Dt=q[7],Bt=q[8],Et=q[9],_t=q[10],Yt=q[11],Xt=q[12],Zt=q[13],Rt=q[14],Ut=q[15],Ot=q[16],Jt=q[17],qt=ct*Lt-mt*wt,Ft=mt*It-lt*Lt,jt=lt*wt-ct*It,Ht=ct*Ct-mt*Vt,Wt=mt*Mt-lt*Ct,Qt=lt*Vt-ct*Mt,Gt=ct*Bt-mt*Dt,Kt=mt*Tt-lt*Bt,$t=lt*Dt-ct*Tt,ti=ut*Lt-xt*wt,ii=xt*It-pt*Lt,si=pt*wt-ut*It,hi=ut*Ct-xt*Vt,ei=xt*Mt-pt*Ct,oi=pt*Vt-ut*Mt,ai=ut*Bt-xt*Dt,ni=xt*Tt-pt*Bt,ri=pt*Dt-ut*Tt,li=dt*Lt-Nt*wt,ci=Nt*It-yt*Lt,mi=yt*wt-dt*It,pi=dt*Ct-Nt*Vt,ui=Nt*Mt-yt*Ct,xi=yt*Vt-dt*Mt,yi=dt*Bt-Nt*Dt,di=Nt*Tt-yt*Bt,Ni=yt*Dt-dt*Tt,fi=!1,zi=!1,vi=!1,bi=!1,Ai=!1,ki=!1,Si=!1,gi=!1,Pi=!1;if(E=lt*tt+ct*it+mt*st,a=E>0,a||(E=-E),_=ht,X=lt*It+ct*wt+mt*Lt,Z=lt*Mt+ct*Vt+mt*Ct,R=lt*Tt+ct*Dt+mt*Bt,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),Y=X*at+Z*nt+R*rt,b=E-_-Y,!(b>0||(E=pt*tt+ut*it+xt*st,n=E>0,n||(E=-E),_=et,X=pt*It+ut*wt+xt*Lt,Z=pt*Mt+ut*Vt+xt*Ct,R=pt*Tt+ut*Dt+xt*Bt,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),Y=X*at+Z*nt+R*rt,A=E-_-Y,A>0||(E=yt*tt+dt*it+Nt*st,r=E>0,r||(E=-E),_=ot,X=yt*It+dt*wt+Nt*Lt,Z=yt*Mt+dt*Vt+Nt*Ct,R=yt*Tt+dt*Dt+Nt*Bt,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),Y=X*at+Z*nt+R*rt,k=E-_-Y,k>0||(E=It*tt+wt*it+Lt*st,l=E>0,l||(E=-E),X=It*lt+wt*ct+Lt*mt,Z=It*pt+wt*ut+Lt*xt,R=It*yt+wt*dt+Lt*Nt,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),_=X*ht+Z*et+R*ot,Y=at,S=1*(E-_-Y),S>0||(E=Mt*tt+Vt*it+Ct*st,c=E>0,c||(E=-E),X=Mt*lt+Vt*ct+Ct*mt,Z=Mt*pt+Vt*ut+Ct*xt,R=Mt*yt+Vt*dt+Ct*Nt,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),_=X*ht+Z*et+R*ot,Y=nt,g=1*(E-_-Y),g>0||(E=Tt*tt+Dt*it+Bt*st,m=E>0,m||(E=-E),X=Tt*lt+Dt*ct+Bt*mt,Z=Tt*pt+Dt*ut+Bt*xt,R=Tt*yt+Dt*dt+Bt*Nt,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),_=X*ht+Z*et+R*ot,Y=rt,P=1*(E-_-Y),P>0))))))){if(E=qt*qt+Ft*Ft+jt*jt,E>1e-5){if(E=1/e.sqrt(E),qt*=E,Ft*=E,jt*=E,E=qt*tt+Ft*it+jt*st,p=E>0,p||(E=-E),X=qt*pt+Ft*ut+jt*xt,Z=qt*yt+Ft*dt+jt*Nt,X<0&&(X=-X),Z<0&&(Z=-Z),_=X*et+Z*ot,X=qt*Mt+Ft*Vt+jt*Ct,Z=qt*Tt+Ft*Dt+jt*Bt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*nt+Z*rt,I=E-_-Y,I>0)return}else p=!1,I=0,fi=!0;if(E=Ht*Ht+Wt*Wt+Qt*Qt,E>1e-5){if(E=1/e.sqrt(E),Ht*=E,Wt*=E,Qt*=E,E=Ht*tt+Wt*it+Qt*st,u=E>0,u||(E=-E),X=Ht*pt+Wt*ut+Qt*xt,Z=Ht*yt+Wt*dt+Qt*Nt,X<0&&(X=-X),Z<0&&(Z=-Z),_=X*et+Z*ot,X=Ht*It+Wt*wt+Qt*Lt,Z=Ht*Tt+Wt*Dt+Qt*Bt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*at+Z*rt,w=E-_-Y,w>0)return}else u=!1,w=0,zi=!0;if(E=Gt*Gt+Kt*Kt+$t*$t,E>1e-5){if(E=1/e.sqrt(E),Gt*=E,Kt*=E,$t*=E,E=Gt*tt+Kt*it+$t*st,x=E>0,x||(E=-E),X=Gt*pt+Kt*ut+$t*xt,Z=Gt*yt+Kt*dt+$t*Nt,X<0&&(X=-X),Z<0&&(Z=-Z),_=X*et+Z*ot,X=Gt*It+Kt*wt+$t*Lt,Z=Gt*Mt+Kt*Vt+$t*Ct,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*at+Z*nt,L=E-_-Y,L>0)return}else x=!1,L=0,vi=!0;if(E=ti*ti+ii*ii+si*si,E>1e-5){if(E=1/e.sqrt(E),ti*=E,ii*=E,si*=E,E=ti*tt+ii*it+si*st,y=E>0,y||(E=-E),X=ti*lt+ii*ct+si*mt,Z=ti*yt+ii*dt+si*Nt,X<0&&(X=-X),Z<0&&(Z=-Z),_=X*ht+Z*ot,X=ti*Mt+ii*Vt+si*Ct,Z=ti*Tt+ii*Dt+si*Bt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*nt+Z*rt,M=E-_-Y,M>0)return}else y=!1,M=0,bi=!0;if(E=hi*hi+ei*ei+oi*oi,E>1e-5){if(E=1/e.sqrt(E),hi*=E,ei*=E,oi*=E,E=hi*tt+ei*it+oi*st,d=E>0,d||(E=-E),X=hi*lt+ei*ct+oi*mt,Z=hi*yt+ei*dt+oi*Nt,X<0&&(X=-X),Z<0&&(Z=-Z),_=X*ht+Z*ot,X=hi*It+ei*wt+oi*Lt,Z=hi*Tt+ei*Dt+oi*Bt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*at+Z*rt,V=E-_-Y,V>0)return}else d=!1,V=0,Ai=!0;if(E=ai*ai+ni*ni+ri*ri,E>1e-5){if(E=1/e.sqrt(E),ai*=E,ni*=E,ri*=E,E=ai*tt+ni*it+ri*st,N=E>0,N||(E=-E),X=ai*lt+ni*ct+ri*mt,Z=ai*yt+ni*dt+ri*Nt,X<0&&(X=-X),Z<0&&(Z=-Z),_=X*ht+Z*ot,X=ai*It+ni*wt+ri*Lt,Z=ai*Mt+ni*Vt+ri*Ct,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*at+Z*nt,C=E-_-Y,C>0)return}else N=!1,C=0,ki=!0;if(E=li*li+ci*ci+mi*mi,E>1e-5){if(E=1/e.sqrt(E),li*=E,ci*=E,mi*=E,E=li*tt+ci*it+mi*st,f=E>0,f||(E=-E),X=li*lt+ci*ct+mi*mt,Z=li*pt+ci*ut+mi*xt,X<0&&(X=-X),Z<0&&(Z=-Z),_=X*ht+Z*et,X=li*Mt+ci*Vt+mi*Ct,Z=li*Tt+ci*Dt+mi*Bt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*nt+Z*rt,T=E-_-Y,T>0)return}else f=!1,T=0,Si=!0;if(E=pi*pi+ui*ui+xi*xi,E>1e-5){if(E=1/e.sqrt(E),pi*=E,ui*=E,xi*=E,E=pi*tt+ui*it+xi*st,z=E>0,z||(E=-E),X=pi*lt+ui*ct+xi*mt,Z=pi*pt+ui*ut+xi*xt,X<0&&(X=-X),Z<0&&(Z=-Z),_=X*ht+Z*et,X=pi*It+ui*wt+xi*Lt,Z=pi*Tt+ui*Dt+xi*Bt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*at+Z*rt,D=E-_-Y,D>0)return}else z=!1,D=0,gi=!0;if(E=yi*yi+di*di+Ni*Ni,E>1e-5){if(E=1/e.sqrt(E),yi*=E,di*=E,Ni*=E,E=yi*tt+di*it+Ni*st,v=E>0,v||(E=-E),X=yi*lt+di*ct+Ni*mt,Z=yi*pt+di*ut+Ni*xt,X<0&&(X=-X),Z<0&&(Z=-Z),_=X*ht+Z*et,X=yi*It+di*wt+Ni*Lt,Z=yi*Mt+di*Vt+Ni*Ct,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*at+Z*nt,B=E-_-Y,B>0)return}else v=!1,B=0,Pi=!0;var Ii=b,wi=b,Li=0,Mi=a;A>wi&&(Ii=A,wi=A,Li=1,Mi=n),k>wi&&(Ii=k,wi=k,Li=2,Mi=r),S>wi&&(Ii=S,wi=S,Li=3,Mi=l),g>wi&&(Ii=g,wi=g,Li=4,Mi=c),P>wi&&(Ii=P,wi=P,Li=5,Mi=m),I-.01>wi&&!fi&&(Ii=I,wi=I-.01,Li=6,Mi=p),w-.01>wi&&!zi&&(Ii=w,wi=w-.01,Li=7,Mi=u),L-.01>wi&&!vi&&(Ii=L,wi=L-.01,Li=8,Mi=x),M-.01>wi&&!bi&&(Ii=M,wi=M-.01,Li=9,Mi=y),V-.01>wi&&!Ai&&(Ii=V,wi=V-.01,Li=10,Mi=d),C-.01>wi&&!ki&&(Ii=C,wi=C-.01,Li=11,Mi=N),T-.01>wi&&!Si&&(Ii=T,wi=T-.01,Li=12,Mi=f),D-.01>wi&&!gi&&(Ii=D,wi=D-.01,Li=13,Mi=z),B-.01>wi&&!Pi&&(Ii=B,Li=14,Mi=v);var Vi=0,Ci=0,Ti=0,Di=0,Bi=0,Ei=0,_i=0,Yi=0,Xi=0,Zi=0,Ri=0,Ui=0,Oi=0,Ji=0,qi=0,Fi=0,ji=0,Hi=0,Wi=!1;0==Li?(Mi?(Zi=H+ft,Ri=W+zt,Ui=Q+vt,Vi=lt,Ci=ct,Ti=mt):(Zi=H-ft,Ri=W-zt,Ui=Q-vt,Vi=-lt,Ci=-ct,Ti=-mt),Oi=bt,Ji=At,qi=kt,Di=-pt,Bi=-ut,Ei=-xt,Fi=St,ji=gt,Hi=Pt,_i=-yt,Yi=-dt,Xi=-Nt):1==Li?(Mi?(Zi=H+bt,Ri=W+At,Ui=Q+kt,Vi=pt,Ci=ut,Ti=xt):(Zi=H-bt,Ri=W-At,Ui=Q-kt,Vi=-pt,Ci=-ut,Ti=-xt),Oi=ft,Ji=zt,qi=vt,Di=-lt,Bi=-ct,Ei=-mt,Fi=St,ji=gt,Hi=Pt,_i=-yt,Yi=-dt,Xi=-Nt):2==Li?(Mi?(Zi=H+St,Ri=W+gt,Ui=Q+Pt,Vi=yt,Ci=dt,Ti=Nt):(Zi=H-St,Ri=W-gt,Ui=Q-Pt,Vi=-yt,Ci=-dt,Ti=-Nt),Oi=ft,Ji=zt,qi=vt,Di=-lt,Bi=-ct,Ei=-mt,Fi=bt,ji=At,Hi=kt,_i=-pt,Yi=-ut,Xi=-xt):3==Li?(Wi=!0,Mi?(Zi=G-Et,Ri=K-_t,Ui=$-Yt,Vi=-It,Ci=-wt,Ti=-Lt):(Zi=G+Et,Ri=K+_t,Ui=$+Yt,Vi=It,Ci=wt,Ti=Lt),Oi=Xt,Ji=Zt,qi=Rt,Di=-Mt,Bi=-Vt,Ei=-Ct,Fi=Ut,ji=Ot,Hi=Jt,_i=-Tt,Yi=-Dt,Xi=-Bt):4==Li?(Wi=!0,Mi?(Zi=G-Xt,Ri=K-Zt,Ui=$-Rt,Vi=-Mt,Ci=-Vt,Ti=-Ct):(Zi=G+Xt,Ri=K+Zt,Ui=$+Rt,Vi=Mt,Ci=Vt,Ti=Ct),Oi=Et,Ji=_t,qi=Yt,Di=-It,Bi=-wt,Ei=-Lt,Fi=Ut,ji=Ot,Hi=Jt,_i=-Tt,Yi=-Dt,Xi=-Bt):5==Li?(Wi=!0,Mi?(Zi=G-Ut,Ri=K-Ot,Ui=$-Jt,Vi=-Tt,Ci=-Dt,Ti=-Bt):(Zi=G+Ut,Ri=K+Ot,Ui=$+Jt,Vi=Tt,Ci=Dt,Ti=Bt),Oi=Et,Ji=_t,qi=Yt,Di=-It,Bi=-wt,Ei=-Lt,Fi=Xt,ji=Zt,Hi=Rt,_i=-Mt,Yi=-Vt,Xi=-Ct):6==Li?(Vi=qt,Ci=Ft,Ti=jt,Di=lt,Bi=ct,Ei=mt,_i=It,Yi=wt,Xi=Lt):7==Li?(Vi=Ht,Ci=Wt,Ti=Qt,Di=lt,Bi=ct,Ei=mt,_i=Mt,Yi=Vt,Xi=Ct):8==Li?(Vi=Gt,Ci=Kt,Ti=$t,Di=lt,Bi=ct,Ei=mt,_i=Tt,Yi=Dt,Xi=Bt):9==Li?(Vi=ti,Ci=ii,Ti=si,
Di=pt,Bi=ut,Ei=xt,_i=It,Yi=wt,Xi=Lt):10==Li?(Vi=hi,Ci=ei,Ti=oi,Di=pt,Bi=ut,Ei=xt,_i=Mt,Yi=Vt,Xi=Ct):11==Li?(Vi=ai,Ci=ni,Ti=ri,Di=pt,Bi=ut,Ei=xt,_i=Tt,Yi=Dt,Xi=Bt):12==Li?(Vi=li,Ci=ci,Ti=mi,Di=yt,Bi=dt,Ei=Nt,_i=It,Yi=wt,Xi=Lt):13==Li?(Vi=pi,Ci=ui,Ti=xi,Di=yt,Bi=dt,Ei=Nt,_i=Mt,Yi=Vt,Xi=Ct):14==Li&&(Vi=yi,Ci=di,Ti=Ni,Di=yt,Bi=dt,Ei=Nt,_i=Tt,Yi=Dt,Xi=Bt);if(Li>5){Mi||(Vi=-Vi,Ci=-Ci,Ti=-Ti);var Qi,Gi,Ki,$i,ts,is,ss,hs,es,os,as;is=U[0],ss=U[1],hs=U[2],Gi=Vi*is+Ci*ss+Ti*hs,Ki=U[3],$i=U[4],ts=U[5],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=U[6],$i=U[7],ts=U[8],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=U[9],$i=U[10],ts=U[11],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=U[12],$i=U[13],ts=U[14],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=U[15],$i=U[16],ts=U[17],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=U[18],$i=U[19],ts=U[20],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=U[21],$i=U[22],ts=U[23],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),es=O[0],os=O[1],as=O[2],Gi=Vi*es+Ci*os+Ti*as,Ki=O[3],$i=O[4],ts=O[5],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,as=ts),Ki=O[6],$i=O[7],ts=O[8],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,as=ts),Ki=O[9],$i=O[10],ts=O[11],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,as=ts),Ki=O[12],$i=O[13],ts=O[14],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,as=ts),Ki=O[15],$i=O[16],ts=O[17],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,as=ts),Ki=O[18],$i=O[19],ts=O[20],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,as=ts),Ki=O[21],$i=O[22],ts=O[23],Qi=Vi*Ki+Ci*$i+Ti*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,as=ts),Ki=es-is,$i=os-ss,ts=as-hs,X=Di*_i+Bi*Yi+Ei*Xi;var ns=(Ki*(Di-_i*X)+$i*(Bi-Yi*X)+ts*(Ei-Xi*X))/(1-X*X);return void s.addPoint(is+Di*ns+Vi*Ii*.5,ss+Bi*ns+Ci*Ii*.5,hs+Ei*ns+Ti*Ii*.5,Vi,Ci,Ti,Ii,!1)}var rs,ls,cs,ms,ps,us,xs,ys,ds,Ns,fs,zs,vs=1,bs=0,As=0;Wi?(bs=lt*Vi+ct*Ci+mt*Ti,bs<vs&&(vs=bs,As=0),-bs<vs&&(vs=-bs,As=1),bs=pt*Vi+ut*Ci+xt*Ti,bs<vs&&(vs=bs,As=2),-bs<vs&&(vs=-bs,As=3),bs=yt*Vi+dt*Ci+Nt*Ti,bs<vs&&(vs=bs,As=4),-bs<vs&&(vs=-bs,As=5),0==As?(rs=U[0],ls=U[1],cs=U[2],ms=U[6],ps=U[7],us=U[8],xs=U[9],ys=U[10],ds=U[11],Ns=U[3],fs=U[4],zs=U[5]):1==As?(rs=U[15],ls=U[16],cs=U[17],ms=U[21],ps=U[22],us=U[23],xs=U[18],ys=U[19],ds=U[20],Ns=U[12],fs=U[13],zs=U[14]):2==As?(rs=U[12],ls=U[13],cs=U[14],ms=U[0],ps=U[1],us=U[2],xs=U[3],ys=U[4],ds=U[5],Ns=U[15],fs=U[16],zs=U[17]):3==As?(rs=U[21],ls=U[22],cs=U[23],ms=U[9],ps=U[10],us=U[11],xs=U[6],ys=U[7],ds=U[8],Ns=U[18],fs=U[19],zs=U[20]):4==As?(rs=U[12],ls=U[13],cs=U[14],ms=U[18],ps=U[19],us=U[20],xs=U[6],ys=U[7],ds=U[8],Ns=U[0],fs=U[1],zs=U[2]):5==As&&(rs=U[3],ls=U[4],cs=U[5],ms=U[6],ps=U[7],us=U[8],xs=U[21],ys=U[22],ds=U[23],Ns=U[15],fs=U[16],zs=U[17])):(bs=It*Vi+wt*Ci+Lt*Ti,bs<vs&&(vs=bs,As=0),-bs<vs&&(vs=-bs,As=1),bs=Mt*Vi+Vt*Ci+Ct*Ti,bs<vs&&(vs=bs,As=2),-bs<vs&&(vs=-bs,As=3),bs=Tt*Vi+Dt*Ci+Bt*Ti,bs<vs&&(vs=bs,As=4),-bs<vs&&(vs=-bs,As=5),0==As?(rs=O[0],ls=O[1],cs=O[2],ms=O[6],ps=O[7],us=O[8],xs=O[9],ys=O[10],ds=O[11],Ns=O[3],fs=O[4],zs=O[5]):1==As?(rs=O[15],ls=O[16],cs=O[17],ms=O[21],ps=O[22],us=O[23],xs=O[18],ys=O[19],ds=O[20],Ns=O[12],fs=O[13],zs=O[14]):2==As?(rs=O[12],ls=O[13],cs=O[14],ms=O[0],ps=O[1],us=O[2],xs=O[3],ys=O[4],ds=O[5],Ns=O[15],fs=O[16],zs=O[17]):3==As?(rs=O[21],ls=O[22],cs=O[23],ms=O[9],ps=O[10],us=O[11],xs=O[6],ys=O[7],ds=O[8],Ns=O[18],fs=O[19],zs=O[20]):4==As?(rs=O[12],ls=O[13],cs=O[14],ms=O[18],ps=O[19],us=O[20],xs=O[6],ys=O[7],ds=O[8],Ns=O[0],fs=O[1],zs=O[2]):5==As&&(rs=O[3],ls=O[4],cs=O[5],ms=O[9],ps=O[10],us=O[11],xs=O[21],ys=O[22],ds=O[23],Ns=O[15],fs=O[16],zs=O[17]));var ks,Ss,gs,Ps,Is,ws,Ls,Ms,Vs;this.clipVertices1[0]=rs,this.clipVertices1[1]=ls,this.clipVertices1[2]=cs,this.clipVertices1[3]=ms,this.clipVertices1[4]=ps,this.clipVertices1[5]=us,this.clipVertices1[6]=xs,this.clipVertices1[7]=ys,this.clipVertices1[8]=ds,this.clipVertices1[9]=Ns,this.clipVertices1[10]=fs,this.clipVertices1[11]=zs,Ss=0,Ps=this.clipVertices1[9],Is=this.clipVertices1[10],ws=this.clipVertices1[11],X=(Ps-Zi-Oi)*Di+(Is-Ri-Ji)*Bi+(ws-Ui-qi)*Ei;for(var Cs=0;Cs<4;Cs++)gs=3*Cs,Ls=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Vs=this.clipVertices1[gs+2],Z=(Ls-Zi-Oi)*Di+(Ms-Ri-Ji)*Bi+(Vs-Ui-qi)*Ei,X>0?Z>0?(gs=3*Ss,Ss++,this.clipVertices2[gs]=Ls,this.clipVertices2[gs+1]=Ms,this.clipVertices2[gs+2]=Vs):(gs=3*Ss,Ss++,ns=X/(X-Z),this.clipVertices2[gs]=Ps+(Ls-Ps)*ns,this.clipVertices2[gs+1]=Is+(Ms-Is)*ns,this.clipVertices2[gs+2]=ws+(Vs-ws)*ns):Z>0&&(gs=3*Ss,Ss++,ns=X/(X-Z),this.clipVertices2[gs]=Ps+(Ls-Ps)*ns,this.clipVertices2[gs+1]=Is+(Ms-Is)*ns,this.clipVertices2[gs+2]=ws+(Vs-ws)*ns,gs=3*Ss,Ss++,this.clipVertices2[gs]=Ls,this.clipVertices2[gs+1]=Ms,this.clipVertices2[gs+2]=Vs),Ps=Ls,Is=Ms,ws=Vs,X=Z;if(ks=Ss,0!=ks){for(Ss=0,gs=3*(ks-1),Ps=this.clipVertices2[gs],Is=this.clipVertices2[gs+1],ws=this.clipVertices2[gs+2],X=(Ps-Zi-Fi)*_i+(Is-Ri-ji)*Yi+(ws-Ui-Hi)*Xi,Cs=0;Cs<ks;Cs++)gs=3*Cs,Ls=this.clipVertices2[gs],Ms=this.clipVertices2[gs+1],Vs=this.clipVertices2[gs+2],Z=(Ls-Zi-Fi)*_i+(Ms-Ri-ji)*Yi+(Vs-Ui-Hi)*Xi,X>0?Z>0?(gs=3*Ss,Ss++,this.clipVertices1[gs]=Ls,this.clipVertices1[gs+1]=Ms,this.clipVertices1[gs+2]=Vs):(gs=3*Ss,Ss++,ns=X/(X-Z),this.clipVertices1[gs]=Ps+(Ls-Ps)*ns,this.clipVertices1[gs+1]=Is+(Ms-Is)*ns,this.clipVertices1[gs+2]=ws+(Vs-ws)*ns):Z>0&&(gs=3*Ss,Ss++,ns=X/(X-Z),this.clipVertices1[gs]=Ps+(Ls-Ps)*ns,this.clipVertices1[gs+1]=Is+(Ms-Is)*ns,this.clipVertices1[gs+2]=ws+(Vs-ws)*ns,gs=3*Ss,Ss++,this.clipVertices1[gs]=Ls,this.clipVertices1[gs+1]=Ms,this.clipVertices1[gs+2]=Vs),Ps=Ls,Is=Ms,ws=Vs,X=Z;if(ks=Ss,0!=ks){for(Ss=0,gs=3*(ks-1),Ps=this.clipVertices1[gs],Is=this.clipVertices1[gs+1],ws=this.clipVertices1[gs+2],X=(Ps-Zi+Oi)*-Di+(Is-Ri+Ji)*-Bi+(ws-Ui+qi)*-Ei,Cs=0;Cs<ks;Cs++)gs=3*Cs,Ls=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Vs=this.clipVertices1[gs+2],Z=(Ls-Zi+Oi)*-Di+(Ms-Ri+Ji)*-Bi+(Vs-Ui+qi)*-Ei,X>0?Z>0?(gs=3*Ss,Ss++,this.clipVertices2[gs]=Ls,this.clipVertices2[gs+1]=Ms,this.clipVertices2[gs+2]=Vs):(gs=3*Ss,Ss++,ns=X/(X-Z),this.clipVertices2[gs]=Ps+(Ls-Ps)*ns,this.clipVertices2[gs+1]=Is+(Ms-Is)*ns,this.clipVertices2[gs+2]=ws+(Vs-ws)*ns):Z>0&&(gs=3*Ss,Ss++,ns=X/(X-Z),this.clipVertices2[gs]=Ps+(Ls-Ps)*ns,this.clipVertices2[gs+1]=Is+(Ms-Is)*ns,this.clipVertices2[gs+2]=ws+(Vs-ws)*ns,gs=3*Ss,Ss++,this.clipVertices2[gs]=Ls,this.clipVertices2[gs+1]=Ms,this.clipVertices2[gs+2]=Vs),Ps=Ls,Is=Ms,ws=Vs,X=Z;if(ks=Ss,0!=ks){for(Ss=0,gs=3*(ks-1),Ps=this.clipVertices2[gs],Is=this.clipVertices2[gs+1],ws=this.clipVertices2[gs+2],X=(Ps-Zi+Fi)*-_i+(Is-Ri+ji)*-Yi+(ws-Ui+Hi)*-Xi,Cs=0;Cs<ks;Cs++)gs=3*Cs,Ls=this.clipVertices2[gs],Ms=this.clipVertices2[gs+1],Vs=this.clipVertices2[gs+2],Z=(Ls-Zi+Fi)*-_i+(Ms-Ri+ji)*-Yi+(Vs-Ui+Hi)*-Xi,X>0?Z>0?(gs=3*Ss,Ss++,this.clipVertices1[gs]=Ls,this.clipVertices1[gs+1]=Ms,this.clipVertices1[gs+2]=Vs):(gs=3*Ss,Ss++,ns=X/(X-Z),this.clipVertices1[gs]=Ps+(Ls-Ps)*ns,this.clipVertices1[gs+1]=Is+(Ms-Is)*ns,this.clipVertices1[gs+2]=ws+(Vs-ws)*ns):Z>0&&(gs=3*Ss,Ss++,ns=X/(X-Z),this.clipVertices1[gs]=Ps+(Ls-Ps)*ns,this.clipVertices1[gs+1]=Is+(Ms-Is)*ns,this.clipVertices1[gs+2]=ws+(Vs-ws)*ns,gs=3*Ss,Ss++,this.clipVertices1[gs]=Ls,this.clipVertices1[gs+1]=Ms,this.clipVertices1[gs+2]=Vs),Ps=Ls,Is=Ms,ws=Vs,X=Z;if(ks=Ss,Wi){var Ts=h;h=o,o=Ts}if(0!=ks){var Ds=h!=t;if(ks>4){Ps=.25*(rs+ms+xs+Ns),Is=.25*(ls+ps+ys+fs),ws=.25*(cs+us+ds+zs),Di=rs-Ps,Bi=ls-Is,Ei=cs-ws,_i=ms-Ps,Yi=ps-Is,Xi=us-ws;var Bs=0,Es=0,_s=0,Ys=0,Xs=-this.INF;for(vs=this.INF,Cs=0;Cs<ks;Cs++)this.used[Cs]=!1,gs=3*Cs,Ps=this.clipVertices1[gs],Is=this.clipVertices1[gs+1],ws=this.clipVertices1[gs+2],bs=Ps*Di+Is*Bi+ws*Ei,bs<vs&&(vs=bs,Bs=Cs),bs>Xs&&(Xs=bs,_s=Cs);for(this.used[Bs]=!0,this.used[_s]=!0,Xs=-this.INF,vs=this.INF,Cs=0;Cs<ks;Cs++)this.used[Cs]||(gs=3*Cs,Ps=this.clipVertices1[gs],Is=this.clipVertices1[gs+1],ws=this.clipVertices1[gs+2],bs=Ps*_i+Is*Yi+ws*Xi,bs<vs&&(vs=bs,Es=Cs),bs>Xs&&(Xs=bs,Ys=Cs));gs=3*Bs,Ps=this.clipVertices1[gs],Is=this.clipVertices1[gs+1],ws=this.clipVertices1[gs+2],bs=(Ps-Zi)*Vi+(Is-Ri)*Ci+(ws-Ui)*Ti,bs<0&&s.addPoint(Ps,Is,ws,Vi,Ci,Ti,bs,Ds),gs=3*Es,Ps=this.clipVertices1[gs],Is=this.clipVertices1[gs+1],ws=this.clipVertices1[gs+2],bs=(Ps-Zi)*Vi+(Is-Ri)*Ci+(ws-Ui)*Ti,bs<0&&s.addPoint(Ps,Is,ws,Vi,Ci,Ti,bs,Ds),gs=3*_s,Ps=this.clipVertices1[gs],Is=this.clipVertices1[gs+1],ws=this.clipVertices1[gs+2],bs=(Ps-Zi)*Vi+(Is-Ri)*Ci+(ws-Ui)*Ti,bs<0&&s.addPoint(Ps,Is,ws,Vi,Ci,Ti,bs,Ds),gs=3*Ys,Ps=this.clipVertices1[gs],Is=this.clipVertices1[gs+1],ws=this.clipVertices1[gs+2],bs=(Ps-Zi)*Vi+(Is-Ri)*Ci+(ws-Ui)*Ti,bs<0&&s.addPoint(Ps,Is,ws,Vi,Ci,Ti,bs,Ds)}else for(Cs=0;Cs<ks;Cs++)gs=3*Cs,Ps=this.clipVertices1[gs],Is=this.clipVertices1[gs+1],ws=this.clipVertices1[gs+2],bs=(Ps-Zi)*Vi+(Is-Ri)*Ci+(ws-Ui)*Ti,bs<0&&s.addPoint(Ps,Is,ws,Vi,Ci,Ti,bs,Ds)}}}}}},e.SphereBoxCollisionDetector=function(t){e.CollisionDetector.call(this),this.flip=t},e.SphereBoxCollisionDetector.prototype=Object.create(e.CollisionDetector.prototype),e.SphereBoxCollisionDetector.prototype.constructor=e.SphereBoxCollisionDetector,e.SphereBoxCollisionDetector.prototype.detectCollision=function(t,i,s){var h,o;this.flip?(h=i,o=t):(h=t,o=i);var a,n,r,l,c,m=o.dimentions,p=h.position,u=p.x,x=p.y,y=p.z,d=o.position,N=d.x,f=d.y,z=d.z,v=h.radius,b=o.halfWidth,A=o.halfHeight,k=o.halfDepth,S=u-N,g=x-f,P=y-z,I=m[0]*S+m[1]*g+m[2]*P,w=m[3]*S+m[4]*g+m[5]*P,L=m[6]*S+m[7]*g+m[8]*P,M=0;I>b?I=b:I<-b?I=-b:M=1,w>A?w=A:w<-A?w=-A:M|=2,L>k?L=k:L<-k?L=-k:M|=4,7==M?(S=I<0?b+I:b-I,g=w<0?A+w:A-w,P=L<0?k+L:k-L,S<g?S<P?(l=S-b,I<0?(I=-b,S=m[0],g=m[1],P=m[2]):(I=b,S=-m[0],g=-m[1],P=-m[2])):(l=P-k,L<0?(L=-k,S=m[6],g=m[7],P=m[8]):(L=k,S=-m[6],g=-m[7],P=-m[8])):g<P?(l=g-A,w<0?(w=-A,S=m[3],g=m[4],P=m[5]):(w=A,S=-m[3],g=-m[4],P=-m[5])):(l=P-k,L<0?(L=-k,S=m[6],g=m[7],P=m[8]):(L=k,S=-m[6],g=-m[7],P=-m[8])),a=N+I*m[0]+w*m[3]+L*m[6],n=f+I*m[1]+w*m[4]+L*m[7],r=z+I*m[2]+w*m[5]+L*m[8],s.addPoint(u+v*S,x+v*g,y+v*P,S,g,P,l-v,this.flip)):(a=N+I*m[0]+w*m[3]+L*m[6],n=f+I*m[1]+w*m[4]+L*m[7],r=z+I*m[2]+w*m[5]+L*m[8],S=a-p.x,g=n-p.y,P=r-p.z,l=S*S+g*g+P*P,l>0&&l<v*v&&(l=e.sqrt(l),c=1/l,S*=c,g*=c,P*=c,s.addPoint(u+v*S,x+v*g,y+v*P,S,g,P,l-v,this.flip)))},e.SphereSphereCollisionDetector=function(){e.CollisionDetector.call(this)},e.SphereSphereCollisionDetector.prototype=Object.create(e.CollisionDetector.prototype),e.SphereSphereCollisionDetector.prototype.constructor=e.SphereSphereCollisionDetector,e.SphereSphereCollisionDetector.prototype.detectCollision=function(t,i,s){var h=t,o=i,a=h.position,n=o.position,r=n.x-a.x,l=n.y-a.y,c=n.z-a.z,m=r*r+l*l+c*c,p=h.radius,u=o.radius,x=p+u;if(m>0&&m<x*x){m=e.sqrt(m);var y=1/m;r*=y,l*=y,c*=y,s.addPoint(a.x+r*p,a.y+l*p,a.z+c*p,r,l,c,m-x,!1)}},e.BoxCylinderCollisionDetector=function(t){e.CollisionDetector.call(this),this.flip=t},e.BoxCylinderCollisionDetector.prototype=Object.create(e.CollisionDetector.prototype),e.BoxCylinderCollisionDetector.prototype.constructor=e.BoxCylinderCollisionDetector,e.BoxCylinderCollisionDetector.prototype.getSep=function(t,i,s,h,o){var a,n,r,l,c,m,p,u,x,y,d,N,f,z=new e.Vec3,v=t.position.x,b=t.position.y,A=t.position.z,k=i.position.x,S=i.position.y,g=i.position.z,P=k-v,I=S-b,w=g-A;P*P+I*I+w*w==0&&(I=.001);var L=-P,M=-I,V=-w;this.supportPointB(t,-L,-M,-V,z);var C=z.x,T=z.y,D=z.z;this.supportPointC(i,L,M,V,z);var B=z.x,E=z.y,_=z.z,Y=B-C,X=E-T,Z=_-D;if(Y*L+X*M+Z*V<=0)return!1;if(L=X*w-Z*I,M=Z*P-Y*w,V=Y*I-X*P,L*L+M*M+V*V==0)return s.init(Y-P,X-I,Z-w),s.normalize(s),h.init(.5*(C+B),.5*(T+E),.5*(D+_)),!0;this.supportPointB(t,-L,-M,-V,z);var R=z.x,U=z.y,O=z.z;this.supportPointC(i,L,M,V,z);var J=z.x,q=z.y,F=z.z,j=J-R,H=q-U,W=F-O;if(j*L+H*M+W*V<=0)return!1;a=Y-P,n=X-I,r=Z-w,l=j-P,c=H-I,m=W-w,L=n*m-r*c,M=r*l-a*m,V=a*c-n*l,L*P+M*I+V*w>0&&(a=Y,n=X,r=Z,Y=j,X=H,Z=W,j=a,H=n,W=r,a=C,n=T,r=D,C=R,T=U,D=O,R=a,U=n,O=r,a=B,n=E,r=_,B=J,E=q,_=F,J=a,q=n,F=r,L=-L,M=-M,V=-V);for(var Q=0;;){if(++Q>100)return!1;this.supportPointB(t,-L,-M,-V,z);var G=z.x,K=z.y,$=z.z;this.supportPointC(i,L,M,V,z);var tt=z.x,it=z.y,st=z.z,ht=tt-G,et=it-K,ot=st-$;if(ht*L+et*M+ot*V<=0)return!1;if((X*ot-Z*et)*P+(Z*ht-Y*ot)*I+(Y*et-X*ht)*w<0)j=ht,H=et,W=ot,R=G,U=K,O=$,J=tt,q=it,F=st,a=Y-P,n=X-I,r=Z-w,l=ht-P,c=et-I,m=ot-w,L=n*m-r*c,M=r*l-a*m,V=a*c-n*l;else if((et*W-ot*H)*P+(ot*j-ht*W)*I+(ht*H-et*j)*w<0)Y=ht,X=et,Z=ot,C=G,T=K,D=$,B=tt,E=it,_=st,a=ht-P,n=et-I,r=ot-w,l=j-P,c=H-I,m=W-w,L=n*m-r*c,M=r*l-a*m,V=a*c-n*l;else for(var at=!1;;){if(a=j-Y,n=H-X,r=W-Z,l=ht-Y,c=et-X,m=ot-Z,L=n*m-r*c,M=r*l-a*m,V=a*c-n*l,p=1/e.sqrt(L*L+M*M+V*V),L*=p,M*=p,V*=p,L*Y+M*X+V*Z>=0&&!at){var nt=(X*W-Z*H)*ht+(Z*j-Y*W)*et+(Y*H-X*j)*ot,rt=(et*W-ot*H)*P+(ot*j-ht*W)*I+(ht*H-et*j)*w,lt=(I*Z-w*X)*ht+(w*Y-P*Z)*et+(P*X-I*Y)*ot,ct=(H*Z-W*X)*P+(W*Y-j*Z)*I+(j*X-H*Y)*w,mt=nt+rt+lt+ct;mt<=0&&(nt=0,rt=(H*ot-W*et)*L+(W*ht-j*ot)*M+(j*et-H*ht)*V,lt=(et*W-ot*H)*L+(ot*j-ht*W)*M+(ht*H-et*j)*V,ct=(X*W-Z*H)*L+(Z*j-Y*W)*M+(Y*H-X*j)*V,mt=rt+lt+ct);var pt=1/mt;u=(v*nt+C*rt+R*lt+G*ct)*pt,x=(b*nt+T*rt+U*lt+K*ct)*pt,y=(A*nt+D*rt+O*lt+$*ct)*pt,d=(k*nt+B*rt+J*lt+tt*ct)*pt,N=(S*nt+E*rt+q*lt+it*ct)*pt,f=(g*nt+_*rt+F*lt+st*ct)*pt,at=!0}this.supportPointB(t,-L,-M,-V,z);var ut=z.x,xt=z.y,yt=z.z;this.supportPointC(i,L,M,V,z);var dt=z.x,Nt=z.y,ft=z.z,zt=dt-ut,vt=Nt-xt,bt=ft-yt,At=-(zt*L+vt*M+bt*V);if((zt-ht)*L+(vt-et)*M+(bt-ot)*V<=.01||At>=0)return!!at&&(s.init(-L,-M,-V),h.init(.5*(u+d),.5*(x+N),.5*(y+f)),o.x=At,!0);(vt*Z-bt*X)*P+(bt*Y-zt*Z)*I+(zt*X-vt*Y)*w<0?(vt*W-bt*H)*P+(bt*j-zt*W)*I+(zt*H-vt*j)*w<0?(Y=zt,X=vt,Z=bt,C=ut,T=xt,D=yt,B=dt,E=Nt,_=ft):(ht=zt,et=vt,ot=bt,G=ut,K=xt,$=yt,tt=dt,it=Nt,st=ft):(vt*ot-bt*et)*P+(bt*ht-zt*ot)*I+(zt*et-vt*ht)*w<0?(j=zt,H=vt,W=bt,R=ut,U=xt,O=yt,J=dt,q=Nt,F=ft):(Y=zt,X=vt,Z=bt,C=ut,T=xt,D=yt,B=dt,E=Nt,_=ft)}}},e.BoxCylinderCollisionDetector.prototype.supportPointB=function(t,i,s,h,e){var o,a,n,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=t.halfWidth,u=t.halfHeight,x=t.halfDepth;o=l<0?-p:p,a=c<0?-u:u,n=m<0?-x:x,l=r[0]*o+r[1]*a+r[2]*n+t.position.x,c=r[3]*o+r[4]*a+r[5]*n+t.position.y,m=r[6]*o+r[7]*a+r[8]*n+t.position.z,e.init(l,c,m)},e.BoxCylinderCollisionDetector.prototype.supportPointC=function(t,i,s,h,o){var a,n,r,l=t.rotation.elements,c=l[0]*i+l[3]*s+l[6]*h,m=l[1]*i+l[4]*s+l[7]*h,p=l[2]*i+l[5]*s+l[8]*h,u=c,x=p,y=u*u+x*x,d=t.radius,N=t.halfHeight;0==y?m<0?(a=d,n=-N,r=0):(a=d,n=N,r=0):(y=t.radius/e.sqrt(y),m<0?(a=u*y,n=-N,r=x*y):(a=u*y,n=N,r=x*y)),c=l[0]*a+l[1]*n+l[2]*r+t.position.x,m=l[3]*a+l[4]*n+l[5]*r+t.position.y,p=l[6]*a+l[7]*n+l[8]*r+t.position.z,o.init(c,m,p)},e.BoxCylinderCollisionDetector.prototype.detectCollision=function(t,i,s){var h,o;this.flip?(h=i,o=t):(h=t,o=i);var a=new e.Vec3,n=new e.Vec3,r=new e.Vec3;if(this.getSep(h,o,a,n,r)){var l=h.position.x,c=h.position.y,m=h.position.z,p=o.position.x,u=o.position.y,x=o.position.z,y=h.halfWidth,d=h.halfHeight,N=h.halfDepth,f=o.halfHeight,z=o.radius,v=h.dimentions,b=v[0],A=v[1],k=v[2],S=v[3],g=v[4],P=v[5],I=v[6],w=v[7],L=v[8],M=v[9],V=v[10],C=v[11],T=v[12],D=v[13],B=v[14],E=v[15],_=v[16],Y=v[17],X=o.normalDirection.x,Z=o.normalDirection.y,R=o.normalDirection.z,U=o.halfDirection.x,O=o.halfDirection.y,J=o.halfDirection.z,q=a.x,F=a.y,j=a.z,H=q*b+F*A+j*k,W=q*S+F*g+j*P,Q=q*I+F*w+j*L,G=q*X+F*Z+j*R,K=H>0,$=W>0,tt=Q>0,it=G>0;K||(H=-H),$||(W=-W),tt||(Q=-Q),it||(G=-G);var st=0;G>.999?st=H>.999?H>G?1:4:W>.999?W>G?2:4:Q>.999&&Q>G?3:4:H>.999?st=1:W>.999?st=2:Q>.999&&(st=3);var ht,et,ot,at,nt,rt,lt,ct,mt,pt,ut,xt,yt,dt,Nt,ft,zt,vt,bt,At,kt,St,gt,Pt,It,wt,Lt,Mt,Vt,Ct,Tt,Dt,Bt,Et,_t,Yt,Xt,Zt,Rt,Ut,Ot,Jt,qt,Ft,jt,Ht,Wt,Qt,Gt,Kt,$t,ti,ii;if(0==st)s.addPoint(n.x,n.y,n.z,q,F,j,r.x,this.flip);else if(4==st){it?(at=p-U,nt=u-O,rt=x-J,q=-X,F=-Z,j=-R):(at=p+U,nt=u+O,rt=x+J,q=X,F=Z,j=R);var si,hi,ei,oi,ai,ni,ri,li,ci,mi,pi,ui;At=1,st=0,qt=b*q+A*F+k*j,qt<At&&(At=qt,st=0),-qt<At&&(At=-qt,st=1),qt=S*q+g*F+P*j,qt<At&&(At=qt,st=2),-qt<At&&(At=-qt,st=3),qt=I*q+w*F+L*j,qt<At&&(At=qt,st=4),-qt<At&&(At=-qt,st=5);var xi=h.elements;switch(st){case 0:si=xi[0],hi=xi[1],ei=xi[2],oi=xi[6],ai=xi[7],ni=xi[8],ri=xi[9],li=xi[10],ci=xi[11],mi=xi[3],pi=xi[4],ui=xi[5];break;case 1:si=xi[15],hi=xi[16],ei=xi[17],oi=xi[21],ai=xi[22],ni=xi[23],ri=xi[18],li=xi[19],ci=xi[20],mi=xi[12],pi=xi[13],ui=xi[14];break;case 2:si=xi[12],hi=xi[13],ei=xi[14],oi=xi[0],ai=xi[1],ni=xi[2],ri=xi[3],li=xi[4],ci=xi[5],mi=xi[15],pi=xi[16],ui=xi[17];break;case 3:si=xi[21],hi=xi[22],ei=xi[23],oi=xi[9],ai=xi[10],ni=xi[11],ri=xi[6],li=xi[7],ci=xi[8],mi=xi[18],pi=xi[19],ui=xi[20];break;case 4:si=xi[12],hi=xi[13],ei=xi[14],oi=xi[18],ai=xi[19],ni=xi[20],ri=xi[6],li=xi[7],ci=xi[8],mi=xi[0],pi=xi[1],ui=xi[2];break;case 5:si=xi[3],hi=xi[4],ei=xi[5],oi=xi[9],ai=xi[10],ni=xi[11],ri=xi[21],li=xi[22],ci=xi[23],mi=xi[15],pi=xi[16],ui=xi[17]}bt=q*(si-at)+F*(hi-nt)+j*(ei-rt),bt<=0&&s.addPoint(si,hi,ei,-q,-F,-j,bt,this.flip),bt=q*(oi-at)+F*(ai-nt)+j*(ni-rt),bt<=0&&s.addPoint(oi,ai,ni,-q,-F,-j,bt,this.flip),bt=q*(ri-at)+F*(li-nt)+j*(ci-rt),bt<=0&&s.addPoint(ri,li,ci,-q,-F,-j,bt,this.flip),bt=q*(mi-at)+F*(pi-nt)+j*(ui-rt),bt<=0&&s.addPoint(mi,pi,ui,-q,-F,-j,bt,this.flip)}else{switch(st){case 1:K?(ht=l+M,et=c+V,ot=m+C,q=b,F=A,j=k):(ht=l-M,et=c-V,ot=m-C,q=-b,F=-A,j=-k),Ht=S,Wt=g,Qt=P,ti=d,Gt=I,Kt=w,$t=L,ii=N;break;case 2:$?(ht=l+T,et=c+D,ot=m+B,q=S,F=g,j=P):(ht=l-T,et=c-D,ot=m-B,q=-S,F=-g,j=-P),Ht=b,Wt=A,Qt=k,ti=y,Gt=I,Kt=w,$t=L,ii=N;break;case 3:tt?(ht=l+E,et=c+_,ot=m+Y,q=I,F=w,j=L):(ht=l-E,et=c-_,ot=m-Y,q=-I,F=-w,j=-L),Ht=b,Wt=A,Qt=k,ti=y,Gt=S,Kt=g,$t=P,ii=d}if(At=q*X+F*Z+j*R,kt=At<0?f:-f,at=p+kt*X,nt=u+kt*Z,rt=x+kt*R,G>=.999999?(St=-F,gt=j,Pt=q):(St=q,gt=F,Pt=j),kt=St*X+gt*Z+Pt*R,wt=kt*X-St,Lt=kt*Z-gt,Mt=kt*R-Pt,kt=e.sqrt(wt*wt+Lt*Lt+Mt*Mt),0==kt)return;if(kt=z/kt,wt*=kt,Lt*=kt,Mt*=kt,St=at+wt,gt=nt+Lt,Pt=rt+Mt,At<-.96||At>.96)lt=X*X*1.5-.5,ct=X*Z*1.5-.866025403*R,mt=X*R*1.5+.866025403*Z,pt=Z*X*1.5+.866025403*R,ut=Z*Z*1.5-.5,xt=Z*R*1.5-.866025403*X,yt=R*X*1.5-.866025403*Z,dt=R*Z*1.5+.866025403*X,Nt=R*R*1.5-.5,ft=St,zt=gt,vt=Pt,bt=q*(ft-ht)+F*(zt-et)+j*(vt-ot),St=ft-bt*q-ht,gt=zt-bt*F-et,Pt=vt-bt*j-ot,Zt=Ht*St+Wt*gt+Qt*Pt,Jt=Gt*St+Kt*gt+$t*Pt,Zt<-ti?Zt=-ti:Zt>ti&&(Zt=ti),Jt<-ii?Jt=-ii:Jt>ii&&(Jt=ii),St=Zt*Ht+Jt*Gt,gt=Zt*Wt+Jt*Kt,Pt=Zt*Qt+Jt*$t,ft=ht+St,zt=et+gt,vt=ot+Pt,s.addPoint(ft,zt,vt,q,F,j,bt,this.flip),ft=wt*lt+Lt*ct+Mt*mt,zt=wt*pt+Lt*ut+Mt*xt,vt=wt*yt+Lt*dt+Mt*Nt,ft=(wt=ft)+at,zt=(Lt=zt)+nt,vt=(Mt=vt)+rt,bt=q*(ft-ht)+F*(zt-et)+j*(vt-ot),bt<=0&&(St=ft-bt*q-ht,gt=zt-bt*F-et,Pt=vt-bt*j-ot,Zt=Ht*St+Wt*gt+Qt*Pt,Jt=Gt*St+Kt*gt+$t*Pt,Zt<-ti?Zt=-ti:Zt>ti&&(Zt=ti),Jt<-ii?Jt=-ii:Jt>ii&&(Jt=ii),St=Zt*Ht+Jt*Gt,gt=Zt*Wt+Jt*Kt,Pt=Zt*Qt+Jt*$t,ft=ht+St,zt=et+gt,vt=ot+Pt,s.addPoint(ft,zt,vt,q,F,j,bt,this.flip)),ft=wt*lt+Lt*ct+Mt*mt,zt=wt*pt+Lt*ut+Mt*xt,vt=wt*yt+Lt*dt+Mt*Nt,ft=(wt=ft)+at,zt=(Lt=zt)+nt,vt=(Mt=vt)+rt,bt=q*(ft-ht)+F*(zt-et)+j*(vt-ot),bt<=0&&(St=ft-bt*q-ht,gt=zt-bt*F-et,Pt=vt-bt*j-ot,Zt=Ht*St+Wt*gt+Qt*Pt,Jt=Gt*St+Kt*gt+$t*Pt,Zt<-ti?Zt=-ti:Zt>ti&&(Zt=ti),Jt<-ii?Jt=-ii:Jt>ii&&(Jt=ii),St=Zt*Ht+Jt*Gt,gt=Zt*Wt+Jt*Kt,Pt=Zt*Qt+Jt*$t,ft=ht+St,zt=et+gt,vt=ot+Pt,s.addPoint(ft,zt,vt,q,F,j,bt,this.flip));else{if(_t=St,Yt=gt,Xt=Pt,Zt=q*(_t-ht)+F*(Yt-et)+j*(Xt-ot),_t-=Zt*q,Yt-=Zt*F,Xt-=Zt*j,At>0?(Rt=St+2*U,Ut=gt+2*O,Ot=Pt+2*J):(Rt=St-2*U,Ut=gt-2*O,Ot=Pt-2*J),Jt=q*(Rt-ht)+F*(Ut-et)+j*(Ot-ot),Rt-=Jt*q,Ut-=Jt*F,Ot-=Jt*j,Vt=_t-ht,Ct=Yt-et,Tt=Xt-ot,Dt=Rt-ht,Bt=Ut-et,Et=Ot-ot,St=Rt-_t,gt=Ut-Yt,Pt=Ot-Xt,It=Jt-Zt,H=Vt*Ht+Ct*Wt+Tt*Qt,W=Dt*Ht+Bt*Wt+Et*Qt,qt=H-ti,Ft=W-ti,qt>0){if(Ft>0)return;jt=qt/(qt-Ft),_t+=St*jt,Yt+=gt*jt,Xt+=Pt*jt,Zt+=It*jt,Vt=_t-ht,Ct=Yt-et,Tt=Xt-ot,H=Vt*Ht+Ct*Wt+Tt*Qt,St=Rt-_t,gt=Ut-Yt,Pt=Ot-Xt,It=Jt-Zt}else Ft>0&&(jt=qt/(qt-Ft),Rt=_t+St*jt,Ut=Yt+gt*jt,Ot=Xt+Pt*jt,Jt=Zt+It*jt,Dt=Rt-ht,Bt=Ut-et,Et=Ot-ot,W=Dt*Ht+Bt*Wt+Et*Qt,St=Rt-_t,gt=Ut-Yt,Pt=Ot-Xt,It=Jt-Zt);if(qt=H+ti,Ft=W+ti,qt<0){if(Ft<0)return;jt=qt/(qt-Ft),_t+=St*jt,Yt+=gt*jt,Xt+=Pt*jt,Zt+=It*jt,Vt=_t-ht,Ct=Yt-et,Tt=Xt-ot,St=Rt-_t,gt=Ut-Yt,Pt=Ot-Xt,It=Jt-Zt}else Ft<0&&(jt=qt/(qt-Ft),Rt=_t+St*jt,Ut=Yt+gt*jt,Ot=Xt+Pt*jt,Jt=Zt+It*jt,Dt=Rt-ht,Bt=Ut-et,Et=Ot-ot,St=Rt-_t,gt=Ut-Yt,Pt=Ot-Xt,It=Jt-Zt);if(H=Vt*Gt+Ct*Kt+Tt*$t,W=Dt*Gt+Bt*Kt+Et*$t,qt=H-ii,Ft=W-ii,qt>0){if(Ft>0)return;jt=qt/(qt-Ft),_t+=St*jt,Yt+=gt*jt,Xt+=Pt*jt,Zt+=It*jt,Vt=_t-ht,Ct=Yt-et,Tt=Xt-ot,H=Vt*Gt+Ct*Kt+Tt*$t,St=Rt-_t,gt=Ut-Yt,Pt=Ot-Xt,It=Jt-Zt}else Ft>0&&(jt=qt/(qt-Ft),Rt=_t+St*jt,Ut=Yt+gt*jt,Ot=Xt+Pt*jt,Jt=Zt+It*jt,Dt=Rt-ht,Bt=Ut-et,Et=Ot-ot,W=Dt*Gt+Bt*Kt+Et*$t,St=Rt-_t,gt=Ut-Yt,Pt=Ot-Xt,It=Jt-Zt);if(qt=H+ii,Ft=W+ii,qt<0){if(Ft<0)return;jt=qt/(qt-Ft),_t+=St*jt,Yt+=gt*jt,Xt+=Pt*jt,Zt+=It*jt}else Ft<0&&(jt=qt/(qt-Ft),Rt=_t+St*jt,Ut=Yt+gt*jt,Ot=Xt+Pt*jt,Jt=Zt+It*jt);Zt<0&&s.addPoint(_t,Yt,Xt,q,F,j,Zt,this.flip),Jt<0&&s.addPoint(Rt,Ut,Ot,q,F,j,Jt,this.flip)}}}},e.CylinderCylinderCollisionDetector=function(){e.CollisionDetector.call(this)},e.CylinderCylinderCollisionDetector.prototype=Object.create(e.CollisionDetector.prototype),e.CylinderCylinderCollisionDetector.prototype.constructor=e.CylinderCylinderCollisionDetector,e.CylinderCylinderCollisionDetector.prototype.getSep=function(t,i,s,h,o){var a,n,r,l,c,m,p,u,x,y,d,N,f,z=new e.Vec3,v=t.position.x,b=t.position.y,A=t.position.z,k=i.position.x,S=i.position.y,g=i.position.z,P=k-v,I=S-b,w=g-A;P*P+I*I+w*w==0&&(I=.001);var L=-P,M=-I,V=-w;this.supportPoint(t,-L,-M,-V,z);var C=z.x,T=z.y,D=z.z;this.supportPoint(i,L,M,V,z);var B=z.x,E=z.y,_=z.z,Y=B-C,X=E-T,Z=_-D;if(Y*L+X*M+Z*V<=0)return!1;if(L=X*w-Z*I,M=Z*P-Y*w,V=Y*I-X*P,L*L+M*M+V*V==0)return s.init(Y-P,X-I,Z-w),s.normalize(s),h.init(.5*(C+B),.5*(T+E),.5*(D+_)),!0;this.supportPoint(t,-L,-M,-V,z);var R=z.x,U=z.y,O=z.z;this.supportPoint(i,L,M,V,z);var J=z.x,q=z.y,F=z.z,j=J-R,H=q-U,W=F-O;if(j*L+H*M+W*V<=0)return!1;a=Y-P,n=X-I,r=Z-w,l=j-P,c=H-I,m=W-w,L=n*m-r*c,M=r*l-a*m,V=a*c-n*l,L*P+M*I+V*w>0&&(a=Y,n=X,r=Z,Y=j,X=H,Z=W,j=a,H=n,W=r,a=C,n=T,r=D,C=R,T=U,D=O,R=a,U=n,O=r,a=B,n=E,r=_,B=J,E=q,_=F,J=a,q=n,F=r,L=-L,M=-M,V=-V);for(var Q=0;;){if(++Q>100)return!1;this.supportPoint(t,-L,-M,-V,z);var G=z.x,K=z.y,$=z.z;this.supportPoint(i,L,M,V,z);var tt=z.x,it=z.y,st=z.z,ht=tt-G,et=it-K,ot=st-$;if(ht*L+et*M+ot*V<=0)return!1;if((X*ot-Z*et)*P+(Z*ht-Y*ot)*I+(Y*et-X*ht)*w<0)j=ht,H=et,W=ot,R=G,U=K,O=$,J=tt,q=it,F=st,a=Y-P,n=X-I,r=Z-w,l=ht-P,c=et-I,m=ot-w,L=n*m-r*c,M=r*l-a*m,V=a*c-n*l;else if((et*W-ot*H)*P+(ot*j-ht*W)*I+(ht*H-et*j)*w<0)Y=ht,X=et,Z=ot,C=G,T=K,D=$,B=tt,E=it,_=st,a=ht-P,n=et-I,r=ot-w,l=j-P,c=H-I,m=W-w,L=n*m-r*c,M=r*l-a*m,V=a*c-n*l;else for(var at=!1;;){if(a=j-Y,n=H-X,r=W-Z,l=ht-Y,c=et-X,m=ot-Z,L=n*m-r*c,M=r*l-a*m,V=a*c-n*l,p=1/e.sqrt(L*L+M*M+V*V),L*=p,M*=p,V*=p,L*Y+M*X+V*Z>=0&&!at){var nt=(X*W-Z*H)*ht+(Z*j-Y*W)*et+(Y*H-X*j)*ot,rt=(et*W-ot*H)*P+(ot*j-ht*W)*I+(ht*H-et*j)*w,lt=(I*Z-w*X)*ht+(w*Y-P*Z)*et+(P*X-I*Y)*ot,ct=(H*Z-W*X)*P+(W*Y-j*Z)*I+(j*X-H*Y)*w,mt=nt+rt+lt+ct;mt<=0&&(nt=0,rt=(H*ot-W*et)*L+(W*ht-j*ot)*M+(j*et-H*ht)*V,lt=(et*W-ot*H)*L+(ot*j-ht*W)*M+(ht*H-et*j)*V,ct=(X*W-Z*H)*L+(Z*j-Y*W)*M+(Y*H-X*j)*V,mt=rt+lt+ct);var pt=1/mt;u=(v*nt+C*rt+R*lt+G*ct)*pt,x=(b*nt+T*rt+U*lt+K*ct)*pt,y=(A*nt+D*rt+O*lt+$*ct)*pt,d=(k*nt+B*rt+J*lt+tt*ct)*pt,N=(S*nt+E*rt+q*lt+it*ct)*pt,f=(g*nt+_*rt+F*lt+st*ct)*pt,at=!0}this.supportPoint(t,-L,-M,-V,z);var ut=z.x,xt=z.y,yt=z.z;this.supportPoint(i,L,M,V,z);var dt=z.x,Nt=z.y,ft=z.z,zt=dt-ut,vt=Nt-xt,bt=ft-yt,At=-(zt*L+vt*M+bt*V);if((zt-ht)*L+(vt-et)*M+(bt-ot)*V<=.01||At>=0)return!!at&&(s.init(-L,-M,-V),h.init(.5*(u+d),.5*(x+N),.5*(y+f)),o.x=At,!0);(vt*Z-bt*X)*P+(bt*Y-zt*Z)*I+(zt*X-vt*Y)*w<0?(vt*W-bt*H)*P+(bt*j-zt*W)*I+(zt*H-vt*j)*w<0?(Y=zt,X=vt,Z=bt,C=ut,T=xt,D=yt,B=dt,E=Nt,_=ft):(ht=zt,et=vt,ot=bt,G=ut,K=xt,$=yt,tt=dt,it=Nt,st=ft):(vt*ot-bt*et)*P+(bt*ht-zt*ot)*I+(zt*et-vt*ht)*w<0?(j=zt,H=vt,W=bt,R=ut,U=xt,O=yt,J=dt,q=Nt,F=ft):(Y=zt,X=vt,Z=bt,C=ut,T=xt,D=yt,B=dt,E=Nt,_=ft)}}},e.CylinderCylinderCollisionDetector.prototype.supportPoint=function(t,i,s,h,o){var a,n,r,l=t.rotation.elements,c=l[0]*i+l[3]*s+l[6]*h,m=l[1]*i+l[4]*s+l[7]*h,p=l[2]*i+l[5]*s+l[8]*h,u=c,x=p,y=u*u+x*x,d=t.radius,N=t.halfHeight;0==y?m<0?(a=d,n=-N,r=0):(a=d,n=N,r=0):(y=t.radius/e.sqrt(y),m<0?(a=u*y,n=-N,r=x*y):(a=u*y,n=N,r=x*y)),c=l[0]*a+l[1]*n+l[2]*r+t.position.x,m=l[3]*a+l[4]*n+l[5]*r+t.position.y,p=l[6]*a+l[7]*n+l[8]*r+t.position.z,o.init(c,m,p)},e.CylinderCylinderCollisionDetector.prototype.detectCollision=function(t,i,s){var h,o;t.id<i.id?(h=t,o=i):(h=i,o=t);var a,n,r,l,c,m,p,u,x,y,d,N,f,z,v,b,A,k,S,g,P,I=h.position,w=o.position,L=I.x,M=I.y,V=I.z,C=w.x,T=w.y,D=w.z,B=h.halfHeight,E=o.halfHeight,_=h.normalDirection,Y=o.normalDirection,X=h.halfDirection,Z=o.halfDirection,R=h.radius,U=o.radius,O=_.x,J=_.y,q=_.z,F=Y.x,j=Y.y,H=Y.z,W=X.x,Q=X.y,G=X.z,K=Z.x,$=Z.y,tt=Z.z,it=L-C,st=M-T,ht=V-D,et=new e.Vec3,ot=new e.Vec3,at=new e.Vec3;if(this.getSep(h,o,et,ot,at)){var nt=et.x*O+et.y*J+et.z*q,rt=et.x*F+et.y*j+et.z*H,lt=nt>0,ct=rt>0;lt||(nt=-nt),ct||(rt=-rt);var mt=0;(nt>.999||rt>.999)&&(mt=nt>rt?1:2);var pt,ut,xt,yt,dt,Nt,ft,zt,vt,bt,At,kt,St,gt,Pt,It,wt,Lt,Mt,Vt,Ct=at.x;switch(pt=et.x,ut=et.y,xt=et.z,mt){case 0:s.addPoint(ot.x,ot.y,ot.z,pt,ut,xt,Ct,!1);break;case 1:if(lt?(n=L+W,r=M+Q,l=V+G,pt=O,ut=J,xt=q):(n=L-W,r=M-Q,l=V-G,pt=-O,ut=-J,xt=-q),S=pt*F+ut*j+xt*H,a=S<0?E:-E,c=C+a*F,m=T+a*j,p=D+a*H,rt>=.999999?(u=-ut,x=xt,y=pt):(u=pt,x=ut,y=xt),a=u*F+x*j+y*H,it=a*F-u,st=a*j-x,ht=a*H-y,a=e.sqrt(it*it+st*st+ht*ht),0==a)break;if(a=U/a,it*=a,st*=a,ht*=a,u=c+it,x=m+st,y=p+ht,S<-.96||S>.96)yt=F*F*1.5-.5,dt=F*j*1.5-.866025403*H,Nt=F*H*1.5+.866025403*j,ft=j*F*1.5+.866025403*H,zt=j*j*1.5-.5,vt=j*H*1.5-.866025403*F,bt=H*F*1.5-.866025403*j,At=H*j*1.5+.866025403*F,kt=H*H*1.5-.5,St=u,gt=x,Pt=y,It=pt*(St-n)+ut*(gt-r)+xt*(Pt-l),u=St-It*pt-n,x=gt-It*ut-r,y=Pt-It*xt-l,a=u*u+x*x+y*y,a>R*R&&(a=R/e.sqrt(a),u*=a,x*=a,y*=a),St=n+u,gt=r+x,Pt=l+y,s.addPoint(St,gt,Pt,pt,ut,xt,It,!1),St=it*yt+st*dt+ht*Nt,gt=it*ft+st*zt+ht*vt,Pt=it*bt+st*At+ht*kt,St=(it=St)+c,gt=(st=gt)+m,Pt=(ht=Pt)+p,It=pt*(St-n)+ut*(gt-r)+xt*(Pt-l),It<=0&&(u=St-It*pt-n,x=gt-It*ut-r,y=Pt-It*xt-l,a=u*u+x*x+y*y,a>R*R&&(a=R/e.sqrt(a),u*=a,x*=a,y*=a),St=n+u,gt=r+x,Pt=l+y,s.addPoint(St,gt,Pt,pt,ut,xt,It,!1)),St=it*yt+st*dt+ht*Nt,gt=it*ft+st*zt+ht*vt,Pt=it*bt+st*At+ht*kt,St=(it=St)+c,gt=(st=gt)+m,Pt=(ht=Pt)+p,It=pt*(St-n)+ut*(gt-r)+xt*(Pt-l),It<=0&&(u=St-It*pt-n,x=gt-It*ut-r,y=Pt-It*xt-l,a=u*u+x*x+y*y,a>R*R&&(a=R/e.sqrt(a),u*=a,x*=a,y*=a),St=n+u,gt=r+x,Pt=l+y,s.addPoint(St,gt,Pt,pt,ut,xt,It,!1));else{if(d=u,N=x,f=y,A=pt*(d-n)+ut*(N-r)+xt*(f-l),d-=A*pt,N-=A*ut,f-=A*xt,S>0?(z=u+F*E*2,v=x+j*E*2,b=y+H*E*2):(z=u-F*E*2,v=x-j*E*2,b=y-H*E*2),k=pt*(z-n)+ut*(v-r)+xt*(b-l),z-=k*pt,v-=k*ut,b-=k*xt,it=n-d,st=r-N,ht=l-f,u=z-d,x=v-N,y=b-f,wt=it*it+st*st+ht*ht,Lt=it*u+st*x+ht*y,Mt=u*u+x*x+y*y,Vt=Lt*Lt-Mt*(wt-R*R),Vt<0)break;Vt=e.sqrt(Vt),g=(Lt+Vt)/Mt,P=(Lt-Vt)/Mt,P<g&&(a=g,g=P,P=a),P>1&&(P=1),g<0&&(g=0),u=d+(z-d)*g,x=N+(v-N)*g,y=f+(b-f)*g,z=d+(z-d)*P,v=N+(v-N)*P,b=f+(b-f)*P,d=u,N=x,f=y,a=A+(k-A)*g,k=A+(k-A)*P,A=a,A<0&&s.addPoint(d,N,f,pt,ut,xt,It,!1),k<0&&s.addPoint(z,v,b,pt,ut,xt,It,!1)}break;case 2:if(ct?(c=C-K,m=T-$,p=D-tt,pt=-F,ut=-j,xt=-H):(c=C+K,m=T+$,p=D+tt,pt=F,ut=j,xt=H),S=pt*O+ut*J+xt*q,a=S<0?B:-B,n=L+a*O,r=M+a*J,l=V+a*q,nt>=.999999?(u=-ut,x=xt,y=pt):(u=pt,x=ut,y=xt),a=u*O+x*J+y*q,it=a*O-u,st=a*J-x,ht=a*q-y,a=e.sqrt(it*it+st*st+ht*ht),0==a)break;if(a=R/a,it*=a,st*=a,ht*=a,u=n+it,x=r+st,y=l+ht,S<-.96||S>.96)yt=O*O*1.5-.5,dt=O*J*1.5-.866025403*q,Nt=O*q*1.5+.866025403*J,ft=J*O*1.5+.866025403*q,zt=J*J*1.5-.5,vt=J*q*1.5-.866025403*O,bt=q*O*1.5-.866025403*J,At=q*J*1.5+.866025403*O,kt=q*q*1.5-.5,St=u,gt=x,Pt=y,It=pt*(St-c)+ut*(gt-m)+xt*(Pt-p),u=St-It*pt-c,x=gt-It*ut-m,y=Pt-It*xt-p,a=u*u+x*x+y*y,a>U*U&&(a=U/e.sqrt(a),u*=a,x*=a,y*=a),St=c+u,gt=m+x,Pt=p+y,s.addPoint(St,gt,Pt,-pt,-ut,-xt,It,!1),St=it*yt+st*dt+ht*Nt,gt=it*ft+st*zt+ht*vt,Pt=it*bt+st*At+ht*kt,St=(it=St)+n,gt=(st=gt)+r,Pt=(ht=Pt)+l,It=pt*(St-c)+ut*(gt-m)+xt*(Pt-p),It<=0&&(u=St-It*pt-c,x=gt-It*ut-m,y=Pt-It*xt-p,a=u*u+x*x+y*y,a>U*U&&(a=U/e.sqrt(a),u*=a,x*=a,y*=a),St=c+u,gt=m+x,Pt=p+y,s.addPoint(St,gt,Pt,-pt,-ut,-xt,It,!1)),St=it*yt+st*dt+ht*Nt,gt=it*ft+st*zt+ht*vt,Pt=it*bt+st*At+ht*kt,St=(it=St)+n,gt=(st=gt)+r,Pt=(ht=Pt)+l,It=pt*(St-c)+ut*(gt-m)+xt*(Pt-p),It<=0&&(u=St-It*pt-c,x=gt-It*ut-m,y=Pt-It*xt-p,a=u*u+x*x+y*y,a>U*U&&(a=U/e.sqrt(a),u*=a,x*=a,y*=a),St=c+u,gt=m+x,Pt=p+y,s.addPoint(St,gt,Pt,-pt,-ut,-xt,It,!1));else{if(d=u,N=x,f=y,A=pt*(d-c)+ut*(N-m)+xt*(f-p),d-=A*pt,N-=A*ut,f-=A*xt,S>0?(z=u+O*B*2,v=x+J*B*2,b=y+q*B*2):(z=u-O*B*2,v=x-J*B*2,b=y-q*B*2),k=pt*(z-c)+ut*(v-m)+xt*(b-p),z-=k*pt,v-=k*ut,b-=k*xt,it=c-d,st=m-N,ht=p-f,u=z-d,x=v-N,y=b-f,wt=it*it+st*st+ht*ht,Lt=it*u+st*x+ht*y,Mt=u*u+x*x+y*y,Vt=Lt*Lt-Mt*(wt-U*U),Vt<0)break;Vt=e.sqrt(Vt),g=(Lt+Vt)/Mt,P=(Lt-Vt)/Mt,P<g&&(a=g,g=P,P=a),P>1&&(P=1),g<0&&(g=0),u=d+(z-d)*g,x=N+(v-N)*g,y=f+(b-f)*g,z=d+(z-d)*P,v=N+(v-N)*P,b=f+(b-f)*P,d=u,N=x,f=y,a=A+(k-A)*g,k=A+(k-A)*P,A=a,A<0&&s.addPoint(d,N,f,-pt,-ut,-xt,A,!1),k<0&&s.addPoint(z,v,b,-pt,-ut,-xt,k,!1)}}}},e.SphereCylinderCollisionDetector=function(t){e.CollisionDetector.call(this),this.flip=t},e.SphereCylinderCollisionDetector.prototype=Object.create(e.CollisionDetector.prototype),e.SphereCylinderCollisionDetector.prototype.constructor=e.SphereCylinderCollisionDetector,e.SphereCylinderCollisionDetector.prototype.detectCollision=function(t,i,s){var h,o;this.flip?(h=i,o=t):(h=t,o=i);var a=h.position,n=a.x,r=a.y,l=a.z,c=o.position,m=c.x,p=c.y,u=c.z,x=o.normalDirection.x,y=o.normalDirection.y,d=o.normalDirection.z,N=h.radius,f=o.radius,z=N+f,v=o.halfHeight,b=n-m,A=r-p,k=l-u,S=b*x+A*y+k*d;if(!(S<-v-N||S>v+N)){var g=m+S*x,P=p+S*y,I=u+S*d,w=n-g,L=r-P,M=l-I,V=w*w+L*L+M*M;if(!(V>z*z)){V>f*f&&(V=f/e.sqrt(V),w*=V,L*=V,M*=V),S<-v?S=-v:S>v&&(S=v),g=m+S*x+w,P=p+S*y+L,I=u+S*d+M,b=g-n,A=P-r,k=I-l,V=b*b+A*A+k*k;var C;V>0&&V<N*N&&(V=e.sqrt(V),C=1/V,b*=C,A*=C,k*=C,s.addPoint(n+b*N,r+A*N,l+k*N,b,A,k,V-N,this.flip))}}},e.TetraTetraCollisionDetector=function(){e.CollisionDetector.call(this)},e.TetraTetraCollisionDetector.prototype=Object.create(e.CollisionDetector.prototype),e.TetraTetraCollisionDetector.prototype.constructor=e.TetraTetraCollisionDetector,e.TetraTetraCollisionDetector.prototype.detectCollision=function(t,h,e){var o,a,n,r,l,c,m=t.faces,p=t.verts,u=(h.faces,h.verts),x=0,y=m;for(o=0;o<4;o++)for(n=p[o],a=0;a<4;a++)r=u[y[o].a],l=u[y[o].b],c=u[y[o].c],i(s(n.x,n.y),s(r.x,r.y),s(l.x,l.y),s(c.x,c.y))&&i(s(n.x,n.z),s(r.x,r.z),s(l.x,l.z),s(c.x,c.z))&&i(s(n.z,n.y),s(r.z,r.y),s(l.z,l.y),s(c.z,c.y))&&x++,4===x&&e.addPoint(n)},e.AABB=function(t,i,s,e,o,a){this.elements=new h(6);var n=this.elements;n[0]=t||0,n[1]=s||0,n[2]=o||0,n[3]=i||0,n[4]=e||0,n[5]=a||0},e.AABB.prototype={constructor:e.AABB,set:function(t,i,s,h,e,o){var a=this.elements;return a[0]=t,a[3]=i,a[1]=s,a[4]=h,a[2]=e,a[5]=o,this},intersectTest:function(t){var i=this.elements,s=t.elements;return i[0]>s[3]||i[1]>s[4]||i[2]>s[5]||i[3]<s[0]||i[4]<s[1]||i[5]<s[2]},intersectTestTwo:function(t){var i=this.elements,s=t.elements;return i[0]<s[0]||i[1]<s[1]||i[2]<s[2]||i[3]>s[3]||i[4]>s[4]||i[5]>s[5]},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t,i){var s=i||0,h=t.elements;return this.set(h[0]-s,h[3]+s,h[1]-s,h[4]+s,h[2]-s,h[5]+s),this},fromArray:function(t){return this.elements.set(t),this},combine:function(t,i){var s=t.elements,h=i.elements,e=this.elements;return e[0]=s[0]<h[0]?s[0]:h[0],e[1]=s[1]<h[1]?s[1]:h[1],e[2]=s[2]<h[2]?s[2]:h[2],e[3]=s[3]>h[3]?s[3]:h[3],e[4]=s[4]>h[4]?s[4]:h[4],e[5]=s[5]>h[5]?s[5]:h[5],this},surfaceArea:function(){var t=this.elements,i=t[3]-t[0],s=t[4]-t[1],h=t[5]-t[2];return 2*(i*(s+h)+s*h)},intersectsWithPoint:function(t,i,s){var h=this.elements;return t>=h[0]&&t<=h[3]&&i>=h[1]&&i<=h[4]&&s>=h[2]&&s<=h[5]},setFromPoints:function(t){this.makeEmpty();for(var i=0;i<t.length;i++)this.expandByPoint(t[i])},makeEmpty:function(){this.set(-(1/0),-(1/0),-(1/0),1/0,1/0,1/0)},expandByPoint:function(t){var i=this.elements;this.set(e.min(i[0],t.x),e.min(i[1],t.y),e.min(i[2],t.z),e.max(i[3],t.x),e.max(i[4],t.y),e.max(i[5],t.z))}},e.Proxy=function(t){this.shape=t,this.aabb=t.aabb},e.Proxy.prototype={constructor:e.Proxy,update:function(){e.Error("Proxy","Inheritance error.")}},e.BasicProxy=function(t){e.Proxy.call(this,t),this.id=e.proxyID++},e.BasicProxy.prototype=Object.create(e.Proxy.prototype),e.BasicProxy.prototype.constructor=e.BasicProxy,e.BasicProxy.prototype.update=function(){},e.BroadPhase=function(){this.types=e.BR_NULL,
this.numPairChecks=0,this.numPairs=0,this.pairs=[]},e.BroadPhase.prototype={constructor:e.BroadPhase,createProxy:function(t){e.Error("BroadPhase","Inheritance error.")},addProxy:function(t){e.Error("BroadPhase","Inheritance error.")},removeProxy:function(t){e.Error("BroadPhase","Inheritance error.")},isAvailablePair:function(t,i){var s=t.parent,h=i.parent;if(s==h||!s.isDynamic&&!h.isDynamic||0==(t.belongsTo&i.collidesWith)||0==(i.belongsTo&t.collidesWith))return!1;var e;for(e=s.numJoints<h.numJoints?s.jointLink:h.jointLink;null!==e;){var o=e.joint;if(!o.allowCollision&&(o.body1==s&&o.body2==h||o.body1==h&&o.body2==s))return!1;e=e.next}return!0},detectPairs:function(){this.pairs=[],this.numPairs=0,this.numPairChecks=0,this.collectPairs()},collectPairs:function(){e.Error("BroadPhase","Inheritance error.")},addPair:function(t,i){var s=new e.Pair(t,i);this.pairs.push(s),this.numPairs++}},e.BruteForceBroadPhase=function(){e.BroadPhase.call(this),this.types=e.BR_BRUTE_FORCE,this.proxies=[]},e.BruteForceBroadPhase.prototype=Object.create(e.BroadPhase.prototype),e.BruteForceBroadPhase.prototype.constructor=e.BruteForceBroadPhase,e.BruteForceBroadPhase.prototype.createProxy=function(t){return new e.BasicProxy(t)},e.BruteForceBroadPhase.prototype.addProxy=function(t){this.proxies.push(t)},e.BruteForceBroadPhase.prototype.removeProxy=function(t){var i=this.proxies.indexOf(t);i>-1&&this.proxies.splice(i,1)},e.BruteForceBroadPhase.prototype.collectPairs=function(){var t,i,s,h=0,e=this.proxies,o=e.length;for(this.numPairChecks=o*(o-1)>>1;h<o;)for(i=e[h++],t=h+1;t<o;)s=e[t++],!i.aabb.intersectTest(s.aabb)&&this.isAvailablePair(i.shape,s.shape)&&this.addPair(i.shape,s.shape)},e.Pair=function(t,i){this.shape1=t||null,this.shape2=i||null},e.SAPAxis=function(){this.numElements=0,this.bufferSize=256,this.elements=[],this.elements.length=this.bufferSize,this.stack=new h(64)},e.SAPAxis.prototype={constructor:e.SAPAxis,addElements:function(t,i){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var s=[],h=this.numElements;h--;)s[h]=this.elements[h]}this.elements[this.numElements++]=t,this.elements[this.numElements++]=i},removeElements:function(t,i){for(var s=-1,h=-1,e=0,o=this.numElements;e<o;e++){var a=this.elements[e];if(a==t||a==i){if(s!=-1){h=e;break}s=e}}for(e=s+1,o=h;e<o;e++)this.elements[e-1]=this.elements[e];for(e=h+1,o=this.numElements;e<o;e++)this.elements[e-2]=this.elements[e];this.elements[--this.numElements]=null,this.elements[--this.numElements]=null},sort:function(){for(var t=0,i=1;this.numElements>>i!=0;)i++;i=i*this.numElements>>2,t=0;for(var s=!1,h=this.elements,o=1,a=this.numElements;o<a;o++){var n=h[o],r=n.value,l=h[o-1];if(l.value>r){var c=o;do{if(h[c]=l,0==--c)break;l=h[c-1]}while(l.value>r);if(h[c]=n,t+=o-c,t>i){s=!0;break}}}if(s){t=2;var m=this.stack;for(m[0]=0,m[1]=this.numElements-1;t>0;){var p=m[--t],u=m[--t],x=p-u;if(x>16){var y=u+e.floor(.5*x);for(n=h[y],h[y]=h[p],h[p]=n,r=n.value,o=u-1,c=p;;){var d,N;do d=h[++o];while(d.value<r);do N=h[--c];while(r<N.value&&c!=u);if(o>=c)break;h[o]=N,h[c]=d}h[p]=h[o],h[o]=n,o-u>p-o?(m[t++]=u,m[t++]=o-1,m[t++]=o+1,m[t++]=p):(m[t++]=o+1,m[t++]=p,m[t++]=u,m[t++]=o-1)}else for(o=u+1;o<=p;o++)if(n=h[o],r=n.value,l=h[o-1],l.value>r){c=o;do{if(h[c]=l,0==--c)break;l=h[c-1]}while(l.value>r);h[c]=n}}}},calculateTestCount:function(){for(var t=1,i=0,s=1,h=this.numElements;s<h;s++)this.elements[s].max?t--:(i+=t,t++);return i}},e.SAPBroadPhase=function(){e.BroadPhase.call(this),this.types=e.BR_SWEEP_AND_PRUNE,this.numElementsD=0,this.numElementsS=0,this.axesD=[new e.SAPAxis,new e.SAPAxis,new e.SAPAxis],this.axesS=[new e.SAPAxis,new e.SAPAxis,new e.SAPAxis],this.index1=0,this.index2=1},e.SAPBroadPhase.prototype=Object.create(e.BroadPhase.prototype),e.SAPBroadPhase.prototype.constructor=e.SAPBroadPhase,e.SAPBroadPhase.prototype.createProxy=function(t){return new e.SAPProxy(this,t)},e.SAPBroadPhase.prototype.addProxy=function(t){var i=t;i.isDynamic()?(this.axesD[0].addElements(i.min[0],i.max[0]),this.axesD[1].addElements(i.min[1],i.max[1]),this.axesD[2].addElements(i.min[2],i.max[2]),i.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(i.min[0],i.max[0]),this.axesS[1].addElements(i.min[1],i.max[1]),this.axesS[2].addElements(i.min[2],i.max[2]),i.belongsTo=2,this.numElementsS+=2)},e.SAPBroadPhase.prototype.removeProxy=function(t){var i=t;if(0!=i.belongsTo){switch(i.belongsTo){case 1:this.axesD[0].removeElements(i.min[0],i.max[0]),this.axesD[1].removeElements(i.min[1],i.max[1]),this.axesD[2].removeElements(i.min[2],i.max[2]),this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(i.min[0],i.max[0]),this.axesS[1].removeElements(i.min[1],i.max[1]),this.axesS[2].removeElements(i.min[2],i.max[2]),this.numElementsS-=2}i.belongsTo=0}},e.SAPBroadPhase.prototype.collectPairs=function(){if(0!=this.numElementsD){var t=this.axesD[this.index1],i=this.axesD[this.index2];t.sort(),i.sort();var s,h,e=t.calculateTestCount(),o=i.calculateTestCount();e<=o?(i=this.axesS[this.index1],i.sort(),s=t.elements,h=i.elements):(t=this.axesS[this.index2],t.sort(),s=i.elements,h=t.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var a,n,r=0,l=0;r<this.numElementsD;){var c,m;if(l==this.numElementsS)c=s[r],m=!0,r++;else{var p=s[r],u=h[l];p.value<u.value?(c=p,m=!0,r++):(c=u,m=!1,l++)}if(c.max){var x=c.pair;if(m){if(x==a){a=a.pair;continue}c=a}else{if(x==n){n=n.pair;continue}c=n}do{if(v=c.pair,v==x){c.pair=v.pair;break}c=v}while(null!=c)}else{for(var y=c.proxy.shape,d=c.min1.value,N=c.max1.value,f=c.min2.value,z=c.max2.value,v=a;null!=v;v=v.pair){var b=v.proxy.shape;this.numPairChecks++,d>v.max1.value||N<v.min1.value||f>v.max2.value||z<v.min2.value||!this.isAvailablePair(y,b)||this.addPair(y,b)}if(m){for(v=n;null!=v;v=v.pair)b=v.proxy.shape,this.numPairChecks++,d>v.max1.value||N<v.min1.value||f>v.max2.value||z<v.min2.value||!this.isAvailablePair(y,b)||this.addPair(y,b);c.pair=a,a=c}else c.pair=n,n=c}}this.index2=3^(this.index1|this.index2)}},e.SAPElement=function(t,i){this.proxy=t,this.pair=null,this.min1=null,this.max1=null,this.min2=null,this.max2=null,this.max=i,this.value=0},e.SAPProxy=function(t,i){e.Proxy.call(this,i),this.belongsTo=0,this.max=[],this.min=[],this.sap=t,this.min[0]=new e.SAPElement(this,!1),this.max[0]=new e.SAPElement(this,!0),this.min[1]=new e.SAPElement(this,!1),this.max[1]=new e.SAPElement(this,!0),this.min[2]=new e.SAPElement(this,!1),this.max[2]=new e.SAPElement(this,!0),this.max[0].pair=this.min[0],this.max[1].pair=this.min[1],this.max[2].pair=this.min[2],this.min[0].min1=this.min[1],this.min[0].max1=this.max[1],this.min[0].min2=this.min[2],this.min[0].max2=this.max[2],this.min[1].min1=this.min[0],this.min[1].max1=this.max[0],this.min[1].min2=this.min[2],this.min[1].max2=this.max[2],this.min[2].min1=this.min[0],this.min[2].max1=this.max[0],this.min[2].min2=this.min[1],this.min[2].max2=this.max[1]},e.SAPProxy.prototype=Object.create(e.Proxy.prototype),e.SAPProxy.prototype.constructor=e.SAPProxy,e.SAPProxy.prototype.isDynamic=function(){var t=this.shape.parent;return t.isDynamic&&!t.sleeping},e.SAPProxy.prototype.update=function(){var t=this.aabb.elements;this.min[0].value=t[0],this.min[1].value=t[1],this.min[2].value=t[2],this.max[0].value=t[3],this.max[1].value=t[4],this.max[2].value=t[5],(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())&&(this.sap.removeProxy(this),this.sap.addProxy(this))},e.DBVT=function(){this.root=null,this.freeNodes=[],this.freeNodes.length=16384,this.numFreeNodes=0,this.aabb=new e.AABB},e.DBVT.prototype={constructor:e.DBVT,moveLeaf:function(t){this.deleteLeaf(t),this.insertLeaf(t)},insertLeaf:function(t){if(null==this.root)return void(this.root=t);for(var i,s,h=t.aabb,o=this.root;null==o.proxy;){var a=o.child1,n=o.child2,r=o.aabb,l=a.aabb,c=n.aabb;i=r.surfaceArea(),this.aabb.combine(h,r),s=this.aabb.surfaceArea();var m=2*s,p=2*(s-i),u=p;this.aabb.combine(h,l),u+=null!=a.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-l.surfaceArea();var x=p;if(this.aabb.combine(h,c),x+=null!=n.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-c.surfaceArea(),u<x){if(m<u)break;o=a}else{if(m<x)break;o=n}}var y,d=o.parent;y=this.numFreeNodes>0?this.freeNodes[--this.numFreeNodes]:new e.DBVTNode,y.parent=d,y.child1=t,y.child2=o,y.aabb.combine(t.aabb,o.aabb),y.height=o.height+1,o.parent=y,t.parent=y,o==this.root?this.root=y:d.child1==o?d.child1=y:d.child2=y;do y=this.balance(y),this.fix(y),y=y.parent;while(null!=y)},getBalance:function(t){return null!=t.proxy?0:t.child1.height-t.child2.height},deleteLeaf:function(t){if(t==this.root)return void(this.root=null);var i,s=t.parent;if(i=s.child1==t?s.child2:s.child1,s==this.root)return this.root=i,void(i.parent=null);var h=s.parent;i.parent=h,h.child1==s?h.child1=i:h.child2=i,this.numFreeNodes<16384&&(this.freeNodes[this.numFreeNodes++]=s);do h=this.balance(h),this.fix(h),h=h.parent;while(null!=h)},balance:function(t){var i=t.height;if(i<2)return t;var s,h=t.parent,e=t.child1,o=t.child2,a=e.height,n=o.height,r=a-n;if(r>1){var l=e.child1,c=e.child2,m=l.height,p=c.height;return m>p?(e.child2=t,t.parent=e,t.child1=c,c.parent=t,t.aabb.combine(c.aabb,o.aabb),s=p-n,t.height=p-(s&s>>31)+1,e.aabb.combine(l.aabb,t.aabb),s=m-i,e.height=m-(s&s>>31)+1):(e.child1=t,t.parent=e,t.child1=l,l.parent=t,t.aabb.combine(l.aabb,o.aabb),s=m-n,t.height=m-(s&s>>31)+1,e.aabb.combine(t.aabb,c.aabb),s=i-p,e.height=i-(s&s>>31)+1),null!=h?h.child1==t?h.child1=e:h.child2=e:this.root=e,e.parent=h,e}if(r<-1){var u=o.child1,x=o.child2,y=u.height,d=x.height;return y>d?(o.child2=t,t.parent=o,t.child2=x,x.parent=t,t.aabb.combine(e.aabb,x.aabb),s=a-d,t.height=a-(s&s>>31)+1,o.aabb.combine(u.aabb,t.aabb),s=y-i,o.height=y-(s&s>>31)+1):(o.child1=t,t.parent=o,t.child2=u,u.parent=t,t.aabb.combine(e.aabb,u.aabb),s=a-y,t.height=a-(s&s>>31)+1,o.aabb.combine(t.aabb,x.aabb),s=i-d,o.height=i-(s&s>>31)+1),null!=h?h.child1==t?h.child1=o:h.child2=o:this.root=o,o.parent=h,o}return t},fix:function(t){var i=t.child1,s=t.child2;t.aabb.combine(i.aabb,s.aabb),t.height=i.height<s.height?s.height+1:i.height+1}},e.DBVTBroadPhase=function(){e.BroadPhase.call(this),this.types=e.BR_BOUNDING_VOLUME_TREE,this.tree=new e.DBVT,this.stack=[],this.leaves=[],this.numLeaves=0},e.DBVTBroadPhase.prototype=Object.create(e.BroadPhase.prototype),e.DBVTBroadPhase.prototype.constructor=e.DBVTBroadPhase,e.DBVTBroadPhase.prototype.createProxy=function(t){return new e.DBVTProxy(t)},e.DBVTBroadPhase.prototype.addProxy=function(t){this.tree.insertLeaf(t.leaf),this.leaves.push(t.leaf),this.numLeaves++},e.DBVTBroadPhase.prototype.removeProxy=function(t){this.tree.deleteLeaf(t.leaf);var i=this.leaves.indexOf(t.leaf);i>-1&&(this.leaves.splice(i,1),this.numLeaves--)},e.DBVTBroadPhase.prototype.collectPairs=function(){if(!(this.numLeaves<2))for(var t,i=.1,s=this.numLeaves;s--;)t=this.leaves[s],t.proxy.aabb.intersectTestTwo(t.aabb)&&(t.aabb.copy(t.proxy.aabb,i),this.tree.deleteLeaf(t),this.tree.insertLeaf(t),this.collide(t,this.tree.root))},e.DBVTBroadPhase.prototype.collide=function(t,i){var s,h,e,o,a,n,r=2;for(this.stack[0]=t,this.stack[1]=i;r>0;)if(e=this.stack[--r],o=this.stack[--r],a=null!=e.proxy,n=null!=o.proxy,this.numPairChecks++,a&&n){if(s=e.proxy.shape,h=o.proxy.shape,s==h||s.aabb.intersectTest(h.aabb)||!this.isAvailablePair(s,h))continue;this.addPair(s,h)}else{if(e.aabb.intersectTest(o.aabb))continue;n||!a&&e.aabb.surfaceArea()>o.aabb.surfaceArea()?(this.stack[r++]=e.child1,this.stack[r++]=o,this.stack[r++]=e.child2,this.stack[r++]=o):(this.stack[r++]=e,this.stack[r++]=o.child1,this.stack[r++]=e,this.stack[r++]=o.child2)}},e.DBVTNode=function(){this.child1=null,this.child2=null,this.parent=null,this.proxy=null,this.height=0,this.aabb=new e.AABB},e.DBVTProxy=function(t){e.Proxy.call(this,t),this.leaf=new e.DBVTNode,this.leaf.proxy=this},e.DBVTProxy.prototype=Object.create(e.Proxy.prototype),e.DBVTProxy.prototype.constructor=e.DBVTProxy,e.DBVTProxy.prototype.update=function(){},e.World.prototype.add=function(t){t=t||{};var i=t.type||"box";if("string"==typeof i&&(i=[i]),"joint"==i[0].substring(0,5)){"joint"===i[0]&&(i[0]="jointHinge");var s=t.axe1||[1,0,0],h=t.axe2||[1,0,0],o=t.pos1||[0,0,0],a=t.pos2||[0,0,0];o=o.map(function(t){return t*e.INV_SCALE}),a=a.map(function(t){return t*e.INV_SCALE});var n,r;"jointDistance"===i[0]?(n=t.min||0,r=t.max||10,n*=e.INV_SCALE,r*=e.INV_SCALE):(n=t.min||57.29578,r=t.max||0,n*=e.degtorad,r*=e.degtorad);var l=t.limit||null,c=t.spring||null,m=t.motor||null,p=new e.JointConfig;p.allowCollision=t.collision||!1,p.localAxis1.init(s[0],s[1],s[2]),p.localAxis2.init(h[0],h[1],h[2]),p.localAnchorPoint1.init(o[0],o[1],o[2]),p.localAnchorPoint2.init(a[0],a[1],a[2]),("string"==typeof t.body1||t.body1 instanceof String)&&(t.body1=this.getByName(t.body1)),("string"==typeof t.body2||t.body2 instanceof String)&&(t.body2=this.getByName(t.body2)),p.body1=t.body1,p.body2=t.body2;var u;switch(i[0]){case"jointDistance":u=new e.DistanceJoint(p,n,r),null!==c&&u.limitMotor.setSpring(c[0],c[1]),null!==m&&u.limitMotor.setSpring(m[0],m[1]);break;case"jointHinge":u=new e.HingeJoint(p,n,r),null!==c&&u.limitMotor.setSpring(c[0],c[1]),null!==m&&u.limitMotor.setSpring(m[0],m[1]);break;case"jointPrisme":u=new e.PrismaticJoint(p,n,r);break;case"jointSlide":u=new e.SliderJoint(p,n,r);break;case"jointBall":u=new e.BallAndSocketJoint(p);break;case"jointWheel":u=new e.WheelJoint(p),null!==l&&u.rotationalLimitMotor1.setLimit(l[0],l[1]),null!==c&&u.rotationalLimitMotor1.setSpring(c[0],c[1]),null!==m&&u.rotationalLimitMotor1.setSpring(m[0],m[1])}return u.name=t.name||"",this.addJoint(u),u}var x=t.move||!1,y=t.noSleep||!1,d=t.pos||[0,0,0];d=d.map(function(t){return t*e.INV_SCALE});var N=t.size||[1,1,1];N=N.map(function(t){return t*e.INV_SCALE});var f=t.rot||[0,0,0];f=f.map(function(t){return t*e.degtorad});for(var z=[],v=0;v<f.length/3;v++){var b=e.EulerToAxis(f[v+0],f[v+1],f[v+2]);z.push(b[0]),z.push(b[1]),z.push(b[2]),z.push(b[3])}var A=new e.ShapeConfig;void 0!==t.sc&&(A=t.sc),t.config&&(A.density=void 0===t.config[0]?1:t.config[0],A.friction=void 0===t.config[1]?.4:t.config[1],A.restitution=void 0===t.config[2]?.2:t.config[2],A.belongsTo=t.config[3]||1,A.collidesWith=t.config[4]||4294967295),void 0!==t.density&&(A.density=t.density),void 0!==t.friction&&(A.friction=t.friction),void 0!==t.restitution&&(A.restitution=t.restitution),void 0!==t.belongsTo&&(A.belongsTo=t.belongsTo),void 0!==t.collidesWith&&(A.collidesWith=t.collidesWith),t.massPos&&(t.massPos=t.massPos.map(function(t){return t*e.INV_SCALE}),A.relativePosition.init(t.massPos[0],t.massPos[1],t.massPos[2])),t.massRot&&(t.massRot=t.massRot.map(function(t){return t*e.degtorad}),A.relativeRotation=e.EulerToMatrix(t.massRot[0],t.massRot[1],t.massRot[2]));for(var k,S,g=new e.RigidBody(d[0],d[1],d[2],z[0],z[1],z[2],z[3]),P=[],v=0;v<i.length;v++){switch(k=3*v,S=4*v,i[v]){case"sphere":P[v]=new e.SphereShape(A,N[k]);break;case"cylinder":P[v]=new e.CylinderShape(A,N[k],N[k+1]);break;case"box":P[v]=new e.BoxShape(A,N[k],N[k+1],N[k+2])}g.addShape(P[v]),v>0&&(P[v].relativePosition=new e.Vec3(d[k],d[k+1],d[k+2]),z[S+0]&&(P[v].relativeRotation=[z[S],z[S+1],z[S+2],z[S+3]]))}return x?(t.massPos||t.massRot?g.setupMass(1,!1):g.setupMass(1,!0),y?g.allowSleep=!1:g.allowSleep=!0):g.setupMass(2),g.name=t.name||" ",this.addRigidBody(g),g},e});