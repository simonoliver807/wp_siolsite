define(["ddUtil/createDragDropElement","jquery"],function(e,t){function a(t){var a=document.getElementById(t).value;a=JSON.parse(a);for(var l,i=0;i<a.length;i++){l=a[i].mapID;var o="e_"+l,n="container_"+l,p="label_"+l,s=a[i].isNew,c=a[i].labelReplacedBy;if(a[i].x!==-1&&a[i].y!==-1&&a[i].e_x!==-1&&a[i].e_y!==-1){var v=a[i].x,f=a[i].y;$("#dragDropList").append('<div id="'+n+'" class="e_container"></div>'),s?($("#dragDropList").append('<div id="'+n+'" class="e_container"></div>'),$("#dropWrapper").append('<div id="'+o+'" class="dragDropLabelRed">'+a[i].labelName+"</div>")):($("#dragDropList").append('<div id="'+n+'" class="e_container"></div>'),$("#dropWrapper").append('<div id="'+o+'" class="dragDropLabelBlack">'+a[i].labelName+"</div>")),$("#"+o).css({left:v,top:f,position:"absolute"})}else s?$("#dragDropList").append('<div id="'+n+'" class="e_container"><div id="'+o+'" class="dragDropLabelRed">'+a[i].labelName+"</div></div>"):$("#dragDropList").append('<div id="'+n+'" class="e_container"><div id="'+o+'" class="dragDropLabelBlack"><div>'+a[i].labelName+'</div><div class="labelReplacedBy">'+c+"</div></div>");d[i]=new e,d[i].init(o,a[i],p,n,s,c,d);var g=$(".dragDropLabel").width(),m=$(".dragDropLabel").height();if(a[i].x!==-1&&a[i].y!==-1&&a[i].e_x!==-1&&a[i].e_y!==-1){var b="<div>"+a[i].labelName+'</div><div class="labelReplacedBy">'+c+"</div>";r(d[i],l,b,a[i].x,a[i].y,a[i].e_x,a[i].e_y,g,m)}d[i].setDragEl=d}var u=(document.getElementById("dropWrapper"),document.getElementsByClassName("dragDropLabel"),document.getElementById("resetItem"));document.addEventListener("click",function(e){$(".rightClickMenu").css("display","none");for(var t=0;t<d.length;t++)d[t].setReset&&(d[t].setReset=!1)},!1),u.addEventListener("click",function(e){for(var t=0;t<d.length;t++)d[t].setReset&&d[t].resetLabel()},!1)}function r(t,a,r,i,o,n,p,s,c){t.setDroppedBool(!0);var v=($("#dropWrapper").offset(),"label_"+a);t.isNew?($("#e_"+a).removeClass("dragDropLabelRed").addClass("dragDropDotRed").text(""),$("#dropWrapper").append('<div id="'+v+'" class="dragDropLabelRed">'+r+"</div>")):($("#e_"+a).removeClass("dragDropLabelBlack").addClass("dragDropDotBlack").text(""),$("#dropWrapper").append('<div id="'+v+'" class="dragDropLabelBlack">'+r+"</div>"));var f=new e;f.init("","",v,""),$("#"+v).css({left:n,top:p,position:"absolute"}),document.getElementById(v).addEventListener("contextmenu",function(e){e.preventDefault(),$(".rightClickMenu").css({display:"block",left:e.clientX,top:e.clientY});var t=this.id.split("_");t=t[1],t="e_"+t;for(var a=0;a<d.length;a++)d[a].e_id==t?d[a].setReset=!0:d[a].setReset=!1},!1),l(a,t.isNew,!1),$("#label_"+a).draggable("option","containment","#dropWrapper"),$("#e_"+a).draggable("option","containment","#dropWrapper"),f.setDragEl(d)}function l(e,t,a){if(!a)if(t)var r="lineStyleRed";else var r="lineStyleBlack";var l=1,d=$("#e_"+e).position(),i=$("#label_"+e).position(),o=d.left,n=d.top,p=i.left,s=i.top,c=Math.sqrt((p-o)*(p-o)+(s-n)*(s-n)),v=(o+p)/2-c/2,f=(n+s)/2-l/2,g=Math.atan2(n-s,o-p)*(180/Math.PI);if(a)$("#lineDiv"+e).css({left:v+"px",top:f+"px",width:c+"px",transform:"rotate("+g+"deg)"});else{var m='<div id="lineDiv'+e+'" class="'+r+'" style="left:'+v+"px; top:"+f+"px; width:"+c+"px; -moz-transform:rotate("+g+"deg); -webkit-transform:rotate("+g+"deg); -o-transform:rotate("+g+"deg); -ms-transform:rotate("+g+"deg); transform:rotate("+g+'deg);" />';$("#dropWrapper").append(m)}}var d=[];a("jsonInput"),$("#dropWrapper").droppable({tolerance:"fit",drop:function(e,t){var a=$("#dropWrapper"),l=$(t.draggable).width(),i=$(t.draggable).height(),o=a.offset(),n=$(t.draggable).html(),p=$(t.draggable).attr("id"),s=p.split("_");s=s[1];for(var c="e_"+s,v=document.getElementById("label_"+s),f=0;f<d.length;f++)if(d[f].e_id==c)var g=d[f];if("dropWrapper"!=$("#"+c).parent().attr("id")&&($("#"+c).remove(),$("#dropWrapper").append('<div id="'+c+'"></div>'),$("#"+c).css({left:e.clientX-o.left,top:e.clientY-o.top}),g.makeDraggable(d)),e.clientX>a.width()+o.left-l)var m=!0;if(e.clientY<o.top+i)var b=!0;if(e.clientY>a.height()+o.top-80)var u=!0;if(m&&b)var D=e.clientX-o.left-45,y=e.clientY-o.top+40;else if(m&&!b)var D=e.clientX-o.left-45,y=e.clientY-o.top+40;else if(!m&&b)var D=e.clientX-o.left+20,y=e.clientY-o.top+40;else var D=e.clientX-o.left+20,y=e.clientY-o.top+40;if(u)var y=e.clientY-o.top-80;v||r(g,s,n,"","",D,y,l,i);var _=$("#"+c).offset(),h=$("#label_"+s).offset(),L=$("#dropWrapper").offset(),x={x:_.left-L.left,y:_.top-L.top},B={x:h.left-L.left,y:h.top-L.top};g.setPositions(x,B);for(var f=0;f<d.length;f++)(d[f].elXYpos.x>-1||d[f].elXYpos.y>-1)&&(document.getElementById("el"+f).innerHTML=Math.round(d[f].elXYpos.x)+"x , "+Math.round(d[f].elXYpos.y)+"y")}}),document.getElementById("submitJson").addEventListener("click",function(){console.log("json sent")})});