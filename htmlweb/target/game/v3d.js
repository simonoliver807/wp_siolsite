define(["game/three"],function(e){"use strict";var e,t={};return t.ToRad=Math.PI/180,t.ToDeg=180/Math.PI,t.msePos={x:0,y:0},t.View=function(t,i,s){var r=navigator.userAgent;this.isMobile=!1,(r.match(/Android/i)||r.match(/webOS/i)||r.match(/iPhone/i)||r.match(/iPad/i)||r.match(/iPod/i)||r.match(/BlackBerry/i)||r.match(/Windows Phone/i))&&(this.isMobile=!0);var a=document.getElementById("container");a.style.width="100%",a.style.height="500px",this.w=a.clientWidth,this.h=a.clientHeight,this.id="container",this.init(t,i,s),this.initBasic(),this.sight,this.startRot={issleeping:1,rot:0,camAngle:.05,axis:new e.Vector3}},t.View.prototype={constructor:t.View,init:function(t,i,s){this.clock=new e.Clock,this.renderer=new e.WebGLRenderer({precision:"mediump",antialias:!1}),this.renderer.setSize(this.w,this.h),this.renderer.setClearColor(1908512,1),this.camera=new e.PerspectiveCamera(60,this.w/this.h,.1,1e4),this.camera.useQuarternion=!0,this.camera.position.z=100,this.camera.position.y=0,this.scene=new e.Scene,this.scene.background=new e.Color(0),this.container=document.getElementById(this.id),this.container.appendChild(this.renderer.domElement),this.miniMap=null,this.player=null,this.raycaster=new e.Raycaster,this.camAngle=.01,this.tmpVCPprev1=new e.Vector3(0,0,100),this.tmpVCPprev=new e.Vector3(0,0,100),this.tmppbprev=new e.Vector3(0,0,-100),this.containerMesh,this.proBox,this.camrot=new e.Vector3,this.pbrot=new e.Vector3},initBackground:function(){var i=new e.BufferGeometry;i.fromGeometry(new e.IcosahedronGeometry(1e3,1));var s=new e.Mesh(i,new e.MeshBasicMaterial({map:this.gradTexture([[.75,.6,.4,.25],["#1B1D1E","#3D4143","#72797D","#b0babf"]]),side:e.BackSide,depthWrite:!1,fog:!1}));s.geometry.applyMatrix((new e.Matrix4).makeRotationZ(15*t.ToRad)),this.scene.add(s),this.renderer.autoClear=!1},initLight:function(){if(!this.isMobile){var t=new e.HemisphereLight(16777215,3158064,.3);this.scene.add(t);var i=new e.DirectionalLight(16777215,1.2);i.position.set(.5,1,.5).normalize(),this.scene.add(i)}},initLightShadow:function(){if(!this.isMobile){this.scene.add(new e.AmbientLight(6316128));var t=new e.DirectionalLight(16777215,1);t.position.set(300,1e3,500),t.target.position.set(0,0,0),t.castShadow=!0,t.shadowCameraNear=500,t.shadowCameraFar=1600,t.shadowCameraFov=70,t.shadowBias=1e-4,t.shadowDarkness=.7,t.shadowMapWidth=t.shadowMapHeight=1024,this.scene.add(t)}},initBasic:function(){var i={};i.sph=new e.BufferGeometry,i.box=new e.BufferGeometry,i.cyl=new e.BufferGeometry,i.sph.fromGeometry(new e.SphereGeometry(1,12,10)),i.cyl.fromGeometry(new e.CylinderGeometry(.5,.5,1,12,1)),i.box.fromGeometry(new e.BoxGeometry(1,1,1)),i.plane=new e.PlaneBufferGeometry(1,1,100,100),i.plane.applyMatrix((new e.Matrix4).makeRotationX(-90*t.ToRad));var s={};s.ssph=new e.MeshLambertMaterial({map:this.basicTexture(1),name:"ssph"}),s.box=new e.MeshLambertMaterial({color:6750003,wireframe:!0,name:"box"}),s.transbox=new e.MeshLambertMaterial({color:255,wireframe:!0,name:"transbox",transparent:!0,opacity:0}),s.sbox=new e.MeshLambertMaterial({map:this.basicTexture(3),name:"sbox"}),s.cyl=new e.MeshLambertMaterial({map:this.basicTexture(5),name:"cyl"}),s.scyl=new e.MeshLambertMaterial({map:this.basicTexture(6),name:"scyl"}),s.static=new e.MeshLambertMaterial({map:this.basicTexture(4),name:"static"}),s.static2=new e.MeshLambertMaterial({color:16711680,wireframe:!0,name:"static2"}),s.joint=new e.LineBasicMaterial({color:65280}),this.mats=s,this.geos=i},render:function(){this.startRot.rot&&this.applyRot(),this.raycaster.setFromCamera(t.msePos,this.camera);for(var e=this.raycaster.intersectObjects(this.scene.children),i=0;i<e.length;i++)"proBox"==e[i].object.name&&this.sight.position.copy(e[i].point);this.renderer.render(this.scene,this.camera)},setMesh:function(t){var i={};return i.sph=new e.MeshLambertMaterial({color:t,wireframe:!0,name:"sph"})},add:function(i,s,r,a){var o=i.type||"box",n=i.size||[10,10,10],h=i.pos||[0,0,0],c=i.rot||[0,0,0],p=i.move||!1,m=i.name||"";if(i.flat&&(o="plane",h[1]+=.5*n[1]),"joint"===o.substring(0,5)){var l,d=i.pos1||[0,0,0],w=i.pos2||[0,0,0],y=new e.Geometry;return y.vertices.push(new e.Vector3(d[0],d[1],d[2])),y.vertices.push(new e.Vector3(w[0],w[1],w[2])),l=new e.Line(y,this.mats.joint,e.LinePieces),s?s.add(g):this.scene.add(l),l}var g;return r&&(this.mats.sph=this.setMesh(r)),"box"==o&&p&&(g=new e.Mesh(this.geos.box,this.mats.box,m)),"box"!=o||p||(g=new e.Mesh(this.geos.box,this.mats.static,m)),"transbox"==o&&p&&(g=new e.Mesh(this.geos.box,this.mats.transbox,m)),"plane"!=o||p||(g=new e.Mesh(this.geos.plane,this.mats.static2,m)),"sphere"==o&&p&&(g=new e.Mesh(this.geos.sph,this.mats.sph,m)),"sphere"!=o||p||(g=new e.Mesh(this.geos.sph,this.mats.static,m)),"cylinder"==o&&p&&(g=new e.Mesh(this.geos.cyl,this.mats.cyl,m)),"cylinder"!=o||p||(g=new e.Mesh(this.geos.cyl,this.mats.static,m)),g.scale.set(n[0],n[1],n[2]),g.position.set(h[0],h[1],h[2]),g.rotation.set(c[0]*t.ToRad,c[1]*t.ToRad,c[2]*t.ToRad),s?s.add(g):this.scene.add(g),"sight"==g.name&&(this.sight=g),"containerSphere"==g.name&&(this.containerMesh=g),"proBox"==g.name&&(this.proBox=g),g},moveLink:function(e,t,i){e.geometry.vertices[0].copy(t),e.geometry.vertices[1].copy(i),e.geometry.verticesNeedUpdate=!0},initKeyboard:function(){this.nav.bindKeys()},customShader:function(t){var i=new e.ShaderMaterial({uniforms:t.uniforms,attributes:t.attributes,vertexShader:t.vs,fragmentShader:t.fs});return i},gradTexture:function(t){var i=document.createElement("canvas"),s=i.getContext("2d");i.width=16,i.height=128;for(var r=s.createLinearGradient(0,0,0,128),a=t[0].length;a--;)r.addColorStop(t[0][a],t[1][a]);s.fillStyle=r,s.fillRect(0,0,16,128);var o=new e.Texture(i);return o.needsUpdate=!0,o},basicTexture:function(t,i){var s=document.createElement("canvas");s.width=s.height=64;var r,a=s.getContext("2d");0===t&&(r="#58C3FF"),1===t&&(r="#3580AA"),2===t&&(r="#FFAA58"),3===t&&(r="#AA8038"),4===t&&(r="#1d1f20"),5===t&&(r="#58FFAA"),6===t&&(r="#38AA80"),a.fillStyle=r,a.fillRect(0,0,64,64),a.fillStyle="rgba(0,0,0,0.1);",a.fillRect(0,0,32,32),a.fillRect(32,32,32,32);var o=new e.Texture(s);return o.wrapS=o.wrapT=e.RepeatWrapping,o.repeat=new e.Vector2(i||1,i||1),o.needsUpdate=!0,o},gs_mse_pos:function(e,t){return"get"==e?this.sight.position:(this.sight.position.x=t.x,this.sight.position.y=t.y,this.sight.position.z=t.z,void 0)},getPlayerDir:function(t,i){var s=new e.Vector3;if("forward"==t){var r=this.gs_mse_pos("get");s=s.subVectors(this.gs_mse_pos("get"),i)}else{var r=this.gs_mse_pos("get");this.log("reverse sight pos ",r),s=s.subVectors(i,this.gs_mse_pos("get"))}return s.normalize()},applyRot:function(t){var i=new e.Vector3;i.copy(this.tmpVCPprev),i.applyAxisAngle(this.startRot.axis,this.startRot.camAngle),i.x-=this.tmpVCPprev.x,i.y-=this.tmpVCPprev.y,i.z-=this.tmpVCPprev.z,this.tmpVCPprev.x+=i.x,this.tmpVCPprev.y+=i.y,this.tmpVCPprev.z+=i.z,this.startRot.issleeping?(this.camera.position.x+=i.x,this.camera.position.y+=i.y,this.camera.position.z+=i.z,this.camera.lookAt(this.containerMesh.position)):(this.camrot.x=i.x,this.camrot.y=i.y,this.camrot.z=i.z);var i=new e.Vector3;i.copy(this.tmppbprev),i.applyAxisAngle(this.startRot.axis,this.startRot.camAngle),i.x-=this.tmppbprev.x,i.y-=this.tmppbprev.y,i.z-=this.tmppbprev.z,this.tmppbprev.x+=i.x,this.tmppbprev.y+=i.y,this.tmppbprev.z+=i.z,this.startRot.issleeping?(this.proBox.position.x+=i.x,this.proBox.position.y+=i.y,this.proBox.position.z+=i.z,this.proBox.lookAt(this.containerMesh.position)):(this.pbrot.x=i.x,this.pbrot.y=i.y,this.pbrot.z=i.z)},whcam:function(){var e=this.camera.fov*Math.PI/180,t=2*Math.tan(e/2)*300,i=this.w/this.h,s=t*i;return{h:t,w:s}},log:function(e,t){}},t});