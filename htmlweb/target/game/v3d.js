define(["game/three"],function(e){var e,t={};return t.ToRad=Math.PI/180,t.ToDeg=180/Math.PI,t.View=function(e,t,i){var a=navigator.userAgent;this.isMobile=!1,(a.match(/Android/i)||a.match(/webOS/i)||a.match(/iPhone/i)||a.match(/iPad/i)||a.match(/iPod/i)||a.match(/BlackBerry/i)||a.match(/Windows Phone/i))&&(this.isMobile=!0);var r=document.getElementById("container");r.style.width="100%",r.style.height="500px",this.w=r.clientWidth,this.h=r.clientHeight,this.id="container",this.init(e,t,i),this.initBasic()},t.View.prototype={constructor:t.View,init:function(t,i,a){this.clock=new e.Clock,this.renderer=new e.WebGLRenderer({precision:"mediump",antialias:!1}),this.renderer.setSize(this.w,this.h),this.renderer.setClearColor(1908512,1),this.camera=new e.PerspectiveCamera(60,this.w/this.h,.1,1e4),this.camera.useQuarternion=!0,this.camera.position.z=100,this.camera.position.y=1,this.scene=new e.Scene,this.scene.background=new e.Color(0),this.container=document.getElementById(this.id),this.container.appendChild(this.renderer.domElement),this.miniMap=null,this.player=null,this.raycaster=new e.Raycaster(this.camera.position,[0,1,0],1,100)},initBackground:function(){var i=new e.BufferGeometry;i.fromGeometry(new e.IcosahedronGeometry(1e3,1));var a=new e.Mesh(i,new e.MeshBasicMaterial({map:this.gradTexture([[.75,.6,.4,.25],["#1B1D1E","#3D4143","#72797D","#b0babf"]]),side:e.BackSide,depthWrite:!1,fog:!1}));a.geometry.applyMatrix((new e.Matrix4).makeRotationZ(15*t.ToRad)),this.scene.add(a),this.renderer.autoClear=!1},initLight:function(){if(!this.isMobile){var t=new e.HemisphereLight(16777215,3158064,.3);this.scene.add(t);var i=new e.DirectionalLight(16777215,1.2);i.position.set(.5,1,.5).normalize(),this.scene.add(i)}},initLightShadow:function(){if(!this.isMobile){this.scene.add(new e.AmbientLight(6316128));var t=new e.DirectionalLight(16777215,1);t.position.set(300,1e3,500),t.target.position.set(0,0,0),t.castShadow=!0,t.shadowCameraNear=500,t.shadowCameraFar=1600,t.shadowCameraFov=70,t.shadowBias=1e-4,t.shadowDarkness=.7,t.shadowMapWidth=t.shadowMapHeight=1024,this.scene.add(t)}},initBasic:function(){var i={};i.sph=new e.BufferGeometry,i.box=new e.BufferGeometry,i.cyl=new e.BufferGeometry,i.sph.fromGeometry(new e.SphereGeometry(1,12,10)),i.cyl.fromGeometry(new e.CylinderGeometry(.5,.5,1,12,1)),i.box.fromGeometry(new e.BoxGeometry(1,1,1)),i.plane=new e.PlaneBufferGeometry(1,1,100,100),i.plane.applyMatrix((new e.Matrix4).makeRotationX(-90*t.ToRad));var a={};a.ssph=new e.MeshLambertMaterial({map:this.basicTexture(1),name:"ssph"}),a.box=new e.MeshLambertMaterial({color:6750003,wireframe:!0,name:"box"}),a.sbox=new e.MeshLambertMaterial({map:this.basicTexture(3),name:"sbox"}),a.cyl=new e.MeshLambertMaterial({map:this.basicTexture(5),name:"cyl"}),a.scyl=new e.MeshLambertMaterial({map:this.basicTexture(6),name:"scyl"}),a.static=new e.MeshLambertMaterial({map:this.basicTexture(4),name:"static"}),a.static2=new e.MeshLambertMaterial({color:16711680,wireframe:!0,name:"static2"}),a.joint=new e.LineBasicMaterial({color:65280}),this.mats=a,this.geos=i},render:function(){this.renderer.render(this.scene,this.camera)},setMesh:function(t){var i={};return i.sph=new e.MeshLambertMaterial({color:t,wireframe:!0,name:"sph"})},add:function(i,a,r,s){var n=i.type||"box",o=i.size||[10,10,10],h=i.pos||[0,0,0],c=i.rot||[0,0,0],m=i.move||!1,d=i.name||"";if(i.flat&&(n="plane",h[1]+=.5*o[1]),"joint"===n.substring(0,5)){var l,w=i.pos1||[0,0,0],p=i.pos2||[0,0,0],u=new e.Geometry;return u.vertices.push(new e.Vector3(w[0],w[1],w[2])),u.vertices.push(new e.Vector3(p[0],p[1],p[2])),l=new e.Line(u,this.mats.joint,e.LinePieces),a?a.add(f):this.scene.add(l),l}var f;if(r&&(this.mats.sph=this.setMesh(r)),s){var y="/images/"+s,b=(new e.TextureLoader).load(y);this.mats.sph=new e.MeshBasicMaterial({map:b})}return"box"==n&&m&&(f=new e.Mesh(this.geos.box,this.mats.box,d)),"box"!=n||m||(f=new e.Mesh(this.geos.box,this.mats.static,d)),"plane"!=n||m||(f=new e.Mesh(this.geos.plane,this.mats.static2,d)),"sphere"==n&&m&&(f=new e.Mesh(this.geos.sph,this.mats.sph,d)),"sphere"!=n||m||(f=new e.Mesh(this.geos.sph,this.mats.static,d)),"cylinder"==n&&m&&(f=new e.Mesh(this.geos.cyl,this.mats.cyl,d)),"cylinder"!=n||m||(f=new e.Mesh(this.geos.cyl,this.mats.static,d)),f.scale.set(o[0],o[1],o[2]),f.position.set(h[0],h[1],h[2]),f.rotation.set(c[0]*t.ToRad,c[1]*t.ToRad,c[2]*t.ToRad),a?a.add(f):this.scene.add(f),f},moveLink:function(e,t,i){e.geometry.vertices[0].copy(t),e.geometry.vertices[1].copy(i),e.geometry.verticesNeedUpdate=!0},initKeyboard:function(){this.nav.bindKeys()},customShader:function(t){var i=new e.ShaderMaterial({uniforms:t.uniforms,attributes:t.attributes,vertexShader:t.vs,fragmentShader:t.fs});return i},gradTexture:function(t){var i=document.createElement("canvas"),a=i.getContext("2d");i.width=16,i.height=128;for(var r=a.createLinearGradient(0,0,0,128),s=t[0].length;s--;)r.addColorStop(t[0][s],t[1][s]);a.fillStyle=r,a.fillRect(0,0,16,128);var n=new e.Texture(i);return n.needsUpdate=!0,n},basicTexture:function(t,i){var a=document.createElement("canvas");a.width=a.height=64;var r,s=a.getContext("2d");0===t&&(r="#58C3FF"),1===t&&(r="#3580AA"),2===t&&(r="#FFAA58"),3===t&&(r="#AA8038"),4===t&&(r="#1d1f20"),5===t&&(r="#58FFAA"),6===t&&(r="#38AA80"),s.fillStyle=r,s.fillRect(0,0,64,64),s.fillStyle="rgba(0,0,0,0.1);",s.fillRect(0,0,32,32),s.fillRect(32,32,32,32);var n=new e.Texture(a);return n.wrapS=n.wrapT=e.RepeatWrapping,n.repeat=new e.Vector2(i||1,i||1),n.needsUpdate=!0,n},getPlayerDir:function(t,i,a){var r=i.position,s=a.position,n=new e.Vector3;return n="forward"==t?n.subVectors(s,r):n.subVectors(r,s),n.normalize()},getVec3:function(t,i,a){var r=new e.Vector3(t,i,a);return r}},t});