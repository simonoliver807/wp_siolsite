define(["three"],function(e){var e,t={};return t.ToRad=Math.PI/180,t.ToDeg=180/Math.PI,t.View=function(e,t,i){var a=navigator.userAgent;this.isMobile=!1,(a.match(/Android/i)||a.match(/webOS/i)||a.match(/iPhone/i)||a.match(/iPad/i)||a.match(/iPod/i)||a.match(/BlackBerry/i)||a.match(/Windows Phone/i))&&(this.isMobile=!0);var s=document.getElementById("container");s.style.width="100%",s.style.height="500px",this.w=s.clientWidth,this.h=s.clientHeight,this.id="container",this.init(e,t,i),this.initBasic()},t.View.prototype={constructor:t.View,init:function(t,i,a){this.clock=new e.Clock,this.renderer=new e.WebGLRenderer({precision:"mediump",antialias:!1}),this.renderer.setSize(this.w,this.h),this.renderer.setClearColor(1908512,1),this.camera=new e.PerspectiveCamera(60,this.w/this.h,.1,1e4),this.camera.position.z=100,this.scene=new e.Scene,this.scene.background=new e.Color(0),this.container=document.getElementById(this.id),this.container.appendChild(this.renderer.domElement),this.miniMap=null,this.player=null,this.raycaster=new e.Raycaster(this.camera.position,[0,1,0],1,100)},initBackground:function(){var i=new e.BufferGeometry;i.fromGeometry(new e.IcosahedronGeometry(1e3,1));var a=new e.Mesh(i,new e.MeshBasicMaterial({map:this.gradTexture([[.75,.6,.4,.25],["#1B1D1E","#3D4143","#72797D","#b0babf"]]),side:e.BackSide,depthWrite:!1,fog:!1}));a.geometry.applyMatrix((new e.Matrix4).makeRotationZ(15*t.ToRad)),this.scene.add(a),this.renderer.autoClear=!1},initLight:function(){if(!this.isMobile){var t=new e.HemisphereLight(16777215,3158064,.3);this.scene.add(t);var i=new e.DirectionalLight(16777215,1.2);i.position.set(.5,1,.5).normalize(),this.scene.add(i)}},initLightShadow:function(){if(!this.isMobile){this.scene.add(new e.AmbientLight(6316128));var t=new e.DirectionalLight(16777215,1);t.position.set(300,1e3,500),t.target.position.set(0,0,0),t.castShadow=!0,t.shadowCameraNear=500,t.shadowCameraFar=1600,t.shadowCameraFov=70,t.shadowBias=1e-4,t.shadowDarkness=.7,t.shadowMapWidth=t.shadowMapHeight=1024,this.scene.add(t)}},initBasic:function(){var i={};i.sph=new e.BufferGeometry,i.box=new e.BufferGeometry,i.cyl=new e.BufferGeometry,i.sph.fromGeometry(new e.SphereGeometry(1,12,10)),i.cyl.fromGeometry(new e.CylinderGeometry(.5,.5,1,12,1)),i.box.fromGeometry(new e.BoxGeometry(1,1,1)),i.plane=new e.PlaneBufferGeometry(1,1,100,100),i.plane.applyMatrix((new e.Matrix4).makeRotationX(-90*t.ToRad));var a={};a.ssph=new e.MeshLambertMaterial({map:this.basicTexture(1),name:"ssph"}),a.box=new e.MeshLambertMaterial({color:6750003,wireframe:!0,name:"box"}),a.sbox=new e.MeshLambertMaterial({map:this.basicTexture(3),name:"sbox"}),a.cyl=new e.MeshLambertMaterial({map:this.basicTexture(5),name:"cyl"}),a.scyl=new e.MeshLambertMaterial({map:this.basicTexture(6),name:"scyl"}),a.static=new e.MeshLambertMaterial({map:this.basicTexture(4),name:"static"}),a.static2=new e.MeshLambertMaterial({color:16711680,wireframe:!0,name:"static2"}),a.joint=new e.LineBasicMaterial({color:65280}),this.mats=a,this.geos=i},render:function(){this.renderer.render(this.scene,this.camera)},setMesh:function(t){var i={};return i.sph=new e.MeshLambertMaterial({color:t,wireframe:!0,name:"sph"})},add:function(i,a,s){var r=i.type||"box",n=i.size||[10,10,10],o=i.pos||[0,0,0],h=i.rot||[0,0,0],c=i.move||!1,m=i.name||"";if(i.flat&&(r="plane",o[1]+=.5*n[1]),"joint"===r.substring(0,5)){var d,l=i.pos1||[0,0,0],w=i.pos2||[0,0,0],p=new e.Geometry;return p.vertices.push(new e.Vector3(l[0],l[1],l[2])),p.vertices.push(new e.Vector3(w[0],w[1],w[2])),d=new e.Line(p,this.mats.joint,e.LinePieces),a?a.add(u):this.scene.add(d),d}var u;return s&&(this.mats.sph=this.setMesh(s)),"box"==r&&c&&(u=new e.Mesh(this.geos.box,this.mats.box,m)),"box"!=r||c||(u=new e.Mesh(this.geos.box,this.mats.static,m)),"plane"!=r||c||(u=new e.Mesh(this.geos.plane,this.mats.static2,m)),"sphere"==r&&c&&(u=new e.Mesh(this.geos.sph,this.mats.sph,m)),"sphere"!=r||c||(u=new e.Mesh(this.geos.sph,this.mats.static,m)),"cylinder"==r&&c&&(u=new e.Mesh(this.geos.cyl,this.mats.cyl,m)),"cylinder"!=r||c||(u=new e.Mesh(this.geos.cyl,this.mats.static,m)),u.scale.set(n[0],n[1],n[2]),u.position.set(o[0],o[1],o[2]),u.rotation.set(h[0]*t.ToRad,h[1]*t.ToRad,h[2]*t.ToRad),a?a.add(u):this.scene.add(u),u},moveLink:function(e,t,i){e.geometry.vertices[0].copy(t),e.geometry.vertices[1].copy(i),e.geometry.verticesNeedUpdate=!0},initKeyboard:function(){this.nav.bindKeys()},customShader:function(t){var i=new e.ShaderMaterial({uniforms:t.uniforms,attributes:t.attributes,vertexShader:t.vs,fragmentShader:t.fs});return i},gradTexture:function(t){var i=document.createElement("canvas"),a=i.getContext("2d");i.width=16,i.height=128;for(var s=a.createLinearGradient(0,0,0,128),r=t[0].length;r--;)s.addColorStop(t[0][r],t[1][r]);a.fillStyle=s,a.fillRect(0,0,16,128);var n=new e.Texture(i);return n.needsUpdate=!0,n},basicTexture:function(t,i){var a=document.createElement("canvas");a.width=a.height=64;var s,r=a.getContext("2d");0===t&&(s="#58C3FF"),1===t&&(s="#3580AA"),2===t&&(s="#FFAA58"),3===t&&(s="#AA8038"),4===t&&(s="#1d1f20"),5===t&&(s="#58FFAA"),6===t&&(s="#38AA80"),r.fillStyle=s,r.fillRect(0,0,64,64),r.fillStyle="rgba(0,0,0,0.1);",r.fillRect(0,0,32,32),r.fillRect(32,32,32,32);var n=new e.Texture(a);return n.wrapS=n.wrapT=e.RepeatWrapping,n.repeat=new e.Vector2(i||1,i||1),n.needsUpdate=!0,n},getPlayerDir:function(t,i,a){var s=i.position,r=a.position,n=new e.Vector3;return n="forward"==t?n.subVectors(r,s):n.subVectors(s,r),n.normalize()}},t});